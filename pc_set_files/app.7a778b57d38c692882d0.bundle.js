!function(e){function t(t){for(var s,r,o=t[0],l=t[1],c=t[2],h=0,p=[];h<o.length;h++)r=o[h],Object.prototype.hasOwnProperty.call(n,r)&&n[r]&&p.push(n[r][0]),n[r]=0;for(s in l)Object.prototype.hasOwnProperty.call(l,s)&&(e[s]=l[s]);for(d&&d(t);p.length;)p.shift()();return i.push.apply(i,c||[]),a()}function a(){for(var e,t=0;t<i.length;t++){for(var a=i[t],s=!0,o=1;o<a.length;o++){var l=a[o];0!==n[l]&&(s=!1)}s&&(i.splice(t--,1),e=r(r.s=a[0]))}return e}var s={},n={4:0},i=[];function r(t){if(s[t])return s[t].exports;var a=s[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=s,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(a,s,function(t){return e[t]}.bind(null,s));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/";var o=window.webpackJsonp=window.webpackJsonp||[],l=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var d=l;i.push(["./src/client/js/app.jsx",2,0,1]),a()}({"./config sync recursive ^\\.\\/env\\..*$":function(e,t,a){var s={"./env.dev":"./config/env.dev.js","./env.dev.js":"./config/env.dev.js","./env.prod":"./config/env.prod.js","./env.prod.js":"./config/env.prod.js"};function n(e){var t=i(e);return a(t)}function i(e){if(!a.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}n.keys=function(){return Object.keys(s)},n.resolve=i,e.exports=n,n.id="./config sync recursive ^\\.\\/env\\..*$"},"./config/env.dev.js":function(e,t){e.exports={NODE_ENV:"development",FILE_UPLOAD:"mongodb",ELASTICSEARCH_URI:"http://localhost:9200/growi",HACKMD_URI:"http://localhost:3010",PLUGIN_NAMES_TOBE_LOADED:[]}},"./config/env.prod.js":function(e,t){e.exports={NODE_ENV:"production"}},"./config/index.js":function(e,t,a){e.exports={env:a("./config sync recursive ^\\.\\/env\\..*$")("./env.prod"),logger:a("./config/logger sync recursive ^\\.\\/config\\..*$")("./config.prod")}},"./config/logger sync recursive ^\\.\\/config\\..*$":function(e,t,a){var s={"./config.dev":"./config/logger/config.dev.js","./config.dev.js":"./config/logger/config.dev.js","./config.prod":"./config/logger/config.prod.js","./config.prod.js":"./config/logger/config.prod.js"};function n(e){var t=i(e);return a(t)}function i(e){if(!a.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}n.keys=function(){return Object.keys(s)},n.resolve=i,e.exports=n,n.id="./config/logger sync recursive ^\\.\\/config\\..*$"},"./config/logger/config.dev.js":function(e,t){e.exports={default:"info","growi:crowi":"debug","growi:crowi:express-init":"debug","growi:models:external-account":"debug","growi:routes:login-passport":"debug","growi:middleware:safe-redirect":"debug","growi:service:PassportService":"debug","growi:lib:search":"debug","growi-plugin:*":"debug","growi:app":"debug","growi:services:*":"debug"}},"./config/logger/config.prod.js":function(e,t){e.exports={default:"info","growi:routes:login-passport":"debug","growi:service:PassportService":"debug"}},"./src/client/js/app.jsx":function(e,t,a){"use strict";a.r(t),function(e){var t=a("./node_modules/react/index.js"),s=a.n(t),n=a("./node_modules/react-dom/index.js"),i=a.n(n),r=a("./node_modules/unstated/lib/unstated.es.js"),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./src/lib/service/logger/index.js"),c=a.n(l),d=a("./src/client/js/components/SearchPage.jsx"),h=a("./src/client/js/components/TagsList.jsx"),p=a("./src/client/js/components/PageEditor.jsx"),m=a("./src/client/js/components/PageEditor/OptionsSelector.jsx"),u=a("./src/client/js/components/SavePageControls.jsx"),g=a("./src/client/js/components/PageEditorByHackmd.jsx"),f=a("./src/client/js/components/Page.jsx"),b=a("./src/client/js/components/PageHistory.jsx"),E=a("./src/client/js/components/PageComments.jsx"),C=a("./src/client/js/components/PageTimeline.jsx"),v=a("./src/client/js/components/PageComment/CommentEditorLazyRenderer.jsx"),w=a("./src/client/js/components/PageAttachment.jsx"),y=a("./src/client/js/components/PageStatusAlert.jsx"),k=a("./src/client/js/components/Page/RevisionPath.jsx"),x=a("./src/client/js/components/Page/TagLabels.jsx"),j=a("./src/client/js/components/BookmarkButton.jsx"),S=a("./src/client/js/components/LikeButton.jsx"),L=a("./src/client/js/components/PagePathAutoComplete.jsx"),M=a("./src/client/js/components/RecentCreated/RecentCreated.jsx"),T=a("./src/client/js/components/MyDraftList/MyDraftList.jsx"),R=a("./src/client/js/components/User/UserPictureList.jsx"),P=a("./src/client/js/components/TableOfContents.jsx"),D=a("./src/client/js/services/PageContainer.js"),H=a("./src/client/js/services/CommentContainer.js"),N=a("./src/client/js/services/EditorContainer.js"),O=a("./src/client/js/services/TagContainer.js"),I=a("./src/client/js/bootstrap.jsx");const _=c()("growi:app"),{i18n:B}=I.a,U=I.a.getContainer("WebsocketContainer"),A=new D.a(I.a),F=new H.a(I.a),z=new N.a(I.a,m.b,m.c),q=new O.a(I.a),G=[I.a,U,A,F,z,q];_.info("unstated containers have been initialized"),Object.assign(I.b,{"search-page":s.a.createElement(d.a,{crowi:I.a}),"tags-page":s.a.createElement(h.a,{crowi:I.a}),"create-page-name-input":s.a.createElement(L.a,{crowi:I.a,initializedPath:A.state.path,addTrailingSlash:!0}),"page-editor":s.a.createElement(p.a,null),"page-editor-options-selector":s.a.createElement(m.a,{crowi:I.a}),"page-status-alert":s.a.createElement(y.a,null),"save-page-controls":s.a.createElement(u.a,null),"user-created-list":s.a.createElement(M.a,null),"user-draft-list":s.a.createElement(T.a,null)}),null!=A.state.pageId&&Object.assign(I.b,{"page-editor-with-hackmd":s.a.createElement(g.a,null),"page-comments-list":s.a.createElement(E.a,null),"page-attachment":s.a.createElement(w.a,null),"page-timeline":s.a.createElement(C.a,null),"page-comment-write":s.a.createElement(v.a,null),"revision-toc":s.a.createElement(P.a,null),"like-button":s.a.createElement(S.a,{pageId:A.state.pageId,isLiked:A.state.isLiked}),"seen-user-list":s.a.createElement(R.a,{userIds:A.state.seenUserIds}),"liker-list":s.a.createElement(R.a,{userIds:A.state.likerUserIds}),"bookmark-button":s.a.createElement(j.a,{pageId:A.state.pageId,crowi:I.a}),"bookmark-button-lg":s.a.createElement(j.a,{pageId:A.state.pageId,crowi:I.a,size:"lg"}),"rename-page-name-input":s.a.createElement(L.a,{crowi:I.a,initializedPath:A.state.path}),"duplicate-page-name-input":s.a.createElement(L.a,{crowi:I.a,initializedPath:A.state.path})}),null!=A.state.path&&Object.assign(I.b,{page:s.a.createElement(f.a,null),"revision-path":s.a.createElement(k.a,{behaviorType:I.a.config.behaviorType,pageId:A.state.pageId,pagePath:A.state.path}),"tag-label":s.a.createElement(x.a,null)}),Object.keys(I.b).forEach(e=>{const t=document.getElementById(e);t&&i.a.render(s.a.createElement(o.a,{i18n:B},s.a.createElement(r.b,{inject:G},I.b[e])),t)}),e('a[data-toggle="tab"][href="#revision-history"]').on("show.bs.tab",()=>{i.a.render(s.a.createElement(o.a,{i18n:B},s.a.createElement(b.a,{pageId:A.state.pageId,crowi:I.a})),document.getElementById("revision-history"))})}.call(this,a("jquery"))},"./src/client/js/components/BookmarkButton.jsx":function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i);class o extends n.a.Component{constructor(e){super(e),this.state={bookmarked:!1},this.handleClick=this.handleClick.bind(this)}componentDidMount(){this.isUserLoggedIn()&&this.props.crowi.apiGet("/bookmarks.get",{page_id:this.props.pageId}).then(e=>{e.bookmark&&this.markBookmarked()})}handleClick(e){e.preventDefault();const t=this.props.pageId;this.state.bookmarked?this.props.crowi.apiPost("/bookmarks.remove",{page_id:t}).then(e=>{this.markUnBookmarked()}):this.props.crowi.apiPost("/bookmarks.add",{page_id:t}).then(e=>{this.markBookmarked()})}markBookmarked(){this.setState({bookmarked:!0})}markUnBookmarked(){this.setState({bookmarked:!1})}isUserLoggedIn(){return null!=this.props.crowi.currentUserId}render(){if(!this.isUserLoggedIn())return n.a.createElement("div",null);const e=this.props.size?`btn-${this.props.size}`:"btn-md",t=[this.state.bookmarked?"active":"",e].join(" ");return n.a.createElement("button",{type:"button",href:"#",title:"Bookmark",onClick:this.handleClick,className:`btn-bookmark btn btn-default btn-circle btn-outline ${t}`},n.a.createElement("i",{className:"icon-star"}))}}o.propTypes={pageId:r.a.string,crowi:r.a.object.isRequired,size:r.a.string}},"./src/client/js/components/LikeButton.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/client/js/components/UnstatedUtils.jsx"),l=a("./src/client/js/services/AppContainer.js");class c extends n.a.Component{constructor(e){super(e),this.state={isLiked:!!e.isLiked},this.handleClick=this.handleClick.bind(this)}handleClick(e){e.preventDefault();const{appContainer:t}=this.props,a=this.props.pageId;this.state.isLiked?t.apiPost("/likes.remove",{page_id:a}).then(e=>{this.setState({isLiked:!1})}):t.apiPost("/likes.add",{page_id:a}).then(e=>{this.setState({isLiked:!0})})}isUserLoggedIn(){return null!=this.props.appContainer.currentUserId}render(){if(!this.isUserLoggedIn())return n.a.createElement("div",null);const e=this.props.size?`btn-${this.props.size}`:"btn-md",t=[this.state.isLiked?"active":"",e].join(" ");return n.a.createElement("button",{type:"button",href:"#",title:"Like",onClick:this.handleClick,className:`btn-like btn btn-default btn-circle btn-outline ${t}`},n.a.createElement("i",{className:"icon-like"}))}}c.propTypes={appContainer:r.a.instanceOf(l.a).isRequired,pageId:r.a.string,isLiked:r.a.bool,size:r.a.string},t.a=e=>Object(o.a)(c,e,[l.a])},"./src/client/js/components/MyDraftList/MyDraftList.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./src/client/js/components/UnstatedUtils.jsx"),c=a("./src/client/js/services/AppContainer.js"),d=a("./src/client/js/services/PageContainer.js"),h=a("./src/client/js/services/EditorContainer.js"),p=a("./src/client/js/components/PaginationWrapper.jsx"),m=a("./node_modules/react-copy-to-clipboard/lib/index.js"),u=a("./node_modules/react-bootstrap/es/Panel.js"),g=a("./node_modules/react-bootstrap/es/Tooltip.js"),f=a("./node_modules/react-bootstrap/es/OverlayTrigger.js"),b=a("./src/client/js/components/Page/RevisionBody.jsx");class E extends n.a.Component{constructor(e){super(e),this.state={html:"",isRendered:!1,isPanelExpanded:!1,showCopiedMessage:!1},this.growiRenderer=this.props.appContainer.getRenderer("draft"),this.changeToolTipLabel=this.changeToolTipLabel.bind(this),this.expandPanelHandler=this.expandPanelHandler.bind(this),this.collapsePanelHandler=this.collapsePanelHandler.bind(this),this.renderHtml=this.renderHtml.bind(this),this.renderAccordionTitle=this.renderAccordionTitle.bind(this)}changeToolTipLabel(){this.setState({showCopiedMessage:!0}),setTimeout(()=>{this.setState({showCopiedMessage:!1})},1e3)}expandPanelHandler(){this.setState({isPanelExpanded:!0}),this.state.isRendered||this.renderHtml()}collapsePanelHandler(){this.setState({isPanelExpanded:!1})}async renderHtml(){const e={markdown:this.props.markdown},t=this.growiRenderer,a=this.props.appContainer.interceptorManager;await a.process("prePreProcess",e).then(()=>{e.markdown=t.preProcess(e.markdown)}).then(()=>a.process("postPreProcess",e)).then(()=>{const a=t.process(e.markdown);e.parsedHTML=a}).then(()=>a.process("prePostProcess",e)).then(()=>{e.parsedHTML=t.postProcess(e.parsedHTML)}).then(()=>a.process("postPostProcess",e)).then(()=>{this.setState({html:e.parsedHTML,isRendered:!0})})}renderAccordionTitle(e){const t=this.state.isPanelExpanded?"caret-opened":"";return n.a.createElement(s.Fragment,null,n.a.createElement("i",{className:`caret ${t}`}),n.a.createElement("span",{className:"mx-2"},this.props.path),e&&n.a.createElement("span",null,"(",this.props.t("page exists"),")"),!e&&n.a.createElement("span",{className:"label-draft label label-default"},"draft"))}render(){const{t:e}=this.props,t=n.a.createElement(g.a,{id:"draft-copied-tooltip"},this.state.showCopiedMessage&&n.a.createElement("strong",null,"copied!"),!this.state.showCopiedMessage&&n.a.createElement("span",null,this.props.t("Copy")));return n.a.createElement("div",{className:"draft-list-item"},n.a.createElement(u.a,null,n.a.createElement(u.a.Heading,{className:"d-flex"},n.a.createElement(u.a.Toggle,null,this.renderAccordionTitle(this.props.isExist)),n.a.createElement("a",{href:this.props.path},n.a.createElement("i",{className:"icon icon-login"})),n.a.createElement("div",{className:"flex-grow-1"}),n.a.createElement("div",{className:"icon-container"},this.props.isExist?null:n.a.createElement("a",{href:`${this.props.path}#edit`,target:"_blank",rel:"noopener noreferrer","data-toggle":"tooltip",title:this.props.t("Edit")},n.a.createElement("i",{className:"mx-2 icon-note"})),n.a.createElement(f.a,{overlay:t,placement:"top"},n.a.createElement(m.CopyToClipboard,{text:this.props.markdown,onCopy:this.changeToolTipLabel},n.a.createElement("a",{className:"text-center draft-copy"},n.a.createElement("i",{className:"mx-2 ti-clipboard"})))),n.a.createElement("a",{className:"text-danger text-center","data-toggle":"tooltip","data-placement":"top",title:e("Delete"),onClick:()=>this.props.clearDraft(this.props.path)},n.a.createElement("i",{className:"mx-2 icon-trash"})))),n.a.createElement(u.a.Collapse,{onEnter:this.expandPanelHandler,onExit:this.collapsePanelHandler},n.a.createElement(u.a.Body,null,this.state.isPanelExpanded&&!this.state.isRendered&&n.a.createElement("div",{className:"text-center"},n.a.createElement("i",{className:"fa fa-lg fa-spinner fa-pulse mx-auto text-muted"})),this.state.isPanelExpanded&&this.state.isRendered&&n.a.createElement(b.a,{html:this.state.html})))))}}E.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(c.a).isRequired,path:r.a.string.isRequired,markdown:r.a.string.isRequired,isExist:r.a.bool.isRequired,clearDraft:r.a.func.isRequired};var C=Object(o.c)()(e=>Object(l.a)(E,e,[c.a]));class v extends n.a.Component{constructor(e){super(e),this.state={drafts:[],currentDrafts:[],activePage:1,totalDrafts:0,pagingLimit:1/0},this.handlePage=this.handlePage.bind(this),this.getDraftsFromLocalStorage=this.getDraftsFromLocalStorage.bind(this),this.getCurrentDrafts=this.getCurrentDrafts.bind(this),this.clearDraft=this.clearDraft.bind(this),this.clearAllDrafts=this.clearAllDrafts.bind(this)}async componentWillMount(){await this.getDraftsFromLocalStorage(),this.getCurrentDrafts(1)}async handlePage(e){await this.getDraftsFromLocalStorage(),await this.getCurrentDrafts(e)}async getDraftsFromLocalStorage(){const e=this.props.editorContainer.drafts,t=await this.props.appContainer.apiGet("/pages.exist",{pages:e}),a=Object.entries(e).map(e=>{const a=e[0];return{path:a,markdown:e[1],isExist:t.pages[a]}});this.setState({drafts:a,totalDrafts:a.length})}getCurrentDrafts(e){const{appContainer:t}=this.props,a=t.getConfig().recentCreatedLimit,s=this.state.drafts.length,n=e,i=this.state.drafts.slice((n-1)*a,n*a);this.setState({currentDrafts:i,activePage:n,totalDrafts:s,pagingLimit:a})}generateDraftList(e){return e.map(e=>n.a.createElement(C,{key:e.path,path:e.path,markdown:e.markdown,isExist:e.isExist,clearDraft:this.clearDraft}))}clearDraft(e){this.props.editorContainer.clearDraft(e),this.setState(t=>({drafts:t.drafts.filter(t=>t.path!==e),currentDrafts:t.drafts.filter(t=>t.path!==e)}))}clearAllDrafts(){this.props.editorContainer.clearAllDrafts(),this.setState({drafts:[],currentDrafts:[],activePage:1,totalDrafts:0,pagingLimit:1/0})}render(){const{t:e}=this.props,t=this.generateDraftList(this.state.currentDrafts),a=this.state.totalDrafts;return n.a.createElement("div",{className:"page-list-container-create"},0===a&&n.a.createElement("span",null,"No drafts yet."),a>0&&n.a.createElement(n.a.Fragment,null,n.a.createElement("div",{className:"d-flex justify-content-between"},n.a.createElement("h4",null,"Total: ",a," drafts"),n.a.createElement("div",{className:"align-self-center"},n.a.createElement("button",{type:"button",className:"btn btn-sm btn-default",onClick:this.clearAllDrafts},n.a.createElement("i",{className:"icon-fw icon-fire text-danger"}),e("Delete All")))),n.a.createElement("div",{className:"tab-pane m-t-30 accordion",id:"draft-list"},t),n.a.createElement(p.a,{activePage:this.state.activePage,changePage:this.handlePage,totalItemsCount:this.state.totalDrafts,pagingLimit:this.state.pagingLimit})))}}v.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(c.a).isRequired,pageContainer:r.a.instanceOf(d.a).isRequired,editorContainer:r.a.instanceOf(h.a).isRequired};t.a=Object(o.c)()(e=>Object(l.a)(v,e,[c.a,d.a,h.a]))},"./src/client/js/components/Page.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/lib/service/logger/index.js"),l=a.n(o),c=a("./src/client/js/components/UnstatedUtils.jsx"),d=a("./src/client/js/services/AppContainer.js"),h=a("./src/client/js/services/PageContainer.js"),p=a("./src/client/js/services/EditorContainer.js"),m=a("./src/client/js/models/MarkdownTable.js"),u=a("./src/client/js/components/Page/RevisionRenderer.jsx"),g=a("./src/client/js/components/PageEditor/HandsontableModal.jsx"),f=a("./src/client/js/components/PageEditor/DrawioModal.jsx"),b=a("./src/client/js/components/PageEditor/MarkdownTableUtil.js"),E=a("./src/client/js/components/PageEditor/MarkdownDrawioUtil.js");const C=l()("growi:Page");class v extends n.a.Component{constructor(e){super(e),this.state={currentTargetTableArea:null,currentTargetDrawioArea:null},this.growiRenderer=this.props.appContainer.getRenderer("page"),this.saveHandlerForHandsontableModal=this.saveHandlerForHandsontableModal.bind(this),this.saveHandlerForDrawioModal=this.saveHandlerForDrawioModal.bind(this)}componentWillMount(){this.props.appContainer.registerComponentInstance("Page",this)}launchHandsontableModal(e,t){const a=this.props.pageContainer.state.markdown.split(/\r\n|\r|\n/).slice(e-1,t).join("\n");this.setState({currentTargetTableArea:{beginLineNumber:e,endLineNumber:t}}),this.handsontableModal.show(m.a.fromMarkdownString(a))}launchDrawioModal(e,t){const a=this.props.pageContainer.state.markdown.split(/\r\n|\r|\n/).slice(e,t),s=a.slice(1,a.length-1).join("\n").trim();this.setState({currentTargetDrawioArea:{beginLineNumber:e,endLineNumber:t}}),this.drawioModal.show(s)}async saveHandlerForHandsontableModal(e){const{pageContainer:t,editorContainer:a}=this.props,s=a.getCurrentOptionsToSave(),n=b.a.replaceMarkdownTableInMarkdown(e,this.props.pageContainer.state.markdown,this.state.currentTargetTableArea.beginLineNumber,this.state.currentTargetTableArea.endLineNumber);try{a.disableUnsavedWarning();const{page:e,tags:i}=await t.save(n,s);C.debug("success to save"),t.showSuccessToastr()}catch(e){C.error("failed to save",e),t.showErrorToastr(e)}finally{this.setState({currentTargetTableArea:null})}}async saveHandlerForDrawioModal(e){const{pageContainer:t,editorContainer:a}=this.props,s=a.getCurrentOptionsToSave(),n=E.a.replaceDrawioInMarkdown(e,this.props.pageContainer.state.markdown,this.state.currentTargetDrawioArea.beginLineNumber,this.state.currentTargetDrawioArea.endLineNumber);try{a.disableUnsavedWarning();const{page:e,tags:i}=await t.save(n,s);C.debug("success to save"),t.showSuccessToastr()}catch(e){C.error("failed to save",e),t.showErrorToastr(e)}finally{this.setState({currentTargetDrawioArea:null})}}render(){const e=this.props.appContainer.isMobile,{markdown:t}=this.props.pageContainer.state;return n.a.createElement("div",{className:e?"page-mobile":""},n.a.createElement(u.a,{growiRenderer:this.growiRenderer,markdown:t}),n.a.createElement(g.a,{ref:e=>{this.handsontableModal=e},onSave:this.saveHandlerForHandsontableModal}),n.a.createElement(f.a,{ref:e=>{this.drawioModal=e},onSave:this.saveHandlerForDrawioModal}))}}v.propTypes={appContainer:r.a.instanceOf(d.a).isRequired,pageContainer:r.a.instanceOf(h.a).isRequired,editorContainer:r.a.instanceOf(p.a).isRequired},t.a=e=>Object(c.a)(v,e,[d.a,h.a,p.a])},"./src/client/js/components/Page/CopyDropdown.jsx":function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return d}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-bootstrap/es/Dropdown.js"),l=a("./node_modules/react-bootstrap/es/MenuItem.js"),c=a("./node_modules/react-copy-to-clipboard/lib/index.js");class d extends n.a.Component{constructor(e){super(e),this.xss=window.xss,this.generatePageUrl=this.generatePageUrl.bind(this)}showToolTip(){e("#copyPagePathDropdown").tooltip("show"),setTimeout(()=>{e("#copyPagePathDropdown").tooltip("hide")},1e3)}generatePageUrl(){return null==this.props.pageId?decodeURIComponent(window.location.pathname+window.location.search):`${window.location.origin}/${this.props.pageId}`}generateMarkdownLink(){}render(){const{t:e}=this.props,t=this.xss.process(this.props.pagePath),a=this.generatePageUrl();return n.a.createElement(o.a,{id:"copyPagePathDropdown"},n.a.createElement(o.a.Toggle,{className:"btn-copy",style:this.props.buttonStyle,"data-toggle":"tooltip","data-placement":"bottom","data-trigger":"manual",title:"copied!"},n.a.createElement("i",{className:"ti-clipboard"})),n.a.createElement(o.a.Menu,null,n.a.createElement("h5",{className:"ml-3 my-0 text-muted"},e("copy_to_clipboard.Copy to clipboard")),n.a.createElement(l.a,{divider:!0}),n.a.createElement(c.CopyToClipboard,{text:this.props.pagePath,onCopy:this.showToolTip},n.a.createElement(l.a,null,n.a.createElement("div",{className:"d-inline-flex flex-column"},n.a.createElement("h6",{className:"mt-1 mb-2"},n.a.createElement("strong",null,e("copy_to_clipboard.Page path"))),n.a.createElement("span",{className:"small"},t)))),this.props.pageId&&n.a.createElement(c.CopyToClipboard,{text:a,onCopy:this.showToolTip},n.a.createElement(l.a,null,n.a.createElement("div",{className:"d-inline-flex flex-column"},n.a.createElement("h6",{className:"mt-1 mb-2"},n.a.createElement("strong",null,e("copy_to_clipboard.Parmanent link"))),n.a.createElement("span",{className:"small"},a)))),this.props.pageId&&n.a.createElement(c.CopyToClipboard,{text:`${this.props.pagePath}\n${a}`,onCopy:this.showToolTip},n.a.createElement(l.a,null,n.a.createElement("div",{className:"d-inline-flex flex-column"},n.a.createElement("h6",{className:"mt-1 mb-2"},n.a.createElement("strong",null,e("copy_to_clipboard.Page path and parmanent link"))),n.a.createElement("span",{className:"small mb-1"},t),n.a.createElement("br",null),n.a.createElement("span",{className:"small"},a)))),this.props.pageId&&n.a.createElement(c.CopyToClipboard,{text:`[${this.props.pagePath}](${a})`,onCopy:this.showToolTip},n.a.createElement(l.a,null,n.a.createElement("div",{className:"d-inline-flex flex-column"},n.a.createElement("h6",{className:"mt-1 mb-2"},n.a.createElement("strong",null,e("copy_to_clipboard.Markdown link"))),n.a.createElement("span",{className:"small"},`[${t}](${a})`))))))}}d.propTypes={t:r.a.func.isRequired,pagePath:r.a.string.isRequired,pageId:r.a.string,buttonStyle:r.a.object}}).call(this,a("jquery"))},"./src/client/js/components/Page/RevisionBody.jsx":function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/throttle-debounce/index.esm.js");class l extends n.a.PureComponent{constructor(e){super(e),this.renderMathJaxWithDebounce=Object(o.a)(200,this.renderMathJax)}componentDidMount(){null!=window.MathJax&&this.props.isMathJaxEnabled&&this.props.renderMathJaxOnInit&&this.renderMathJaxWithDebounce()}componentDidUpdate(){null!=window.MathJax&&this.props.isMathJaxEnabled&&this.props.renderMathJaxInRealtime&&this.renderMathJaxWithDebounce()}componentWillReceiveProps(e){null!=window.MathJax&&this.props.isMathJaxEnabled&&this.props.renderMathJaxOnInit&&this.renderMathJaxWithDebounce()}renderMathJax(){const e=window.MathJax;e.Hub.Queue(["Typeset",e.Hub,this.element])}generateInnerHtml(e){return{__html:e}}render(){const e=this.props.additionalClassName||"";return n.a.createElement("div",{ref:e=>{this.element=e,null!=this.props.inputRef&&this.props.inputRef(e)},className:`wiki ${e}`,dangerouslySetInnerHTML:this.generateInnerHtml(this.props.html)})}}l.propTypes={html:r.a.string,inputRef:r.a.func,isMathJaxEnabled:r.a.bool,renderMathJaxOnInit:r.a.bool,renderMathJaxInRealtime:r.a.bool,additionalClassName:r.a.string}},"./src/client/js/components/Page/RevisionLoader.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-waypoint/es/index.js"),l=a("./src/client/js/components/UnstatedUtils.jsx"),c=a("./src/client/js/util/GrowiRenderer.js"),d=a("./src/client/js/services/AppContainer.js"),h=a("./src/client/js/components/Page/RevisionRenderer.jsx");class p extends n.a.Component{constructor(e){super(e),this.logger=a("./src/lib/service/logger/index.js")("growi:Page:RevisionLoader"),this.state={markdown:"",isLoading:!1,isLoaded:!1,error:null},this.loadData=this.loadData.bind(this),this.onWaypointChange=this.onWaypointChange.bind(this)}componentWillMount(){this.props.lazy||this.loadData()}async loadData(){this.state.isLoaded||this.state.isLoading||this.setState({isLoading:!0});const e={page_id:this.props.pageId,revision_id:this.props.revisionId};try{const t=await this.props.appContainer.apiGet("/revisions.get",e);this.setState({markdown:t.revision.body,error:null}),null!=this.props.onRevisionLoaded&&this.props.onRevisionLoaded(t.revision)}catch(e){this.setState({error:e})}finally{this.setState({isLoaded:!0,isLoading:!1})}}onWaypointChange(e){e.currentPosition!==o.a.above&&e.currentPosition!==o.a.inside||this.loadData()}render(){if(this.props.lazy&&!this.state.isLoaded)return n.a.createElement(o.a,{onPositionChange:this.onWaypointChange,bottomOffset:"-100px"},n.a.createElement("div",{className:"wiki"}));if(this.state.isLoading)return n.a.createElement("div",{className:"wiki"},n.a.createElement("div",{className:"text-muted text-center"},n.a.createElement("i",{className:"fa fa-2x fa-spinner fa-pulse mr-1"})));let e=this.state.markdown;return null!=this.state.error&&(e=`<span class="text-muted"><em>${this.state.error}</em></span>`),n.a.createElement(h.a,{growiRenderer:this.props.growiRenderer,markdown:e,highlightKeywords:this.props.highlightKeywords})}}p.propTypes={appContainer:r.a.instanceOf(d.a).isRequired,growiRenderer:r.a.instanceOf(c.a).isRequired,pageId:r.a.string.isRequired,revisionId:r.a.string.isRequired,lazy:r.a.bool,onRevisionLoaded:r.a.func,highlightKeywords:r.a.string},t.a=e=>Object(l.a)(p,e,[d.a])},"./src/client/js/components/Page/RevisionPath.jsx":function(e,t,a){"use strict";(function(e){var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./node_modules/url-join/lib/url-join.js"),c=a.n(l),d=a("./src/client/js/components/Page/CopyDropdown.jsx");class h extends n.a.Component{constructor(e){super(e),this.state={pages:[],isListPage:!1,isLinkToListPage:!0,isInTrash:!1},this.xss=window.xss}componentWillMount(){const e=this.props.pagePath.match(/\/$/);this.setState({isListPage:e});const{behaviorType:t}=this.props,a="crowi"===t;this.setState({isLinkToListPage:a}),this.generateHierarchyData()}generateHierarchyData(){const e=this.props.pagePath.split(/\//);e.shift(),""===e[e.length-1]&&e.pop();const t=[],a=[];e.forEach(s=>{"trash"===s&&e.length>1?this.setState({isInTrash:!0}):(a.push(encodeURIComponent(s)),t.push({pagePath:c()("/",...a),pageName:this.xss.process(s)}))}),this.setState({pages:t})}showToolTip(){e("#copyPagePathDropdown").tooltip("show"),setTimeout(()=>{e("#copyPagePathDropdown").tooltip("hide")},1e3)}generateLinkElementToListPage(e,t,a){return t?n.a.createElement("a",{href:`${e}/`,className:a&&!this.state.isListPage?"last-path":""},"/"):a?n.a.createElement("span",null):n.a.createElement("span",null,"/")}render(){const e={marginLeft:"0.2em",marginRight:"0.2em"},t={marginLeft:"0.5em",padding:"0 2px"},{isInTrash:a}=this.state,s=this.state.pages.length,i=a?n.a.createElement(n.a.Fragment,null,n.a.createElement("span",{className:"path-segment"},n.a.createElement("a",{href:"/trash"},n.a.createElement("i",{className:"icon-trash"}))),n.a.createElement("span",{className:"separator",style:e},n.a.createElement("a",{href:"/"},"/"))):n.a.createElement(n.a.Fragment,null,n.a.createElement("span",{className:"path-segment"},n.a.createElement("a",{href:"/"},n.a.createElement("i",{className:"icon-home"}),n.a.createElement("span",{className:"separator",style:e},"/")))),r=[];return this.state.pages.forEach((t,a)=>{const i=a===s-1;r.push(n.a.createElement("span",{key:t.pagePath,className:"path-segment"},n.a.createElement("a",{href:t.pagePath},t.pageName))),r.push(n.a.createElement("span",{key:`${t.pagePath}/`,className:"separator",style:e},this.generateLinkElementToListPage(t.pagePath,this.state.isLinkToListPage,i)))}),n.a.createElement("span",{className:"d-flex align-items-center"},i,r,n.a.createElement(d.a,{t:this.props.t,pagePath:this.props.pagePath,pageId:this.props.pageId,buttonStyle:t}),n.a.createElement("a",{href:"#edit",className:"btn btn-default btn-edit",style:t},n.a.createElement("i",{className:"icon-note"})))}}h.propTypes={t:r.a.func.isRequired,behaviorType:r.a.string.isRequired,pagePath:r.a.string.isRequired,pageId:r.a.string},t.a=Object(o.c)()(h)}).call(this,a("jquery"))},"./src/client/js/components/Page/RevisionRenderer.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/client/js/components/UnstatedUtils.jsx"),l=a("./src/client/js/services/AppContainer.js"),c=a("./src/client/js/services/PageContainer.js"),d=a("./src/client/js/util/GrowiRenderer.js"),h=a("./src/client/js/components/Page/RevisionBody.jsx");class p extends n.a.PureComponent{constructor(e){super(e),this.state={html:""},this.renderHtml=this.renderHtml.bind(this),this.getHighlightedBody=this.getHighlightedBody.bind(this)}initCurrentRenderingContext(){this.currentRenderingContext={markdown:this.props.markdown,currentPagePath:this.props.pageContainer.state.path}}componentDidMount(){this.initCurrentRenderingContext(),this.renderHtml()}componentDidUpdate(e){const{markdown:t,highlightKeywords:a}=e,{markdown:s,highlightKeywords:n}=this.props;if(s!==t||n!==a)return this.initCurrentRenderingContext(),void this.renderHtml();const{interceptorManager:i}=this.props.appContainer;i.process("postRenderHtml",this.currentRenderingContext)}getHighlightedBody(e,t){let a=e;return t.replace(/"/g,"").split(" ").forEach(e=>{if(""===e)return;const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/(^"|"$)/g,""),s=new RegExp(`(${t}(?!(.*?")))`,"ig");a=a.replace(s,'<em class="highlighted">$&</em>')}),a}async renderHtml(){const{appContainer:e,growiRenderer:t,highlightKeywords:a}=this.props,{interceptorManager:s}=e,n=this.currentRenderingContext;await s.process("preRender",n),await s.process("prePreProcess",n),n.markdown=t.preProcess(n.markdown),await s.process("postPreProcess",n),n.parsedHTML=t.process(n.markdown),await s.process("prePostProcess",n),n.parsedHTML=t.postProcess(n.parsedHTML),null!=this.props.highlightKeywords&&(n.parsedHTML=this.getHighlightedBody(n.parsedHTML,a)),await s.process("postPostProcess",n),await s.process("preRenderHtml",n),this.setState({html:n.parsedHTML})}render(){const e=!!this.props.appContainer.getConfig().env.MATHJAX;return n.a.createElement(h.a,{html:this.state.html,isMathJaxEnabled:e,renderMathJaxOnInit:!0})}}p.propTypes={appContainer:r.a.instanceOf(l.a).isRequired,pageContainer:r.a.instanceOf(c.a).isRequired,growiRenderer:r.a.instanceOf(d.a).isRequired,markdown:r.a.string.isRequired,highlightKeywords:r.a.string},t.a=e=>Object(o.a)(p,e,[l.a,c.a])},"./src/client/js/components/Page/TagLabels.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./node_modules/toastr/toastr.js"),c=a("./src/client/js/components/UnstatedUtils.jsx"),d=a("./src/client/js/services/AppContainer.js"),h=a("./src/client/js/services/PageContainer.js"),p=a("./src/client/js/services/EditorContainer.js"),m=a("./node_modules/react-bootstrap/es/Button.js"),u=a("./node_modules/react-bootstrap/es/Modal.js"),g=a("./node_modules/react-bootstrap-typeahead/lib/index.js");class f extends n.a.Component{constructor(e){super(e),this.state={resultTags:[],isLoading:!1,selected:this.props.tags,defaultPageTags:this.props.tags},this.handleChange=this.handleChange.bind(this),this.handleSearch=this.handleSearch.bind(this),this.handleSelect=this.handleSelect.bind(this)}componentDidMount(){this.typeahead.getInstance().focus()}handleChange(e){this.setState({selected:e},()=>{this.props.onTagsUpdated(this.state.selected)})}async handleSearch(e){this.setState({isLoading:!0});const t=await this.props.appContainer.apiGet("/tags.search",{q:e});t.tags.unshift(e),this.setState({resultTags:Array.from(new Set(t.tags)),isLoading:!1})}handleSelect(e){if(32===e.keyCode){e.preventDefault();const t=this.typeahead.getInstance(),{initialItem:a}=t.state;a&&t._handleMenuItemSelect(a,e)}}render(){return n.a.createElement("div",{className:"tag-typeahead"},n.a.createElement(g.AsyncTypeahead,{id:"tag-typeahead-asynctypeahead",ref:e=>{this.typeahead=e},caseSensitive:!1,defaultSelected:this.state.defaultPageTags,isLoading:this.state.isLoading,minLength:1,multiple:!0,newSelectionPrefix:"",onChange:this.handleChange,onSearch:this.handleSearch,onKeyDown:this.handleSelect,options:this.state.resultTags,placeholder:"tag name",selectHintOnEnter:!0}))}}f.propTypes={appContainer:r.a.instanceOf(d.a).isRequired,tags:r.a.array.isRequired,onTagsUpdated:r.a.func.isRequired},f.defaultProps={};var b=e=>Object(c.a)(f,e,[d.a]);class E extends n.a.Component{constructor(e){super(e),this.state={tags:[],isOpenModal:!1},this.show=this.show.bind(this),this.onTagsUpdatedByTagsInput=this.onTagsUpdatedByTagsInput.bind(this),this.closeModalHandler=this.closeModalHandler.bind(this),this.handleSubmit=this.handleSubmit.bind(this)}show(e){this.setState({tags:e,isOpenModal:!0})}onTagsUpdatedByTagsInput(e){this.setState({tags:e})}closeModalHandler(){this.setState({isOpenModal:!1})}async handleSubmit(){this.props.onTagsUpdated(this.state.tags),this.setState({isOpenModal:!1})}render(){return n.a.createElement(u.a,{show:this.state.isOpenModal,onHide:this.closeModalHandler,id:"editTagModal"},n.a.createElement(u.a.Header,{closeButton:!0,className:"bg-primary"},n.a.createElement(u.a.Title,{className:"text-white"},"Edit Tags")),n.a.createElement(u.a.Body,null,n.a.createElement(b,{tags:this.state.tags,onTagsUpdated:this.onTagsUpdatedByTagsInput})),n.a.createElement(u.a.Footer,null,n.a.createElement(m.a,{variant:"primary",onClick:this.handleSubmit},"Done")))}}E.propTypes={appContainer:r.a.instanceOf(d.a).isRequired,onTagsUpdated:r.a.func.isRequired};class C extends n.a.Component{constructor(e){super(e),this.state={showTagEditor:!1},this.showEditor=this.showEditor.bind(this),this.tagsUpdatedHandler=this.tagsUpdatedHandler.bind(this)}getEditTargetData(){const{editorMode:e}=this.props.appContainer.state;return null==e?this.props.pageContainer.state.tags:this.props.editorContainer.state.tags}showEditor(){this.tagEditor.show(this.getEditTargetData())}async tagsUpdatedHandler(e){const{appContainer:t,editorContainer:a}=this.props,{editorMode:s}=t.state;if(null==s){const{pageContainer:s}=this.props;try{const{pageId:n}=s.state;await t.apiPost("/tags.update",{pageId:n,tags:e}),s.setState({tags:e}),a.setState({tags:e}),this.apiSuccessHandler()}catch(e){return void this.apiErrorHandler(e)}}else a.setState({tags:e})}apiSuccessHandler(){l.success(void 0,"updated tags successfully",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"1200",extendedTimeOut:"150"})}apiErrorHandler(e){l.error(e.message,"Error occured",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"3000"})}render(){const{t:e}=this.props,{pageId:t}=this.props.pageContainer.state,a=this.getEditTargetData(),s=a.map(e=>n.a.createElement("span",{key:`${t}_${e}`,className:"text-muted"},n.a.createElement("i",{className:"tag-icon icon-tag mr-1"}),n.a.createElement("a",{className:"tag-name mr-2",href:`/_search?q=tag:${e}`,key:`${t}_${e}_link`},e)));return n.a.createElement("div",{className:`tag-viewer ${t?"existed-page":"new-page"}`},0===a.length&&n.a.createElement("a",{className:"btn btn-link btn-edit-tags no-tags p-0",onClick:this.showEditor},e("Add tags for this page")," ",n.a.createElement("i",{className:"manage-tags ml-2 icon-plus"})),s,a.length>0&&n.a.createElement("a",{className:"btn btn-link btn-edit-tags p-0",onClick:this.showEditor},n.a.createElement("i",{className:"manage-tags ml-2 icon-plus"})," ",e("Edit tags for this page")),n.a.createElement(E,{ref:e=>{this.tagEditor=e},appContainer:this.props.appContainer,show:this.state.showTagEditor,onTagsUpdated:this.tagsUpdatedHandler}))}}C.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(d.a).isRequired,pageContainer:r.a.instanceOf(h.a).isRequired,editorContainer:r.a.instanceOf(p.a).isRequired};t.a=Object(o.c)()(e=>Object(c.a)(C,e,[d.a,h.a,p.a]))},"./src/client/js/components/PageAttachment.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/client/js/components/PageAttachment/Attachment.jsx");class l extends n.a.Component{render(){if(this.props.attachments<=0)return null;const e=this.props.attachments.map((e,t)=>n.a.createElement(o.a,{key:`page:attachment:${e._id}`,attachment:e,inUse:this.props.inUse[e._id]||!1,onAttachmentDeleteClicked:this.props.onAttachmentDeleteClicked,isUserLoggedIn:this.props.isUserLoggedIn}));return n.a.createElement("div",null,0!==e.length&&n.a.createElement("h5",null,n.a.createElement("strong",null,"Attachments")),n.a.createElement("ul",{className:"pl-2"},e))}}l.propTypes={attachments:r.a.arrayOf(r.a.object),inUse:r.a.objectOf(r.a.bool),onAttachmentDeleteClicked:r.a.func,isUserLoggedIn:r.a.bool},l.defaultProps={attachments:[],inUse:{}};var c=a("./node_modules/react-bootstrap/es/Button.js"),d=a("./node_modules/react-bootstrap/es/Modal.js"),h=a("./src/client/js/components/User/UserPicture.jsx"),p=a("./src/client/js/components/User/Username.jsx");function m(){return(m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e}).apply(this,arguments)}class u extends n.a.Component{constructor(e){super(e),this._onDeleteConfirm=this._onDeleteConfirm.bind(this)}_onDeleteConfirm(){this.props.onAttachmentDeleteClickedConfirm(this.props.attachmentToDelete)}iconNameByFormat(e){return e.match(/image\/.+/i)?"icon-picture":"icon-doc"}renderByFileFormat(e){const t=e.fileFormat.match(/image\/.+/i)?n.a.createElement("img",{src:e.filePathProxied,alt:"deleting image"}):"";return n.a.createElement("div",{className:"attachment-delete-image"},n.a.createElement("p",null,n.a.createElement("i",{className:this.iconNameByFormat(e.fileFormat)})," ",e.originalName),n.a.createElement("p",null,"uploaded by ",n.a.createElement(h.a,{user:e.creator,size:"sm"})," ",n.a.createElement(p.a,{user:e.creator})),t)}render(){const e=this.props.attachmentToDelete;if(null===e)return null;const t=Object.assign({},this.props);delete t.onAttachmentDeleteClickedConfirm,delete t.attachmentToDelete,delete t.inUse,delete t.deleting,delete t.deleteError;let a="";this.props.deleting&&(a=n.a.createElement("div",{className:"speeding-wheel-sm"})),this.props.deleteError&&(a=n.a.createElement("span",null,this.props.deleteError));const s=this.renderByFileFormat(e);return n.a.createElement(d.a,m({},t,{className:"attachment-delete-modal",bsSize:"large","aria-labelledby":"contained-modal-title-lg"}),n.a.createElement(d.a.Header,{closeButton:!0},n.a.createElement(d.a.Title,{id:"contained-modal-title-lg"},"Delete attachment?")),n.a.createElement(d.a.Body,null,s),n.a.createElement(d.a.Footer,null,n.a.createElement("div",{className:"mr-3 d-inline-block"},a),n.a.createElement(c.a,{onClick:this._onDeleteConfirm,bsStyle:"danger",disabled:this.props.deleting},"Delete!")))}}var g=a("./src/client/js/components/UnstatedUtils.jsx"),f=a("./src/client/js/services/AppContainer.js"),b=a("./src/client/js/services/PageContainer.js");class E extends n.a.Component{constructor(e){super(e),this.state={attachments:[],inUse:{},attachmentToDelete:null,deleting:!1,deleteError:""},this.onAttachmentDeleteClicked=this.onAttachmentDeleteClicked.bind(this),this.onAttachmentDeleteClickedConfirm=this.onAttachmentDeleteClickedConfirm.bind(this)}componentDidMount(){const{pageId:e}=this.props.pageContainer.state;e&&this.props.appContainer.apiGet("/attachments.list",{page_id:e}).then(e=>{const t=e.attachments,a={};for(const e of t)a[e._id]=this.checkIfFileInUse(e);this.setState({attachments:t,inUse:a})})}checkIfFileInUse(e){const{markdown:t}=this.props.pageContainer.state;return!!t.match(e.filePathProxied)}onAttachmentDeleteClicked(e){this.setState({attachmentToDelete:e})}onAttachmentDeleteClickedConfirm(e){const t=e._id;this.setState({deleting:!0}),this.props.appContainer.apiPost("/attachments.remove",{attachment_id:t}).then(e=>{this.setState({attachments:this.state.attachments.filter(e=>e._id!=t),attachmentToDelete:null,deleting:!1})}).catch(e=>{this.setState({deleteError:"Something went wrong.",deleting:!1})})}isUserLoggedIn(){return null!=this.props.appContainer.currentUser}render(){let e="";if(this.isUserLoggedIn()){const t=this.state.attachmentToDelete,a=()=>{this.setState({attachmentToDelete:null,deleteError:""})},s=null!==t;let i=null;null!==t&&(i=this.state.inUse[t._id]||!1),e=n.a.createElement(u,{show:s,animation:!1,onHide:a,attachmentToDelete:t,inUse:i,deleting:this.state.deleting,deleteError:this.state.deleteError,onAttachmentDeleteClickedConfirm:this.onAttachmentDeleteClickedConfirm})}return n.a.createElement("div",null,n.a.createElement(l,{attachments:this.state.attachments,inUse:this.state.inUse,onAttachmentDeleteClicked:this.onAttachmentDeleteClicked,isUserLoggedIn:this.isUserLoggedIn()}),e)}}E.propTypes={appContainer:r.a.instanceOf(f.a).isRequired,pageContainer:r.a.instanceOf(b.a).isRequired};t.a=e=>Object(g.a)(E,e,[f.a,b.a])},"./src/client/js/components/PageComment/CommentEditor.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-bootstrap/es/Button.js"),l=a("./node_modules/react-bootstrap/es/Tab.js"),c=a("./node_modules/react-bootstrap/es/Tabs.js"),d=a("./node_modules/toastr/toastr.js"),h=a("./src/client/js/services/AppContainer.js"),p=a("./src/client/js/services/PageContainer.js"),m=a("./src/client/js/services/CommentContainer.js"),u=a("./src/client/js/services/EditorContainer.js"),g=a("./src/client/js/util/GrowiRenderer.js"),f=a("./src/client/js/components/UnstatedUtils.jsx"),b=a("./src/client/js/components/User/UserPicture.jsx"),E=a("./src/client/js/components/PageEditor/Editor.jsx"),C=a("./src/client/js/components/SlackNotification.jsx"),v=a("./src/client/js/components/Page/RevisionBody.jsx");function w(){return(w=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e}).apply(this,arguments)}class y extends n.a.Component{render(){return n.a.createElement("div",{className:"page-comment-preview-body",ref:e=>{this.previewElement=e,this.props.inputRef(e)}},n.a.createElement(v.a,w({},this.props,{additionalClassName:"comment"})))}}y.propTypes={html:r.a.string,inputRef:r.a.func.isRequired};class k extends n.a.Component{constructor(e){super(e);const t=this.props.appContainer.getConfig(),a=t.upload.image||t.upload.file,s=t.upload.file;this.state={comment:this.props.commentBody||"",isMarkdown:!0,html:"",key:1,isUploadable:a,isUploadableFile:s,errorMessage:void 0,hasSlackConfig:t.hasSlackConfig},this.updateState=this.updateState.bind(this),this.updateStateCheckbox=this.updateStateCheckbox.bind(this),this.postHandler=this.postHandler.bind(this),this.uploadHandler=this.uploadHandler.bind(this),this.renderHtml=this.renderHtml.bind(this),this.handleSelect=this.handleSelect.bind(this),this.onSlackEnabledFlagChange=this.onSlackEnabledFlagChange.bind(this),this.onSlackChannelsChange=this.onSlackChannelsChange.bind(this),this.toggleEditor=this.toggleEditor.bind(this)}updateState(e){this.setState({comment:e})}updateStateCheckbox(e){const t=e.target.checked;this.setState({isMarkdown:t}),this.editor.setGfmMode(t)}handleSelect(e){this.setState({key:e}),this.renderHtml(this.state.comment)}onSlackEnabledFlagChange(e){this.props.commentContainer.setState({isSlackEnabled:e})}onSlackChannelsChange(e){this.props.commentContainer.setState({slackChannels:e})}toggleEditor(){const e=this.props.replyTo||this.props.currentCommentId;this.props.commentButtonClickedHandler(e)}initializeEditor(){this.setState({comment:"",isMarkdown:!0,html:"",key:1,errorMessage:void 0}),this.editor.setValue(""),this.toggleEditor()}async postHandler(e){null!=e&&e.preventDefault();try{null!=this.props.currentCommentId?await this.props.commentContainer.putComment(this.state.comment,this.state.isMarkdown,this.props.currentCommentId,this.props.commentCreator):await this.props.commentContainer.postComment(this.state.comment,this.state.isMarkdown,this.props.replyTo,this.props.commentContainer.state.isSlackEnabled,this.props.commentContainer.state.slackChannels),this.initializeEditor()}catch(e){const t=e.message||"An unknown error occured when posting comment";this.setState({errorMessage:t})}}uploadHandler(e){this.props.commentContainer.uploadAttachment(e).then(e=>{const t=e.attachment;let a=`[${t.originalName}](${t.filePathProxied})`;t.fileFormat.startsWith("image/")&&(a=`!${a}`),this.editor.insertText(a)}).catch(this.apiErrorHandler).then(()=>{this.editor.terminateUploadingState()})}apiErrorHandler(e){d.error(e.message,"Error occured",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"3000"})}getCommentHtml(){return n.a.createElement(y,{inputRef:e=>{this.previewElement=e},html:this.state.html})}renderHtml(e){const t={markdown:e},{growiRenderer:a}=this.props,s=this.props.appContainer.interceptorManager;s.process("preRenderCommnetPreview",t).then(()=>s.process("prePreProcess",t)).then(()=>{t.markdown=a.preProcess(t.markdown)}).then(()=>s.process("postPreProcess",t)).then(()=>{const e=a.process(t.markdown);t.parsedHTML=e}).then(()=>s.process("prePostProcess",t)).then(()=>{t.parsedHTML=a.postProcess(t.parsedHTML)}).then(()=>s.process("postPostProcess",t)).then(()=>s.process("preRenderCommentPreviewHtml",t)).then(()=>{this.setState({html:t.parsedHTML})}).then(()=>s.process("postRenderCommentPreviewHtml",t))}generateInnerHtml(e){return{__html:e}}render(){const{appContainer:e,commentContainer:t}=this.props,a=this.state.isMarkdown?this.getCommentHtml():null,s=e.getEmojiStrategy(),i=this.props.appContainer.getConfig().layoutType.match(/crowi-plus|growi|kibela/),r=n.a.createElement("span",{className:"text-danger text-right mr-2"},this.state.errorMessage),d=n.a.createElement(o.a,{bsStyle:"primary",className:"fcbtn btn btn-primary btn-outline btn-rounded btn-1b",onClick:this.postHandler},"Comment");return n.a.createElement("div",{className:"form page-comment-form"},n.a.createElement("div",{className:"comment-form"},i&&n.a.createElement("div",{className:"comment-form-user"},n.a.createElement(b.a,{user:e.currentUser})),n.a.createElement("div",{className:"comment-form-main"},n.a.createElement("div",{className:"comment-write"},n.a.createElement(c.a,{activeKey:this.state.key,id:"comment-form-tabs",onSelect:this.handleSelect,animation:!1},n.a.createElement(l.a,{eventKey:1,title:"Write"},n.a.createElement(E.a,{ref:e=>{this.editor=e},value:this.state.comment,isGfmMode:this.state.isMarkdown,lineNumbers:!1,isMobile:e.isMobile,isUploadable:this.state.isUploadable&&this.state.isLayoutTypeGrowi,isUploadableFile:this.state.isUploadableFile,emojiStrategy:s,onChange:this.updateState,onUpload:this.uploadHandler,onCtrlEnter:this.postHandler})),this.state.isMarkdown&&n.a.createElement(l.a,{eventKey:2,title:"Preview"},n.a.createElement("div",{className:"comment-form-preview"},a)))),n.a.createElement("div",{className:"comment-submit"},n.a.createElement("div",{className:"d-flex"},n.a.createElement("label",{style:{flex:1}},i&&1===this.state.key&&n.a.createElement("span",null,n.a.createElement("input",{type:"checkbox",id:"comment-form-is-markdown",name:"isMarkdown",checked:this.state.isMarkdown,value:"1",onChange:this.updateStateCheckbox}),n.a.createElement("span",{className:"ml-2"},"Markdown"))),n.a.createElement("span",{className:"hidden-xs"},this.state.errorMessage&&r),this.state.hasSlackConfig&&n.a.createElement("div",{className:"form-inline align-self-center mr-md-2"},n.a.createElement(C.a,{isSlackEnabled:t.state.isSlackEnabled,slackChannels:t.state.slackChannels,onEnabledFlagChange:this.onSlackEnabledFlagChange,onChannelChange:this.onSlackChannelsChange})),n.a.createElement("div",null,n.a.createElement(o.a,{bsStyle:"danger",className:"fcbtn btn btn-xs btn-danger btn-outline btn-rounded",onClick:this.toggleEditor},"Cancel")),"",n.a.createElement("div",{className:"hidden-xs"},d)),n.a.createElement("div",{className:"visible-xs mt-2"},n.a.createElement("div",{className:"d-flex justify-content-end"},this.state.errorMessage&&r,n.a.createElement("div",null,d)))))))}}k.propTypes={appContainer:r.a.instanceOf(h.a).isRequired,pageContainer:r.a.instanceOf(p.a).isRequired,editorContainer:r.a.instanceOf(u.a).isRequired,commentContainer:r.a.instanceOf(m.a).isRequired,growiRenderer:r.a.instanceOf(g.a).isRequired,replyTo:r.a.string,currentCommentId:r.a.string,commentBody:r.a.string,commentCreator:r.a.string,commentButtonClickedHandler:r.a.func.isRequired};t.a=e=>Object(f.a)(k,e,[h.a,p.a,u.a,m.a])},"./src/client/js/components/PageComment/CommentEditorLazyRenderer.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/client/js/components/UnstatedUtils.jsx"),l=a("./src/client/js/services/AppContainer.js"),c=a("./src/client/js/components/User/UserPicture.jsx"),d=a("./src/client/js/components/PageComment/CommentEditor.jsx");class h extends n.a.Component{constructor(e){super(e),this.state={isEditorShown:!1},this.growiRenderer=this.props.appContainer.getRenderer("comment"),this.showCommentFormBtnClickHandler=this.showCommentFormBtnClickHandler.bind(this)}showCommentFormBtnClickHandler(){this.setState({isEditorShown:!this.state.isEditorShown})}render(){const{appContainer:e}=this.props,t=e.currentUser,a=null!=t,s=this.props.appContainer.getConfig().layoutType.match(/crowi-plus|growi|kibela/);return a?n.a.createElement(n.a.Fragment,null,!this.state.isEditorShown&&n.a.createElement("div",{className:"form page-comment-form"},n.a.createElement("div",{className:"comment-form"},s&&n.a.createElement("div",{className:"comment-form-user"},n.a.createElement(c.a,{user:t})),n.a.createElement("div",{className:"comment-form-main"},!this.state.isEditorShown&&n.a.createElement("button",{type:"button",className:`btn btn-lg ${s?"btn-link":"btn-primary"} center-block`,onClick:this.showCommentFormBtnClickHandler},n.a.createElement("i",{className:"icon-bubble"})," Add Comment")))),this.state.isEditorShown&&n.a.createElement(d.a,{growiRenderer:this.growiRenderer,replyTo:void 0,commentButtonClickedHandler:this.showCommentFormBtnClickHandler})):n.a.createElement(n.a.Fragment,null)}}h.propTypes={appContainer:r.a.instanceOf(l.a).isRequired},t.a=e=>Object(o.a)(h,e,[l.a])},"./src/client/js/components/PageComments.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-bootstrap/es/Button.js"),l=a("./node_modules/react-i18next/dist/es/index.js"),c=a("./src/client/js/services/AppContainer.js"),d=a("./src/client/js/services/CommentContainer.js"),h=a("./src/client/js/services/PageContainer.js"),p=a("./src/client/js/components/UnstatedUtils.jsx"),m=a("./src/client/js/components/PageComment/CommentEditor.jsx"),u=a("./node_modules/date-fns/esm/formatDistanceStrict/index.js"),g=a("./node_modules/date-fns/esm/format/index.js"),f=a("./node_modules/react-bootstrap/es/Tooltip.js"),b=a("./node_modules/react-bootstrap/es/OverlayTrigger.js"),E=a("./src/client/js/components/Page/RevisionBody.jsx"),C=a("./src/client/js/components/User/UserPicture.jsx"),v=a("./src/client/js/components/User/Username.jsx");const w=e=>n.a.createElement("div",{className:"page-comment-control"},n.a.createElement("button",{type:"button",className:"btn btn-link p-2",onClick:e.onClickEditBtn},n.a.createElement("i",{className:"ti-pencil"})),n.a.createElement("button",{type:"button",className:"btn btn-link p-2 mr-2",onClick:e.onClickDeleteBtn},n.a.createElement("i",{className:"ti-close"})));w.propTypes={onClickEditBtn:r.a.func.isRequired,onClickDeleteBtn:r.a.func.isRequired};var y=w;class k extends n.a.PureComponent{constructor(e){super(e),this.state={html:"",isReEdit:!1},this.growiRenderer=this.props.appContainer.getRenderer("comment"),this.isCurrentUserIsAuthor=this.isCurrentUserEqualsToAuthor.bind(this),this.isCurrentRevision=this.isCurrentRevision.bind(this),this.getRootClassName=this.getRootClassName.bind(this),this.getRevisionLabelClassName=this.getRevisionLabelClassName.bind(this),this.editBtnClickedHandler=this.editBtnClickedHandler.bind(this),this.deleteBtnClickedHandler=this.deleteBtnClickedHandler.bind(this),this.renderText=this.renderText.bind(this),this.renderHtml=this.renderHtml.bind(this),this.commentButtonClickedHandler=this.commentButtonClickedHandler.bind(this)}initCurrentRenderingContext(){this.currentRenderingContext={markdown:this.props.comment.comment}}componentDidMount(){this.initCurrentRenderingContext(),this.renderHtml()}componentDidUpdate(e){const{comment:t}=e,{comment:a}=this.props;if(a!==t)return this.initCurrentRenderingContext(),void this.renderHtml();const{interceptorManager:s}=this.props.appContainer;s.process("postRenderCommentHtml",this.currentRenderingContext)}checkPermissionToControlComment(){return this.props.appContainer.isAdmin||this.isCurrentUserEqualsToAuthor()}isCurrentUserEqualsToAuthor(){return this.props.comment.creator.username===this.props.appContainer.currentUsername}isCurrentRevision(){return this.props.comment.revision===this.props.pageContainer.state.revisionId}getRootClassName(e){let t="page-comment";const{revisionId:a,revisionCreatedAt:s}=this.props.pageContainer.state;return e.revision===a?t+=" page-comment-current":Date.parse(e.createdAt)/1e3>s?t+=" page-comment-newer":t+=" page-comment-older",this.isCurrentUserEqualsToAuthor()&&(t+=" page-comment-me"),t}getRevisionLabelClassName(){return`page-comment-revision label ${this.isCurrentRevision()?"label-primary":"label-default"}`}editBtnClickedHandler(){this.setState({isReEdit:!this.state.isReEdit})}commentButtonClickedHandler(){this.editBtnClickedHandler()}deleteBtnClickedHandler(){this.props.deleteBtnClicked(this.props.comment)}renderText(e){return n.a.createElement("span",{style:{whiteSpace:"pre-wrap"}},e)}renderRevisionBody(){const e=!!this.props.appContainer.getConfig().env.MATHJAX;return n.a.createElement(E.a,{html:this.state.html,isMathJaxEnabled:e,renderMathJaxOnInit:!0,additionalClassName:"comment"})}async renderHtml(){const{growiRenderer:e,appContainer:t}=this.props,{interceptorManager:a}=t,s=this.currentRenderingContext;await a.process("preRenderComment",s),await a.process("prePreProcess",s),s.markdown=await e.preProcess(s.markdown),await a.process("postPreProcess",s),s.parsedHTML=await e.process(s.markdown),await a.process("prePostProcess",s),s.parsedHTML=await e.postProcess(s.parsedHTML),await a.process("postPostProcess",s),await a.process("preRenderCommentHtml",s),this.setState({html:s.parsedHTML}),await a.process("postRenderCommentHtml",s)}render(){const e=this.props.comment,t=e._id,a=e.creator,s=e.isMarkdown,i=new Date(e.createdAt),r=new Date(e.updatedAt),o=i<r,l=this.getRootClassName(e),c=Object(u.a)(i,new Date),d=s?this.renderRevisionBody():this.renderText(e.comment),h=`?revision=${e.revision}`,p=e.revision.substr(-8),E=this.getRevisionLabelClassName(),w=n.a.createElement(f.a,{id:`commentDateTooltip-${e._id}`},Object(g.a)(i,"yyyy/MM/dd HH:mm")),k=o?n.a.createElement(f.a,{id:`editedDateTooltip-${e._id}`},Object(g.a)(r,"yyyy/MM/dd HH:mm")):null;return n.a.createElement(n.a.Fragment,null,this.state.isReEdit?n.a.createElement(m.a,{growiRenderer:this.growiRenderer,currentCommentId:t,commentBody:e.comment,replyTo:void 0,commentButtonClickedHandler:this.commentButtonClickedHandler,commentCreator:a.username}):n.a.createElement("div",{id:t,className:l},n.a.createElement(C.a,{user:a}),n.a.createElement("div",{className:"page-comment-main"},n.a.createElement("div",{className:"page-comment-creator"},n.a.createElement(v.a,{user:a})),n.a.createElement("div",{className:"page-comment-body"},d),n.a.createElement("div",{className:"page-comment-meta"},n.a.createElement(b.a,{overlay:w,placement:"bottom"},n.a.createElement("span",null,n.a.createElement("a",{href:`#${t}`},c))),o&&n.a.createElement(b.a,{overlay:k,placement:"bottom"},n.a.createElement("span",null,"(edited)")),n.a.createElement("span",{className:"ml-2"},n.a.createElement("a",{className:E,href:h},p))),this.checkPermissionToControlComment()&&n.a.createElement(y,{onClickDeleteBtn:this.deleteBtnClickedHandler,onClickEditBtn:this.editBtnClickedHandler}))))}}k.propTypes={appContainer:r.a.instanceOf(c.a).isRequired,pageContainer:r.a.instanceOf(h.a).isRequired,comment:r.a.object.isRequired,growiRenderer:r.a.object.isRequired,deleteBtnClicked:r.a.func.isRequired};var x=e=>Object(p.a)(k,e,[c.a,h.a]),j=a("./node_modules/react-bootstrap/es/Modal.js");class S extends n.a.Component{static get OMIT_BODY_THRES(){return 400}componentWillMount(){}render(){if(void 0===this.props.comment)return n.a.createElement("div",null);const e=this.props.comment,t=Object(g.a)(new Date(e.createdAt),"yyyy/MM/dd HH:mm");let a=e.comment;return a.length>S.OMIT_BODY_THRES&&(a=`${a.substr(0,S.OMIT_BODY_THRES)}...`),a=n.a.createElement("span",{style:{whiteSpace:"pre-wrap"}},a),n.a.createElement(j.a,{show:this.props.isShown,onHide:this.props.cancel,className:"page-comment-delete-modal"},n.a.createElement(j.a.Header,{closeButton:!0},n.a.createElement(j.a.Title,null,n.a.createElement("i",{className:"icon-fw icon-fire text-danger"}),"Delete comment?")),n.a.createElement(j.a.Body,null,n.a.createElement(C.a,{user:e.creator,size:"xs"})," ",n.a.createElement("strong",null,n.a.createElement(v.a,{user:e.creator}))," wrote on ",t,":",n.a.createElement("p",{className:"well well-sm comment-body m-t-5"},a)),n.a.createElement(j.a.Footer,null,n.a.createElement("span",{className:"text-danger"},this.props.errorMessage),"",n.a.createElement(o.a,{onClick:this.props.cancel,bsClass:"btn btn-sm"},"Cancel"),n.a.createElement(o.a,{onClick:this.props.confirmedToDelete,bsClass:"btn btn-sm btn-danger"},n.a.createElement("i",{className:"icon icon-fire"}),"Delete")))}}S.propTypes={isShown:r.a.bool.isRequired,comment:r.a.object,errorMessage:r.a.string,cancel:r.a.func.isRequired,confirmedToDelete:r.a.func.isRequired};var L=a("./node_modules/react-bootstrap/es/Collapse.js");class M extends n.a.PureComponent{constructor(){super(),this.state={isOlderRepliesShown:!1},this.toggleIsOlderRepliesShown=this.toggleIsOlderRepliesShown.bind(this)}toggleIsOlderRepliesShown(){this.setState({isOlderRepliesShown:!this.state.isOlderRepliesShown})}renderReply(e){return n.a.createElement("div",{key:e._id,className:"page-comment-reply"},n.a.createElement(x,{comment:e,deleteBtnClicked:this.props.deleteBtnClicked,growiRenderer:this.props.growiRenderer}))}render(){const e=this.props.appContainer.getConfig().layoutType.match(/crowi-plus|growi|kibela/),t=this.props.appContainer.getConfig().isAllReplyShown||!1;let a=this.props.replyList;if(e||(a=a.slice().reverse()),t)return n.a.createElement(n.a.Fragment,null,a.map(e=>this.renderReply(e)));const s=a.length>2,{isOlderRepliesShown:i}=this.state,r=i?"icon-arrow-up":"icon-options-vertical",l=n.a.createElement("i",{className:`icon-fw ${r}`}),c=i?"":"more",d=a.slice(a.length-2,a.length),h=a.slice(0,a.length-2).map(e=>this.renderReply(e)),p=d.map(e=>this.renderReply(e));return n.a.createElement(n.a.Fragment,null,s&&n.a.createElement("div",{className:"page-comments-hidden-replies"},n.a.createElement(L.a,{in:this.state.isOlderRepliesShown},n.a.createElement("div",null,h)),n.a.createElement("div",{className:"text-center"},n.a.createElement(o.a,{bsStyle:"link",className:"page-comments-list-toggle-older",onClick:this.toggleIsOlderRepliesShown},l," ",c))),p)}}M.propTypes={appContainer:r.a.instanceOf(c.a).isRequired,pageContainer:r.a.instanceOf(h.a).isRequired,growiRenderer:r.a.object.isRequired,deleteBtnClicked:r.a.func.isRequired,replyList:r.a.array};var T=e=>Object(p.a)(M,e,[c.a,h.a]);class R extends n.a.Component{constructor(e){super(e),this.state={commentToDelete:void 0,isDeleteConfirmModalShown:!1,errorMessageForDeleting:void 0,showEditorIds:new Set},this.growiRenderer=this.props.appContainer.getRenderer("comment"),this.init=this.init.bind(this),this.confirmToDeleteComment=this.confirmToDeleteComment.bind(this),this.deleteComment=this.deleteComment.bind(this),this.showDeleteConfirmModal=this.showDeleteConfirmModal.bind(this),this.closeDeleteConfirmModal=this.closeDeleteConfirmModal.bind(this),this.replyButtonClickedHandler=this.replyButtonClickedHandler.bind(this),this.commentButtonClickedHandler=this.commentButtonClickedHandler.bind(this)}componentWillMount(){this.init()}init(){this.props.pageContainer.state.pageId&&this.props.commentContainer.retrieveComments()}confirmToDeleteComment(e){this.setState({commentToDelete:e}),this.showDeleteConfirmModal()}deleteComment(){const e=this.state.commentToDelete;this.props.commentContainer.deleteComment(e).then(()=>{this.closeDeleteConfirmModal()}).catch(e=>{this.setState({errorMessageForDeleting:e.message})})}showDeleteConfirmModal(){this.setState({isDeleteConfirmModalShown:!0})}closeDeleteConfirmModal(){this.setState({commentToDelete:void 0,isDeleteConfirmModalShown:!1,errorMessageForDeleting:void 0})}replyButtonClickedHandler(e){const t=this.state.showEditorIds.add(e);this.setState({showEditorIds:t})}commentButtonClickedHandler(e){this.setState(t=>(t.showEditorIds.delete(e),{showEditorIds:t.showEditorIds}))}getRepliesFor(e,t){const a=[];return t.forEach(t=>{t.replyTo===e._id&&a.push(t)}),a}renderThread(e,t){const a=e._id,s=this.state.showEditorIds.has(a),i=null!=this.props.appContainer.currentUser;let r="page-comment-thread";return 0===t.length&&(r+=" page-comment-thread-no-replies"),n.a.createElement("div",{key:a,className:`mb-5 ${r}`},n.a.createElement(x,{comment:e,deleteBtnClicked:this.confirmToDeleteComment,growiRenderer:this.growiRenderer}),0!==t.length&&n.a.createElement(T,{replyList:t,deleteBtnClicked:this.confirmToDeleteComment,growiRenderer:this.growiRenderer}),!s&&i&&n.a.createElement("div",{className:"text-right"},n.a.createElement(o.a,{bsStyle:"default",className:"btn btn-outline btn-default btn-sm btn-comment-reply",onClick:()=>this.replyButtonClickedHandler(a)},n.a.createElement("i",{className:"icon-fw icon-action-redo"})," Reply")),s&&i&&n.a.createElement("div",{className:"page-comment-reply-form"},n.a.createElement(m.a,{growiRenderer:this.growiRenderer,replyTo:a,commentButtonClickedHandler:this.commentButtonClickedHandler})))}render(){const e=[],t=[],a=this.props.appContainer.getConfig().layoutType.match(/crowi-plus|growi|kibela/);let s=this.props.commentContainer.state.comments;return a&&(s=s.slice().reverse()),s.forEach(a=>{void 0===a.replyTo?e.push(a):t.push(a)}),n.a.createElement("div",null,e.map(e=>{const a=this.getRepliesFor(e,t);return this.renderThread(e,a)}),n.a.createElement(S,{isShown:this.state.isDeleteConfirmModalShown,comment:this.state.commentToDelete,errorMessage:this.state.errorMessageForDeleting,cancel:this.closeDeleteConfirmModal,confirmedToDelete:this.deleteComment}))}}R.propTypes={appContainer:r.a.instanceOf(c.a).isRequired,pageContainer:r.a.instanceOf(h.a).isRequired,commentContainer:r.a.instanceOf(d.a).isRequired};t.a=Object(l.c)()(e=>Object(p.a)(R,e,[c.a,h.a,d.a]))},"./src/client/js/components/PageEditor.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/lib/service/logger/index.js"),l=a.n(o),c=a("./node_modules/throttle-debounce/index.esm.js"),d=a("./node_modules/growi-commons/src/index.js"),h=a("./src/client/js/services/AppContainer.js"),p=a("./src/client/js/services/PageContainer.js"),m=a("./src/client/js/components/UnstatedUtils.jsx"),u=a("./src/client/js/components/PageEditor/Editor.jsx"),g=a("./node_modules/unstated/lib/unstated.es.js"),f=a("./src/client/js/components/Page/RevisionBody.jsx"),b=a("./src/client/js/services/EditorContainer.js");function E(){return(E=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e}).apply(this,arguments)}class C extends n.a.PureComponent{constructor(e){super(e),this.state={html:""},this.growiRenderer=e.appContainer.getRenderer("editor")}componentDidMount(){this.initCurrentRenderingContext(),this.renderPreview()}componentDidUpdate(e){const{markdown:t}=e,{markdown:a}=this.props;if(a!==t)return this.initCurrentRenderingContext(),void this.renderPreview();const{interceptorManager:s}=this.props.appContainer;s.process("postRenderPreviewHtml",this.currentRenderingContext)}initCurrentRenderingContext(){this.currentRenderingContext={markdown:this.props.markdown,currentPagePath:decodeURIComponent(window.location.pathname)}}async renderPreview(){const{appContainer:e}=this.props,{growiRenderer:t}=this,{interceptorManager:a}=e,s=this.currentRenderingContext;await a.process("preRenderPreview",s),await a.process("prePreProcess",s),s.markdown=t.preProcess(s.markdown),await a.process("postPreProcess",s),s.parsedHTML=t.process(s.markdown),await a.process("prePostProcess",s),s.parsedHTML=t.postProcess(s.parsedHTML),await a.process("postPostProcess",s),await a.process("preRenderPreviewHtml",s),this.setState({html:s.parsedHTML})}render(){return n.a.createElement(g.c,{to:[b.a]},e=>n.a.createElement("div",{className:"page-editor-preview-body",ref:e=>{this.previewElement=e,this.props.inputRef(e)},onScroll:e=>{null!=this.props.onScroll&&this.props.onScroll(e.target.scrollTop)}},n.a.createElement(f.a,E({},this.props,{html:this.state.html,renderMathJaxInRealtime:e.state.previewOptions.renderMathJaxInRealtime}))))}}C.propTypes={appContainer:r.a.instanceOf(h.a).isRequired,markdown:r.a.string,inputRef:r.a.func.isRequired,isMathJaxEnabled:r.a.bool,renderMathJaxOnInit:r.a.bool,onScroll:r.a.func};var v=e=>Object(m.a)(C,e,[h.a]);const w=new class{getCodeLineElements(e){let t;return t||(t=Array.prototype.map.call(e.getElementsByClassName("code-line"),e=>{const t=+e.getAttribute("data-line");return{element:e,line:t}}).filter(e=>!Number.isNaN(e.line))),t}getElementsForSourceLine(e,t){const a=this.getCodeLineElements(e);let s=a[0]||null;for(const e of a){if(e.line===t)return{previous:e,next:null};if(e.line>t)return{previous:s,next:e};s=e}return{previous:s}}getLineElementsAtPageOffset(e,t){const a=this.getCodeLineElements(e),s=t-e.scrollTop+this.getParentElementOffset(e);let n=-1,i=a.length-1;for(;n+1<i;){const e=Math.floor((n+i)/2),t=a[e].element.getBoundingClientRect();t.top+t.height>=s?i=e:n=e}const r=a[i];if(i>=1&&r.element.getBoundingClientRect().top>s){const e=a[n],t=e.element.getBoundingClientRect(),i={element:e.element,line:e.line};return t.height>0&&(i.line+=(s-t.top)/t.height),{previous:i,next:{element:r.element,line:r.line,fractional:0}}}const o=r.element.getBoundingClientRect();return{previous:{element:r.element,line:r.line+(s-o.top)/o.height}}}getEditorLineNumberForPageOffset(e,t){const{previous:a,next:s}=this.getLineElementsAtPageOffset(e,t);if(a){if(s){const n=(t-e.scrollTop-a.element.getBoundingClientRect().top)/(s.element.getBoundingClientRect().top-a.element.getBoundingClientRect().top);return a.line+n*(s.line-a.line)}return a.line}return null}getParentElementOffset(e){return e.getBoundingClientRect().top+ +window.getComputedStyle(e,null).paddingTop.replace("px","")}scrollPreview(e,t){const{previous:a,next:s}=this.getElementsForSourceLine(e,t);if(a){let n=0;if(s){const e=(t-a.line)/(s.line-a.line),i=s.element.getBoundingClientRect().top-a.element.getBoundingClientRect().top;n=a.element.getBoundingClientRect().top+e*i}else n=a.element.getBoundingClientRect().top;n-=this.getParentElementOffset(e),e.scrollTop+=n}}scrollPreviewToRevealOverflowing(e,t){const{previous:a,next:s}=this.getElementsForSourceLine(e,t);if(a){const t=this.getParentElementOffset(e),s=a.element.getBoundingClientRect().top-t,n=a.element.getBoundingClientRect().bottom-t;let i=null;if(s<0?i=e.scrollTop+s:n>e.clientHeight&&(i=e.scrollTop+n-e.clientHeight+20),null==i)return;e.scrollTop=i}}scrollEditor(e,t,a){let s=this.getEditorLineNumberForPageOffset(t,a);s=Math.floor(s),e.setScrollTopByLine(s)}};Object.freeze(w);var y=w;const k=l()("growi:PageEditor");class x extends n.a.Component{constructor(e){super(e);const t=this.props.appContainer.getConfig(),a=t.upload.image||t.upload.file,s=t.upload.file,n=!!t.env.MATHJAX;this.state={markdown:this.props.pageContainer.state.markdown,isUploadable:a,isUploadableFile:s,isMathJaxEnabled:n},this.setCaretLine=this.setCaretLine.bind(this),this.focusToEditor=this.focusToEditor.bind(this),this.onMarkdownChanged=this.onMarkdownChanged.bind(this),this.onSaveWithShortcut=this.onSaveWithShortcut.bind(this),this.onUpload=this.onUpload.bind(this),this.onEditorScroll=this.onEditorScroll.bind(this),this.onEditorScrollCursorIntoView=this.onEditorScrollCursorIntoView.bind(this),this.onPreviewScroll=this.onPreviewScroll.bind(this),this.saveDraft=this.saveDraft.bind(this),this.clearDraft=this.clearDraft.bind(this),this.lastScrolledDateWithCursor=null,this.isOriginOfScrollSyncEditor=!1,this.isOriginOfScrollSyncEditor=!1,this.scrollPreviewByEditorLineWithThrottle=Object(c.b)(20,this.scrollPreviewByEditorLine),this.scrollPreviewByCursorMovingWithThrottle=Object(c.b)(20,this.scrollPreviewByCursorMoving),this.scrollEditorByPreviewScrollWithThrottle=Object(c.b)(20,this.scrollEditorByPreviewScroll),this.setMarkdownStateWithDebounce=Object(c.a)(50,Object(c.b)(100,e=>{this.setState({markdown:e})})),this.saveDraftWithDebounce=Object(c.a)(800,this.saveDraft)}componentWillMount(){this.props.appContainer.registerComponentInstance("PageEditor",this)}getMarkdown(){return this.state.markdown}updateEditorValue(e){this.editor.setValue(e)}focusToEditor(){this.editor.forceToFocus()}setCaretLine(e){this.editor.setCaretLine(e),y.scrollPreview(this.previewElement,e)}onMarkdownChanged(e){this.setMarkdownStateWithDebounce(e),this.saveDraftWithDebounce()}async onSaveWithShortcut(){const{pageContainer:e,editorContainer:t}=this.props,a=t.getCurrentOptionsToSave();try{t.disableUnsavedWarning();const{page:s,tags:n}=await e.save(this.state.markdown,a);k.debug("success to save"),e.showSuccessToastr(),t.setState({tags:n})}catch(t){k.error("failed to save",t),e.showErrorToastr(t)}}async onUpload(e){const{appContainer:t,pageContainer:a}=this.props;try{let s=await t.apiGet("/attachments.limit",{fileSize:e.size});if(!s.isUploadable)throw new Error(s.errorMessage);const n=new FormData,{pageId:i,path:r}=a.state;n.append("_csrf",t.csrfToken),n.append("file",e),n.append("path",r),null!=i&&n.append("page_id",a.state.pageId);const o=(s=await t.apiPost("/attachments.add",n)).attachment;let l=`[${o.originalName}](${o.filePathProxied})`;o.fileFormat.startsWith("image/")&&(l=`!${l}`),this.editor.insertText(l),s.pageCreated&&(k.info("Page is created",s.page._id),a.updateStateAfterSave(s.page))}catch(e){k.error("failed to upload",e),a.showErrorToastr(e)}finally{this.editor.terminateUploadingState()}}onEditorScroll(e){new Date-this.lastScrolledDateWithCursor<40||this.scrollPreviewByEditorLineWithThrottle(e.line)}onEditorScrollCursorIntoView(e){this.lastScrolledDateWithCursor=new Date,this.scrollPreviewByCursorMovingWithThrottle(e)}scrollPreviewByEditorLine(e){null!=this.previewElement&&(this.isOriginOfScrollSyncPreview?this.isOriginOfScrollSyncPreview=!1:(this.isOriginOfScrollSyncEditor=!0,y.scrollPreview(this.previewElement,e)))}scrollPreviewByCursorMoving(e){null!=this.previewElement&&(this.isOriginOfScrollSyncPreview?this.isOriginOfScrollSyncPreview=!1:(this.isOriginOfScrollSyncEditor=!0,y.scrollPreviewToRevealOverflowing(this.previewElement,e)))}onPreviewScroll(e){this.scrollEditorByPreviewScrollWithThrottle(e)}scrollEditorByPreviewScroll(e){null!=this.previewElement&&(this.isOriginOfScrollSyncEditor?this.isOriginOfScrollSyncEditor=!1:(this.isOriginOfScrollSyncPreview=!0,y.scrollEditor(this.editor,this.previewElement,e)))}saveDraft(){const{pageContainer:e,editorContainer:t}=this.props;e.state.revisionId||t.saveDraft(e.state.path,this.state.markdown),t.enableUnsavedWarning()}clearDraft(){this.props.editorContainer.clearDraft(this.props.pageContainer.state.path)}render(){const e=this.props.appContainer.getConfig(),t=d.envUtils.toBoolean(e.env.NO_CDN),a=this.props.appContainer.getEmojiStrategy();return n.a.createElement("div",{className:"row"},n.a.createElement("div",{className:"col-md-6 col-sm-12 page-editor-editor-container"},n.a.createElement(u.a,{ref:e=>{this.editor=e},value:this.state.markdown,noCdn:t,isMobile:this.props.appContainer.isMobile,isUploadable:this.state.isUploadable,isUploadableFile:this.state.isUploadableFile,emojiStrategy:a,onScroll:this.onEditorScroll,onScrollCursorIntoView:this.onEditorScrollCursorIntoView,onChange:this.onMarkdownChanged,onUpload:this.onUpload,onSave:this.onSaveWithShortcut})),n.a.createElement("div",{className:"col-md-6 hidden-sm hidden-xs page-editor-preview-container"},n.a.createElement(v,{markdown:this.state.markdown,inputRef:e=>this.previewElement=e,isMathJaxEnabled:this.state.isMathJaxEnabled,renderMathJaxOnInit:!1,onScroll:this.onPreviewScroll})))}}x.propTypes={appContainer:r.a.instanceOf(h.a).isRequired,pageContainer:r.a.instanceOf(p.a).isRequired,editorContainer:r.a.instanceOf(b.a).isRequired};t.a=e=>Object(m.a)(x,e,[h.a,p.a,b.a])},"./src/client/js/components/PageEditor/DrawioModal.jsx":function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/i18next/dist/esm/i18next.js"),l=a("./node_modules/react-bootstrap/es/Modal.js");class c extends n.a.PureComponent{constructor(e){super(e),this.state={show:!1,drawioMxFile:""},this.drawioIFrame=n.a.createRef(),this.headerColor="#334455",this.fontFamily="Lato, -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif",this.init=this.init.bind(this),this.cancel=this.cancel.bind(this),this.receiveFromDrawio=this.receiveFromDrawio.bind(this),this.drawioURL=this.drawioURL.bind(this)}init(e){const t=e;this.setState({drawioMxFile:t})}show(e){this.init(e),window.addEventListener("message",this.receiveFromDrawio),this.setState({show:!0})}hide(){this.setState({show:!1})}cancel(){this.hide()}receiveFromDrawio(e){if("ready"!==e.data){if('{"event":"configure"}'!==e.data){if("string"==typeof e.data&&e.data.match(/mxfile/)){if(e.data.length>0){const t=(new DOMParser).parseFromString(e.data,"text/xml").getElementsByTagName("diagram")[0].innerHTML;this.props.onSave(t)}return window.removeEventListener("message",this.receiveFromDrawio),void this.hide()}return"string"==typeof e.data&&0===e.data.length?(window.removeEventListener("message",this.receiveFromDrawio),void this.hide()):void 0}if(null==e.source)return;e.source.postMessage(JSON.stringify({action:"configure",config:{css:`\n          .geMenubarContainer { background-color: ${this.headerColor} !important; }\n          .geMenubar { background-color: ${this.headerColor} !important; }\n          .geEditor { font-family: ${this.fontFamily} !important; }\n          html td.mxPopupMenuItem {\n            font-family: ${this.fontFamily} !important;\n            font-size: 8pt !important;\n          }\n          `,customFonts:["Lato","Charter"]}}),"*")}else e.source.postMessage(this.state.drawioMxFile,"*")}drawioURL(){const e=new URL("https://www.draw.io/");return e.searchParams.append("spin",1),e.searchParams.append("embed",1),e.searchParams.append("lang",o.a.language),e.searchParams.append("ui","atlas"),e.searchParams.append("configure",1),e}render(){return n.a.createElement(l.a,{show:this.state.show,onHide:this.cancel,dialogClassName:"drawio-modal",bsSize:"large",keyboard:!1},n.a.createElement(l.a.Body,{className:"p-0"},n.a.createElement("div",{className:"w-100 h-100 position-absolute d-flex"},n.a.createElement("div",{className:"mx-auto my-auto"},n.a.createElement("i",{className:"fa fa-3x fa-spinner fa-pulse mx-auto text-muted"}))),n.a.createElement("div",{className:"w-100 h-100 position-absolute d-flex"},this.state.show&&n.a.createElement("iframe",{ref:e=>{this.drawioIFrame=e},src:this.drawioURL(),className:"border-0 flex-grow-1"}))))}}c.propTypes={onSave:r.a.func}},"./src/client/js/components/PageEditor/Editor.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/unstated/lib/unstated.es.js"),l=a("./node_modules/react-bootstrap/es/Modal.js"),c=a("./node_modules/react-dropzone/dist/es/index.js"),d=a("./src/client/js/services/EditorContainer.js"),h=a("./node_modules/react-i18next/dist/es/index.js");class p extends n.a.Component{render(){const{t:e}=this.props;return n.a.createElement("div",{className:"row small"},n.a.createElement("div",{className:"col-sm-6"},n.a.createElement("h4",null,e("sandbox.header")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,n.a.createElement("code",null,"# "),e("sandbox.header_x",{index:"1"})),n.a.createElement("li",null,n.a.createElement("code",null,"## "),e("sandbox.header_x",{index:"2"})),n.a.createElement("li",null,n.a.createElement("code",null,"### "),e("sandbox.header_x",{index:"3"}))),n.a.createElement("h4",null,e("sandbox.block")),n.a.createElement("p",{className:"mb-1"},n.a.createElement("code",null,"[",e("sandbox.empty_line"),"]"),e("sandbox.block_detail")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"text"),n.a.createElement("li",null),n.a.createElement("li",null,"text")),n.a.createElement("h4",null,e("sandbox.line_break")),n.a.createElement("p",{className:"mb-1"},n.a.createElement("code",null,"[ ][ ]")," ",e("sandbox.line_break_detail")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"text"),n.a.createElement("li",null,"text")),n.a.createElement("h4",null,e("sandbox.typography")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,n.a.createElement("i",null,"*",e("sandbox.italics"),"*")),n.a.createElement("li",null,n.a.createElement("b",null,"**",e("sandbox.bold"),"**")),n.a.createElement("li",null,n.a.createElement("i",null,n.a.createElement("b",null,"***",e("sandbox.italic_bold"),"***"))),n.a.createElement("li",null,"~~",e("sandbox.strikethrough"),"~~ =< ",n.a.createElement("s",null,e("sandbox.strikethrough")))),n.a.createElement("h4",null,e("sandbox.link")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"[Google](https://www.google.co.jp/)"),n.a.createElement("li",null,"[/Page1/ChildPage1]")),n.a.createElement("h4",null,e("sandbox.code_highlight")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"```javascript:index.js"),n.a.createElement("li",null,"writeCode();"),n.a.createElement("li",null,"```"))),n.a.createElement("div",{className:"col-sm-6"},n.a.createElement("h4",null,e("sandbox.list")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"- ",e("sandbox.unordered_list_x",{index:"1"})),n.a.createElement("li",null,"- ",e("sandbox.unordered_list_x",{index:"1.1"})),n.a.createElement("li",null,"- ",e("sandbox.unordered_list_x",{index:"2"}))),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"1. ",e("sandbox.ordered_list_x",{index:"1"})),n.a.createElement("li",null,"1. ",e("sandbox.ordered_list_x",{index:"2"}))),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"- [ ] ",e("sandbox.task"),"(",e("sandbox.task_unchecked"),")"),n.a.createElement("li",null,"- [x] ",e("sandbox.task"),"(",e("sandbox.task_checked"),")")),n.a.createElement("h4",null,e("sandbox.quote")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"> ",e("sandbox.quote1")),n.a.createElement("li",null,"> ",e("sandbox.quote2"))),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,">> ",e("sandbox.quote_nested")),n.a.createElement("li",null,">>> ",e("sandbox.quote_nested")),n.a.createElement("li",null,">>>> ",e("sandbox.quote_nested"))),n.a.createElement("h4",null,e("sandbox.table")),n.a.createElement("pre",{className:"border-0"},"|Left|Mid|Right|",n.a.createElement("br",null),"|:----------|:---------:|----------:|",n.a.createElement("br",null),"|col 1|col 2|col 3|",n.a.createElement("br",null),"|col 1|col 2|col 3|",n.a.createElement("br",null)),n.a.createElement("h4",null,e("sandbox.image")),n.a.createElement("p",{className:"mb-1"},n.a.createElement("code",null," ![",e("sandbox.alt_text"),"](URL)")," ",e("sandbox.insert_image")),n.a.createElement("ul",{className:"hljs"},n.a.createElement("li",null,"![ex](https://example.com/image.png)")),n.a.createElement("hr",null),n.a.createElement("a",{href:"/Sandbox",className:"btn btn-info btn-block",target:"_blank"},n.a.createElement("i",{className:"icon-share-alt"})," ",e("sandbox.open_sandbox"))))}}p.propTypes={t:r.a.func.isRequired};var m=Object(h.c)()(p);class u extends n.a.Component{constructor(e){super(e),this.forceToFocus=this.forceToFocus.bind(this),this.setCaretLine=this.setCaretLine.bind(this),this.setScrollTopByLine=this.setScrollTopByLine.bind(this),this.getStrFromBol=this.getStrFromBol.bind(this),this.getStrToEol=this.getStrToEol.bind(this),this.insertText=this.insertText.bind(this),this.insertLinebreak=this.insertLinebreak.bind(this),this.dispatchSave=this.dispatchSave.bind(this)}forceToFocus(){}setValue(e){}setGfmMode(e){}setCaretLine(e){}setScrollTopByLine(e){}getStrFromBol(){throw new Error("this method should be impelemented in subclass")}getStrToEol(){throw new Error("this method should be impelemented in subclass")}getStrFromBolToSelectedUpperPos(){throw new Error("this method should be impelemented in subclass")}replaceBolToCurrentPos(e){throw new Error("this method should be impelemented in subclass")}replaceLine(e){throw new Error("this method should be impelemented in subclass")}insertText(e){}insertLinebreak(){this.insertText("\n")}dispatchSave(){null!=this.props.onSave&&this.props.onSave()}dispatchPasteFiles(e){null!=this.props.onPasteFiles&&this.props.onPasteFiles(e)}getNavbarItems(){return null}}u.propTypes={value:r.a.string,isGfmMode:r.a.bool,onChange:r.a.func,onScroll:r.a.func,onScrollCursorIntoView:r.a.func,onSave:r.a.func,onPasteFiles:r.a.func,onDragEnter:r.a.func,onCtrlEnter:r.a.func},u.defaultProps={isGfmMode:!0};var g=a("./node_modules/react-bootstrap/es/Button.js"),f=a("./node_modules/url-join/lib/url-join.js"),b=a.n(f),E=a("./node_modules/codemirror/lib/codemirror.js"),C=a("./node_modules/react-codemirror2/index.js"),v=a("./src/lib/service/interceptor-manager.js"),w=a.n(v);class y extends n.a.Component{render(){const{t:e}=this.props;return n.a.createElement("div",{className:"panel panel-default gfm-cheatsheet mb-0"},n.a.createElement("div",{className:"panel-body small p-b-0"},n.a.createElement("div",{className:"row"},n.a.createElement("div",{className:"col-xs-6"},n.a.createElement("p",null,"# ",e("sandbox.header_x",{index:"1"}),n.a.createElement("br",null),"## ",e("sandbox.header_x",{index:"2"})),n.a.createElement("p",null,n.a.createElement("i",null,"*",e("sandbox.italics"),"*"),"",n.a.createElement("b",null,"**",e("sandbox.bold"),"**")),n.a.createElement("p",null,"[",e("sandbox.link"),"](http://..)",n.a.createElement("br",null),"[/Page1/ChildPage1]"),n.a.createElement("p",null,"```javascript:index.js",n.a.createElement("br",null),"writeCode();",n.a.createElement("br",null),"```")),n.a.createElement("div",{className:"col-xs-6"},n.a.createElement("p",null,"- ",e("sandbox.unordered_list_x",{index:"1"}),n.a.createElement("br",null),"- ",e("sandbox.unordered_list_x",{index:"1.1"}),n.a.createElement("br",null),"- ",e("sandbox.unordered_list_x",{index:"2"}),n.a.createElement("br",null),"1. ",e("sandbox.ordered_list_x",{index:"1"}),n.a.createElement("br",null),"1. ",e("sandbox.ordered_list_x",{index:"2"})),n.a.createElement("hr",null),n.a.createElement("p",null,"[ ][ ] ",e("sandbox.block_detail"))))))}}y.propTypes={t:r.a.func.isRequired};var k=Object(h.c)()(y),x=a("./node_modules/attr-accept/dist/index.js"),j=a.n(x);const S=new class{constructor(){this.indentAndMarkRE=/^(\s*)(>[> ]*|[*+-] \[[x ]\]\s|[*+-]\s|(\d+)([.)]))(\s*)/,this.indentAndMarkOnlyRE=/^(\s*)(>[> ]*|[*+-] \[[x ]\]|[*+-]|(\d+)[.)])(\s*)$/,this.newlineAndIndentContinueMarkdownList=this.newlineAndIndentContinueMarkdownList.bind(this),this.pasteText=this.pasteText.bind(this)}newlineAndIndentContinueMarkdownList(e){const t=e.getStrFromBol();if(this.indentAndMarkOnlyRE.test(t))e.replaceBolToCurrentPos("\n");else if(this.indentAndMarkRE.test(t)){const a=t.match(this.indentAndMarkRE)[0];e.insertText(`\n${a}`)}else e.insertLinebreak()}pasteText(e,t,a){const s=e.getStrFromBolToSelectedUpperPos();if(this.indentAndMarkOnlyRE.test(s)){const n=this.adjustPastedData(s,a);null!=n&&(t.preventDefault(),e.replaceBolToCurrentPos(n))}}adjustPastedData(e,t){let a=null;if(t.match(this.indentAndMarkRE)){const s=e.match(this.indentAndMarkRE)[1];a=t.match(/[^\r\n]+/g).map(e=>s+e).join("\n")}else if(this.isListfulData(t));else{a=e+t.replace(/(\r\n|\r|\n)/g,`$1${e}`)}return a}isListfulData(e){if(null!=e.match(/^\s*[\r\n]/m))return!1;const t=e.match(/[^\r\n]+/g);let a=!1,s=0;return t.forEach(e=>{e.match(this.indentAndMarkRE)&&s++,s>=t.length/2&&(a=!0)}),a}};Object.freeze(S);var L=S;const M=new class{constructor(){this.pasteText=this.pasteText.bind(this)}pasteText(e,t){const a=t.clipboardData.getData("text/plain");0!==a.length&&L.pasteText(e,t,a)}isAcceptableType(e,t){return"application/x-moz-file"===e.type||j()(e,t)}};Object.freeze(M);var T=M,R=a("./node_modules/codemirror/src/line/saw_special_spans.js"),P=a("./node_modules/codemirror/src/line/utils_line.js"),D=a("./node_modules/codemirror/src/line/spans.js"),H=a("./node_modules/codemirror/src/display/update_display.js"),N=a("./node_modules/codemirror/src/display/view_tracking.js");var O=class{static forceUpdateViewOffset(e){const t=e.doc,a=e.display,s=new H.a(e,e.getViewport()),n=t.first+t.size;let i=Math.max(s.visible.from-e.options.viewportMargin,t.first),r=Math.min(n,s.visible.to+e.options.viewportMargin);a.viewFrom<i&&i-a.viewFrom<20&&(i=Math.max(t.first,a.viewFrom)),a.viewTo>r&&a.viewTo-r<20&&(r=Math.min(n,a.viewTo)),R.a&&(i=Object(D.k)(e.doc,i),r=Object(D.j)(e.doc,r)),Object(N.a)(e,i,r),a.viewOffset=Object(D.f)(Object(P.a)(t,a.viewFrom))}};var I=class{constructor(e){this.emojiStrategy=e,this.emojiShortnameImageMap={},this.initEmojiImageMap=this.initEmojiImageMap.bind(this),this.showHint=this.showHint.bind(this),this.initEmojiImageMap()}initEmojiImageMap(){for(const e of Object.values(this.emojiStrategy)){const t=e.shortname;this.emojiShortnameImageMap[t]=emojione.shortnameToImage(t)}}showHint(e){const t=e.getCursor(),a=e.getSearchCursor(/:[^:\s]+/,t,{multiline:!1});if(a.findPrevious()){if(!(t.line===a.to().line&&t.ch===a.to().ch))return;O.forceUpdateViewOffset(e),e.showHint({completeSingle:!1,hint:()=>{const t=e.getDoc().getRange(a.from(),a.to()).replace(":",""),s=this.searchEmojiShortnames(t);if(s.length>=1)return{list:this.generateEmojiRenderer(s),from:a.from(),to:a.to()}}})}}generateEmojiRenderer(e){return e.map(e=>({text:e,className:"crowi-emoji-autocomplete",render:t=>{t.innerHTML=`<div class="img-container">${this.emojiShortnameImageMap[e]}</div>`+`<span class="shortname-container">${e}</span>`}}))}searchEmojiShortnames(e){const t=[],a=[],s=[],n=[],i=()=>t.length,r=()=>i()+a.length,o=()=>r()+s.length,l=()=>o()+n.length;for(const c of Object.values(this.emojiStrategy)){if(12<=i())break;c.shortname.indexOf(`:${e}`)>-1?t.push(c.shortname):12<=r()||(c.shortname.indexOf(e)>-1?a.push(c.shortname):12<=o()||(null!=c.aliases&&c.aliases.find(t=>t.indexOf(e)>-1)?s.push(c.shortname):12<=l()||null!=c.keywords&&c.keywords.find(t=>t.indexOf(e)>-1)&&n.push(c.shortname)))}let c=t.concat(a).concat(s).concat(n);return c=c.slice(0,12)}},_=a("./node_modules/growi-commons/src/index.js");class B extends _.BasicInterceptor{isInterceptWhen(e){return"preHandleEnter"===e}isProcessableParallel(){return!1}process(e,...t){const a=Object.assign(t[0]),s=a.editor,n=s.getStrToEol();return L.indentAndMarkRE.test(n)&&(s.insertLinebreak(),a.handlers.push(this.className)),Promise.resolve(a)}}var U=a("./src/client/js/components/PageEditor/MarkdownTableUtil.js"),A=a("./src/client/js/models/MarkdownTable.js");class F extends _.BasicInterceptor{isInterceptWhen(e){return"preHandleEnter"===e}isProcessableParallel(){return!1}addRow(e){const t=U.a.getStrFromBot(e);let a=A.a.fromMarkdownString(t);U.a.addRowToMarkdownTable(a);const s=U.a.getStrToEot(e),n=A.a.fromMarkdownString(s);n.table.length>0&&(a=U.a.mergeMarkdownTable([a,n])),U.a.replaceMarkdownTableWithReformed(e,a)}reformTable(e){const t=U.a.getStrFromBot(e)+U.a.getStrToEot(e),a=A.a.fromMarkdownString(t);U.a.replaceMarkdownTableWithReformed(e,a)}removeRow(e){e.replaceLine("\n")}async process(e,...t){const a=Object.assign(t[0]),s=a.editor;if(null==s||null==s.getCodeMirror())return a;const n=s.getCodeMirror(),i=U.a.isInTable(n),r=U.a.getStrToEot(n)===s.getStrToEol();return i?(U.a.isEndOfLine(n)?this.addRow(n):r&&U.a.emptyLineOfTableRE.test(s.getStrFromBol()+s.getStrToEol())?this.removeRow(s):this.reformTable(n),a.handlers.push(this.className),a):void 0}}var z=a("./src/client/js/components/PageEditor/MarkdownDrawioUtil.js"),q=a("./src/client/js/components/PageEditor/HandsontableModal.jsx");const G=e=>{switch(e.icon){case"Bold":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 10.9 14"},n.a.createElement("path",{d:"M0 0h5.6c3 0 4.7 1.1 4.7 3.4a3.1 3.1 0 0 1-2.5 3.1 3.7 3.7 0 0 1 3.1 3.5c0 2.9-1.4 4-4.2 4H0zm5.2 6.5c2.7 0 2.6-1.4 2.6-3.1S7.9.7 5.6.7H2.3v5.8zm-2.9 6.6h3.4c2.1 0 2.7-1.1 2.7-3.1s0-2.8-3.2-2.8H2.3z"}));case"Italic":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 8.6 13.9"},n.a.createElement("path",{d:"M8.1 0a.6.6 0 0 1 .5.6c0 .3-.2.6-.7.6H6.2L3.8 12.8h1.8c.2 0 .4.3.4.5a.7.7 0 0 1-.7.6H.5c-.3 0-.5-.4-.5-.6s.4-.6.7-.6h1.7L4.9 1.2H3.1a.5.5 0 0 1-.5-.5c0-.3.1-.7.8-.7z"}));case"Strikethrough":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 19.5 14"},n.a.createElement("path",{d:"M5.8 6.2H9C7.2 5.7 6.3 5 6.3 3.8a2.2 2.2 0 0 1 .9-1.9 4.3 4.3 0 0 1 2.5-.7 4.3 4.3 0 0 1 2.5.7 3.1 3.1 0 0 1 1.1 1.6.7.7 0 0 0 .6.4h.3a.7.7 0 0 0 .4-.8A3.6 3.6 0 0 0 13.1 1a6.7 6.7 0 0 0-6-.5 3.1 3.1 0 0 0-1.7 1.3 3.6 3.6 0 0 0-.6 2 2.9 2.9 0 0 0 1 2.3zm7 2.5a2 2 0 0 1 .6 1.4 2.4 2.4 0 0 1-1 1.9 3.7 3.7 0 0 1-2.5.7 4.6 4.6 0 0 1-3-.8 3.7 3.7 0 0 1-1.2-2 .6.6 0 0 0-.6-.5h-.2a.7.7 0 0 0-.5.8 4.1 4.1 0 0 0 1.5 2.5A6 6 0 0 0 9.8 14a7.5 7.5 0 0 0 2.6-.5 4.9 4.9 0 0 0 1.8-1.4 4.3 4.3 0 0 0 .6-2.2 5 5 0 0 0-.2-1.2zM.4 7.9a.7.7 0 0 1-.4-.5.4.4 0 0 1 .4-.4h18.8a.4.4 0 0 1 .3.6c0 .1-.1.2-.2.3z"}));case"Heading":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 13.7 14"},n.a.createElement("path",{d:"M10.2 0h2.9a.6.6 0 0 1 .6.6.6.6 0 0 1-.6.6h-.8v11.6h.8a.6.6 0 0 1 .6.6.6.6 0 0 1-.6.6h-2.9a.6.6 0 0 1-.6-.6.6.6 0 0 1 .6-.6h.8V7.2H2.7v5.6h.8a.6.6 0 0 1 .6.6.6.6 0 0 1-.6.6H.6a.6.6 0 0 1-.6-.6.6.6 0 0 1 .6-.6h.7V1.2H.6A.6.6 0 0 1 0 .6.6.6 0 0 1 .6 0h2.9a.6.6 0 0 1 .6.6.6.6 0 0 1-.6.6h-.8v4.9H11V1.2h-.8a.6.6 0 0 1-.6-.6.6.6 0 0 1 .6-.6z"}));case"InlineCode":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 18.1 14"},n.a.createElement("path",{d:"M17.8 7.9l-4 3.8a.5.5 0 0 1-.8 0 .5.5 0 0 1 0-.8L16.8 7 13 3.2a.6.6 0 0 1 0-.9.5.5 0 0 1 .8 0l4 3.8a1.3 1.3 0 0 1 0 1.8zM5.2 2.3a.7.7 0 0 1 0 .9L1.3 7l3.9 3.9a.6.6 0 0 1 0 .8.6.6 0 0 1-.9 0L.4 7.9a1.3 1.3 0 0 1 0-1.8l3.9-3.8a.6.6 0 0 1 .9 0zM11.5.8L7.8 13.6a.6.6 0 0 1-.7.4.6.6 0 0 1-.5-.8L10.3.4a.7.7 0 0 1 .8-.4.6.6 0 0 1 .4.8z"}));case"Quote":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 17 12"},n.a.createElement("path",{d:"M5 0H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h3a1.7 1.7 0 0 0 1-.3V10a.9.9 0 0 1-1 1H3v1h2a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 6H2a.9.9 0 0 1-1-1V2a.9.9 0 0 1 1-1h3a.9.9 0 0 1 1 1v3a.9.9 0 0 1-1 1zm10-6h-3a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h3a1.7 1.7 0 0 0 1-.3V10a.9.9 0 0 1-1 1h-2v1h2a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 6h-3a.9.9 0 0 1-1-1V2a.9.9 0 0 1 1-1h3a.9.9 0 0 1 1 1v3a.9.9 0 0 1-1 1z"}));case"List":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 21.6 13.5"},n.a.createElement("path",{d:"M6.4 1.5h14.5a.7.7 0 0 0 .7-.7.7.7 0 0 0-.7-.7H6.4a.8.8 0 0 0-.8.7.8.8 0 0 0 .8.7zm0 6h14.5a.7.7 0 0 0 .7-.7.7.7 0 0 0-.7-.7H6.4a.8.8 0 0 0-.8.7.8.8 0 0 0 .8.7zm0 6h14.5a.7.7 0 0 0 .7-.7.7.7 0 0 0-.7-.7H6.4a.8.8 0 0 0-.8.7.8.8 0 0 0 .8.7zM.9 1.5h1a.8.8 0 0 0 .9-.7.8.8 0 0 0-.9-.8h-1a.8.8 0 0 0-.9.7.8.8 0 0 0 .9.8zm0 6h1a.8.8 0 0 0 .9-.7.8.8 0 0 0-.9-.8h-1a.8.8 0 0 0-.9.7.8.8 0 0 0 .9.8zm0 6h1a.8.8 0 0 0 .9-.7.8.8 0 0 0-.9-.7h-1a.8.8 0 0 0-.9.7.8.8 0 0 0 .9.7z"}));case"NumberedList":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 23.7 16"},n.a.createElement("path",{d:"M23.7 2a.8.8 0 0 1-.8.8H6.6a.8.8 0 0 1-.7-.8.7.7 0 0 1 .7-.7h16.3a.7.7 0 0 1 .8.7zM6.6 8.7h16.3a.7.7 0 0 0 .8-.7.8.8 0 0 0-.8-.8H6.6a.8.8 0 0 0-.7.8.7.7 0 0 0 .7.7zm0 5.9h16.3a.7.7 0 0 0 .8-.7.7.7 0 0 0-.8-.7H6.6a.7.7 0 0 0-.7.7.7.7 0 0 0 .7.7zM1.5.5V4h.6V0h-.5L.7.5v.4l.8-.4zM.9 9.6l.3-.3c.9-.9 1.4-1.5 1.4-2.2a1.2 1.2 0 0 0-1.3-1.2h-.1a1.4 1.4 0 0 0-1.2.6l.3.4a1.2 1.2 0 0 1 .9-.5.6.6 0 0 1 .8.6v.2c0 .6-.4 1.1-1.5 2.1l-.4.4v.3h2.6v-.4zm.9 4.1a1 1 0 0 0 .7-.9 1 1 0 0 0-1.1-1 2 2 0 0 0-1.1.3v.4l.8-.2c.5 0 .8.2.8.6s-.5.7-.9.7H.7v.4H1c.6 0 1.1.2 1.1.8a.8.8 0 0 1-.9.8l-.9-.3-.2.4a2 2 0 0 0 1.1.3c1 0 1.5-.6 1.5-1.2a1.2 1.2 0 0 0-.9-1.1z"}));case"CheckList":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 14.4 16"},n.a.createElement("path",{d:"M13.9 5.5a.5.5 0 0 1 .5.5v9a1.1 1.1 0 0 1-1.1 1H1a1.1 1.1 0 0 1-1-1V2.6a1.1 1.1 0 0 1 1-1h7.1a.5.5 0 0 1 .5.5.5.5 0 0 1-.5.5H1V15h12.3V6a.6.6 0 0 1 .6-.5zM3.6 8.3a.5.5 0 0 0 0 .7l2.5 2.5a.8.8 0 0 0 1.1 0h.1l7-10.7c.1-.2.1-.6-.2-.7a.5.5 0 0 0-.7.1L6.6 10.6 4.3 8.3a.5.5 0 0 0-.7 0z"}));case"Link":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 16 16"},n.a.createElement("path",{d:"M4.6 11.4l.4.2h.2v-.2l6.1-6.1a.4.4 0 0 0 .1-.3.5.5 0 0 0-.5-.5h-.3l-6 6.2a.6.6 0 0 0-.1.4c0 .1 0 .3.1.3zm2.8-1a2 2 0 0 1 0 1.1 4.1 4.1 0 0 1-.5.9l-2.1 1.9a1.9 1.9 0 0 1-1.5.7 2 2 0 0 1-1.6-.7 1.9 1.9 0 0 1-.7-1.5 2 2 0 0 1 .7-1.6l1.9-2.1a2 2 0 0 1 2.2-.5l.8-.8a3.2 3.2 0 0 0-1.4-.3 3.3 3.3 0 0 0-2.3.9L1 10.5A3.2 3.2 0 0 0 .9 15H1a2.9 2.9 0 0 0 2.3 1 3.2 3.2 0 0 0 2.3-1l2-1.9a4.6 4.6 0 0 0 .9-1.7 2.9 2.9 0 0 0-.3-1.8zM15 1a2.5 2.5 0 0 0-1-.8 3.1 3.1 0 0 0-3.5.8L8.4 2.9a3.1 3.1 0 0 0-.9 1.8 3.2 3.2 0 0 0 .3 1.9l.8-.8a2 2 0 0 1 0-1.1 2.2 2.2 0 0 1 .5-1.1l2.1-1.9.3-.3.4-.2.4-.2h.5a1.9 1.9 0 0 1 1.5.7 2 2 0 0 1 .7 1.6 1.9 1.9 0 0 1-.7 1.5l-2 2.1-.7.4a1.5 1.5 0 0 1-.9.2h-.4l-.8.8H12l1-.7 2-2.1A3 3 0 0 0 15 1z"}));case"Image":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 19 16"},n.a.createElement("path",{d:"M17.8 0H1.2A1.2 1.2 0 0 0 0 1.2v13.6A1.2 1.2 0 0 0 1.2 16h16.6a1.2 1.2 0 0 0 1.2-1.2V1.2a1.4 1.4 0 0 0-.2-.6.8.8 0 0 0-.4-.4zm0 14.8H1.2v-3.5l4.7-4.6 5 4.9.3.2.5-.2 2.1-1.9 3.9 4h.1v1.1zm0-2.8l-3.5-3.5-.4-.2h-.4l-2.2 2-4.9-4.8-.4-.2c-.2 0-.4 0-.5.2L1.2 9.7V1.2h16.6V12zm-4.2-6.1h.6a1.1 1.1 0 0 0 .6-1.1 1.2 1.2 0 0 0-1.2-1.1 1.3 1.3 0 0 0-1.2 1.2 1.2 1.2 0 0 0 .4.8 1.1 1.1 0 0 0 .8.3z"}));case"Table":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 20.3 16"},n.a.createElement("path",{d:"M19.1 16H1.2A1.2 1.2 0 0 1 0 14.8V1.2A1.2 1.2 0 0 1 1.2 0h17.9a1.2 1.2 0 0 1 1.2 1.2v13.6a1.2 1.2 0 0 1-1.2 1.2zm-5.2-4.3v3.2h5.3v-3.2zm-6.4 0v3.2h5.3v-3.2zm-6.4 0v3.2h5.3v-3.2zm12.8-4.2v3.2h5.3V7.5zm-6.4 0v3.2h5.3V7.5zm-6.4 0v3.2h5.3V7.5zm12.8-4.3v3.2h5.3V3.2zm-6.4 0v3.2h5.3V3.2zm-6.4 0v3.2h5.3V3.2z"}));case"Drawio":return n.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"13",viewBox:"0 0 20.3 16"},n.a.createElement("path",{d:"M11.76 0L11.78 0.01L11.8 0.02L11.83 0.02L11.85 0.03L11.87 0.05L11.89 0.06L11.91 0.07L11.92 0.09L11.94 0.11L11.95 0.12L11.97 0.14L11.98 0.16L11.99 0.19L12 0.21L12 0.23L12.01 0.25L12.01 0.28L12.01 0.3L12.01 4.94L12.01 4.97L12.01 4.99L12 5.01L12 5.04L11.99 5.06L11.98 5.08L11.97 5.1L11.95 5.12L11.94 5.14L11.92 5.16L11.91 5.17L11.89 5.19L11.87 5.2L11.85 5.21L11.83 5.22L11.8 5.23L11.78 5.24L11.76 5.24L11.73 5.24L11.71 5.24L8.3 5.24L8.3 7.1L13.16 7.1L13.19 7.1L13.21 7.1L13.24 7.11L13.26 7.11L13.28 7.12L13.3 7.13L13.32 7.14L13.34 7.16L13.36 7.17L13.38 7.19L13.4 7.21L13.41 7.22L13.42 7.24L13.43 7.26L13.44 7.28L13.45 7.31L13.46 7.33L13.46 7.35L13.47 7.38L13.47 7.4L13.47 10.08L15.7 10.08L15.72 10.08L15.75 10.08L15.77 10.08L15.79 10.09L15.81 10.1L15.84 10.11L15.86 10.12L15.88 10.13L15.89 10.15L15.91 10.16L15.93 10.18L15.94 10.2L15.95 10.22L15.97 10.24L15.98 10.26L15.98 10.28L15.99 10.31L16 10.33L16 10.35L16 10.38L16 15.02L16 15.04L16 15.07L15.99 15.09L15.98 15.11L15.98 15.13L15.97 15.16L15.95 15.18L15.94 15.2L15.93 15.21L15.91 15.23L15.89 15.25L15.88 15.26L15.86 15.27L15.84 15.29L15.81 15.3L15.79 15.3L15.77 15.31L15.75 15.32L15.72 15.32L15.7 15.32L10.63 15.32L10.61 15.32L10.58 15.32L10.56 15.31L10.54 15.3L10.51 15.3L10.49 15.29L10.47 15.27L10.45 15.26L10.44 15.25L10.42 15.23L10.4 15.21L10.39 15.2L10.37 15.18L10.36 15.16L10.35 15.13L10.34 15.11L10.34 15.09L10.33 15.07L10.33 15.04L10.33 15.02L10.33 10.38L10.33 10.35L10.33 10.33L10.34 10.31L10.34 10.28L10.35 10.26L10.36 10.24L10.37 10.22L10.39 10.2L10.4 10.18L10.42 10.16L10.44 10.15L10.45 10.13L10.47 10.12L10.49 10.11L10.51 10.1L10.54 10.09L10.56 10.08L10.58 10.08L10.61 10.08L10.63 10.08L12.86 10.08L12.86 7.71L3.14 7.71L3.14 10.08L5.37 10.08L5.39 10.08L5.42 10.08L5.44 10.08L5.46 10.09L5.49 10.1L5.51 10.11L5.53 10.12L5.55 10.13L5.56 10.15L5.58 10.16L5.6 10.18L5.61 10.2L5.63 10.22L5.64 10.24L5.65 10.26L5.66 10.28L5.66 10.31L5.67 10.33L5.67 10.35L5.67 10.38L5.67 15.02L5.67 15.04L5.67 15.07L5.66 15.09L5.66 15.11L5.65 15.13L5.64 15.16L5.63 15.18L5.61 15.2L5.6 15.21L5.58 15.23L5.56 15.25L5.55 15.26L5.53 15.27L5.51 15.29L5.49 15.3L5.46 15.3L5.44 15.31L5.42 15.32L5.39 15.32L5.37 15.32L0.3 15.32L0.28 15.32L0.25 15.32L0.23 15.31L0.21 15.3L0.19 15.3L0.16 15.29L0.14 15.27L0.12 15.26L0.11 15.25L0.09 15.23L0.07 15.21L0.06 15.2L0.05 15.18L0.03 15.16L0.02 15.13L0.02 15.11L0.01 15.09L0 15.07L0 15.04L0 15.02L0 10.38L0 10.35L0 10.33L0.01 10.31L0.02 10.28L0.02 10.26L0.03 10.24L0.05 10.22L0.06 10.2L0.07 10.18L0.09 10.16L0.11 10.15L0.12 10.13L0.14 10.12L0.16 10.11L0.19 10.1L0.21 10.09L0.23 10.08L0.25 10.08L0.28 10.08L0.3 10.08L2.53 10.08L2.53 7.4L2.53 7.38L2.54 7.35L2.54 7.33L2.55 7.31L2.56 7.28L2.57 7.26L2.58 7.24L2.59 7.22L2.6 7.21L2.62 7.19L2.64 7.17L2.66 7.16L2.68 7.14L2.7 7.13L2.72 7.12L2.74 7.11L2.76 7.11L2.79 7.1L2.81 7.1L2.84 7.1L7.7 7.1L7.7 5.24L4.29 5.24L4.27 5.24L4.24 5.24L4.22 5.24L4.2 5.23L4.17 5.22L4.15 5.21L4.13 5.2L4.11 5.19L4.09 5.17L4.08 5.16L4.06 5.14L4.05 5.12L4.03 5.1L4.02 5.08L4.01 5.06L4 5.04L4 5.01L3.99 4.99L3.99 4.97L3.99 4.94L3.99 0.3L3.99 0.28L3.99 0.25L4 0.23L4 0.21L4.01 0.19L4.02 0.16L4.03 0.14L4.05 0.12L4.06 0.11L4.08 0.09L4.09 0.07L4.11 0.06L4.13 0.05L4.15 0.03L4.17 0.02L4.2 0.02L4.22 0.01L4.24 0L4.27 0L4.29 0L11.71 0L11.73 0L11.76 0ZM0.61 14.71L5.06 14.71L5.06 10.68L0.61 10.68L0.61 14.71ZM10.94 14.71L15.39 14.71L15.39 10.68L10.94 10.68L10.94 14.71ZM4.6 4.64L11.4 4.64L11.4 0.61L4.6 0.61L4.6 4.64Z",id:"a1rZaAznW0"}))}};G.propTypes={icon:r.a.string.isRequired};var W=G,$=a("./src/client/js/components/PageEditor/DrawioModal.jsx");const K=a("./node_modules/simple-load-script/simpleLoadScript.js"),V=a("./node_modules/load-css-file/index.js");E.commands.save=e=>{null!=e.codeMirrorEditor&&e.codeMirrorEditor.dispatchSave()},window.CodeMirror=a("./node_modules/codemirror/lib/codemirror.js"),a("./node_modules/codemirror/addon/display/placeholder.js"),a("./node_modules/codemirror/addon/edit/matchbrackets.js"),a("./node_modules/codemirror/addon/edit/matchtags.js"),a("./node_modules/codemirror/addon/edit/closetag.js"),a("./node_modules/codemirror/addon/edit/continuelist.js"),a("./node_modules/codemirror/addon/hint/show-hint.js"),a("./node_modules/codemirror/addon/hint/show-hint.css"),a("./node_modules/codemirror/addon/search/searchcursor.js"),a("./node_modules/codemirror/addon/search/match-highlighter.js"),a("./node_modules/codemirror/addon/selection/active-line.js"),a("./node_modules/codemirror/addon/scroll/annotatescrollbar.js"),a("./node_modules/codemirror/addon/fold/foldcode.js"),a("./node_modules/codemirror/addon/fold/foldgutter.js"),a("./node_modules/codemirror/addon/fold/foldgutter.css"),a("./node_modules/codemirror/addon/fold/markdown-fold.js"),a("./node_modules/codemirror/addon/fold/brace-fold.js"),a("./node_modules/codemirror/addon/display/placeholder.js"),a("./node_modules/codemirror/mode/gfm/gfm.js"),a("./src/client/js/util/codemirror/autorefresh.ext.js");const J="markdown-table-activated";class Y extends u{constructor(e){super(e),this.logger=a("./src/lib/service/logger/index.js")("growi:PageEditor:CodeMirrorEditor"),this.state={value:this.props.value,isGfmMode:this.props.isGfmMode,isEnabledEmojiAutoComplete:!1,isLoadingKeymap:!1,isSimpleCheatsheetShown:this.props.isGfmMode&&0===this.props.value.length,isCheatsheetModalShown:!1,additionalClassSet:new Set},this.init(),this.getCodeMirror=this.getCodeMirror.bind(this),this.getBol=this.getBol.bind(this),this.getEol=this.getEol.bind(this),this.loadTheme=this.loadTheme.bind(this),this.loadKeymapMode=this.loadKeymapMode.bind(this),this.setKeymapMode=this.setKeymapMode.bind(this),this.handleEnterKey=this.handleEnterKey.bind(this),this.handleCtrlEnterKey=this.handleCtrlEnterKey.bind(this),this.scrollCursorIntoViewHandler=this.scrollCursorIntoViewHandler.bind(this),this.pasteHandler=this.pasteHandler.bind(this),this.cursorHandler=this.cursorHandler.bind(this),this.changeHandler=this.changeHandler.bind(this),this.updateCheatsheetStates=this.updateCheatsheetStates.bind(this),this.renderLoadingKeymapOverlay=this.renderLoadingKeymapOverlay.bind(this),this.renderCheatsheetModalButton=this.renderCheatsheetModalButton.bind(this),this.makeHeaderHandler=this.makeHeaderHandler.bind(this),this.showHandsonTableHandler=this.showHandsonTableHandler.bind(this),this.showDrawioHandler=this.showDrawioHandler.bind(this)}init(){this.cmCdnRoot="https://cdn.jsdelivr.net/npm/codemirror@5.42.0",this.cmNoCdnScriptRoot="/js/cdn",this.cmNoCdnStyleRoot="/styles/cdn",this.interceptorManager=new w.a,this.interceptorManager.addInterceptors([new B,new F]),this.loadedThemeSet=new Set(["eclipse","elegant"]),this.loadedKeymapSet=new Set}componentWillMount(){null!=this.props.emojiStrategy&&(this.emojiAutoCompleteHelper=new I(this.props.emojiStrategy),this.setState({isEnabledEmojiAutoComplete:!0}))}componentDidMount(){this.getCodeMirror().codeMirrorEditor=this;const e=this.props.editorOptions.theme;this.loadTheme(e);const t=this.props.editorOptions.keymapMode;this.setKeymapMode(t)}componentWillReceiveProps(e){const t=e.editorOptions.theme;this.loadTheme(t);const a=e.editorOptions.keymapMode;this.setKeymapMode(a)}getCodeMirror(){return this.cm.editor}forceToFocus(){const e=this.getCodeMirror(),t=setInterval(()=>{this.getCodeMirror().focus(),e.hasFocus()&&(clearInterval(t),e.refresh())},100)}setValue(e){this.setState({value:e}),this.getCodeMirror().getDoc().setValue(e)}setGfmMode(e){this.setState({isGfmMode:e,isEnabledEmojiAutoComplete:e}),this.updateCheatsheetStates(e,null);const t=e?"gfm":void 0;this.getCodeMirror().setOption("mode",t)}setCaretLine(e){if(Number.isNaN(e))return;const t=this.getCodeMirror(),a=Math.max(0,e);t.setCursor({line:a}),this.setScrollTopByLine(a)}setScrollTopByLine(e){if(Number.isNaN(e))return;const t=this.getCodeMirror(),a=t.charCoords({line:e,ch:0},"local").top;t.scrollTo(null,a)}getStrFromBol(){const e=this.getCodeMirror(),t=e.getCursor();return e.getDoc().getRange(this.getBol(),t)}getStrToEol(){const e=this.getCodeMirror(),t=e.getCursor();return e.getDoc().getRange(t,this.getEol())}getStrFromBolToSelectedUpperPos(){const e=this.getCodeMirror(),t=this.selectUpperPos(e.getCursor("from"),e.getCursor("to"));return e.getDoc().getRange(this.getBol(),t)}replaceBolToCurrentPos(e){const t=this.getCodeMirror(),a=this.selectLowerPos(t.getCursor("from"),t.getCursor("to"));t.getDoc().replaceRange(e,this.getBol(),a)}replaceLine(e){this.getCodeMirror().getDoc().replaceRange(e,this.getBol(),this.getEol())}insertText(e){this.getCodeMirror().getDoc().replaceSelection(e)}getBol(){return{line:this.getCodeMirror().getCursor().line,ch:0}}getEol(){const e=this.getCodeMirror(),t=e.getCursor(),a=e.getDoc().getLine(t.line).length;return{line:t.line,ch:a}}selectUpperPos(e,t){return e.line===t.line?e.ch<t.ch?e:t:e.line<t.line?e:t}selectLowerPos(e,t){return e.line===t.line?e.ch<t.ch?t:e:e.line<t.line?t:e}loadCss(e){return new Promise(t=>{V(e),t()})}loadTheme(e){if(!this.loadedThemeSet.has(e)){const t=this.props.noCdn?b()(this.cmNoCdnStyleRoot,`codemirror-theme-${e}.css`):b()(this.cmCdnRoot,`theme/${e}.min.css`);this.loadCss(t),this.loadedThemeSet.add(e)}}loadKeymapMode(e){const t=this.loadCss,a=[],s=[];if(0===this.loadedKeymapSet.size){const e=this.props.noCdn?b()(this.cmNoCdnScriptRoot,"codemirror-dialog.js"):b()(this.cmCdnRoot,"addon/dialog/dialog.min.js"),n=this.props.noCdn?b()(this.cmNoCdnStyleRoot,"codemirror-dialog.css"):b()(this.cmCdnRoot,"addon/dialog/dialog.min.css");a.push(K(e)),s.push(t(n))}if(!this.loadedKeymapSet.has(e)){const t=this.props.noCdn?b()(this.cmNoCdnScriptRoot,`codemirror-keymap-${e}.js`):b()(this.cmCdnRoot,`keymap/${e}.min.js`);a.push(K(t)),this.loadedKeymapSet.add(e)}return this.setState({isLoadingKeymap:!0}),Promise.all(a.concat(s)).then(()=>{this.setState({isLoadingKeymap:!1})})}setKeymapMode(e){e.match(/^(vim|emacs|sublime)$/)?this.loadKeymapMode(e).then(()=>{let t=0;const a=setInterval(()=>{t>10&&(this.logger.error(`Timeout to load keyMap '${e}'`),clearInterval(a));try{this.getCodeMirror().setOption("keyMap",e),clearInterval(a)}catch(a){this.logger.info(`keyMap '${e}' has not been initialized. retry..`),t++}},300)}):this.getCodeMirror().setOption("keyMap","default")}handleEnterKey(){if(!this.state.isGfmMode)return void E.commands.newlineAndIndent(this.getCodeMirror());const e={handlers:[],editor:this};this.interceptorManager.process("preHandleEnter",e).then(()=>{0===e.handlers.length&&E.commands.newlineAndIndentContinueMarkdownList(this.getCodeMirror())})}handleCtrlEnterKey(){null!=this.props.onCtrlEnter&&this.props.onCtrlEnter()}scrollCursorIntoViewHandler(e,t){if(null!=this.props.onScrollCursorIntoView){const t=e.getCursor().line;this.props.onScrollCursorIntoView(t)}}cursorHandler(e,t){const{additionalClassSet:a}=this.state,s=a.has(J),n=U.a.isInTable(e);!s&&n&&(a.add(J),this.setState({additionalClassSet:a})),s&&!n&&(a.delete(J),this.setState({additionalClassSet:a}))}changeHandler(e,t,a){null!=this.props.onChange&&this.props.onChange(a),this.updateCheatsheetStates(null,a),this.state.isEnabledEmojiAutoComplete&&this.emojiAutoCompleteHelper.showHint(e)}pasteHandler(e,t){const a=t.clipboardData.types;a.includes("Files")?(t.preventDefault(),this.dispatchPasteFiles(t)):a.includes("text/plain")&&T.pasteText(this,t)}updateCheatsheetStates(e,t){const a=e||this.state.isGfmMode,s=t||this.getCodeMirror().getDoc().getValue(),n=a&&0===s.length;this.setState({isSimpleCheatsheetShown:n})}markdownHelpButtonClickedHandler(){null!=this.props.onMarkdownHelpButtonClicked&&this.props.onMarkdownHelpButtonClicked()}renderLoadingKeymapOverlay(){return this.state.isLoadingKeymap?n.a.createElement("div",{className:"overlay overlay-loading-keymap"},n.a.createElement("span",{style:{top:0,right:0,bottom:0,left:0},className:"overlay-content"},n.a.createElement("div",{className:"speeding-wheel d-inline-block"})," Loading Keymap ...")):""}renderCheatsheetModalButton(){return n.a.createElement("button",{type:"button",className:"btn-link gfm-cheatsheet-modal-link text-muted small p-0",onClick:()=>{this.markdownHelpButtonClickedHandler()}},n.a.createElement("i",{className:"icon-question"})," Markdown")}renderCheatsheetOverlay(){const e=this.renderCheatsheetModalButton();return n.a.createElement("div",{className:"overlay overlay-gfm-cheatsheet mt-1 p-3"},this.state.isSimpleCheatsheetShown?n.a.createElement("div",{className:"text-right"},e,n.a.createElement("div",{className:"mt-2"},n.a.createElement(k,null))):n.a.createElement("div",{className:"mr-4"},e))}createReplaceSelectionHandler(e,t){return()=>{const a=this.getCodeMirror(),s=a.getDoc().getSelection(),n=a.getCursor("from"),i=a.getCursor("to"),r={};r.line=i.line,n.line===i.line?r.ch=i.ch+e.length:r.ch=i.ch,a.getDoc().replaceSelection(e+s+t),a.setCursor(r),a.focus()}}createAddPrefixToEachLinesHandler(e){return()=>{const t=this.getCodeMirror(),a=t.getCursor("from").line,s=t.getCursor("to").line,n=[];for(let i=a;i<=s;i++)n.push(e+t.getDoc().getLine(i));const i=`${n.join("\n")}\n`;t.getDoc().replaceRange(i,{line:a,ch:0},{line:s+1,ch:0}),t.setCursor(s,t.getDoc().getLine(s).length),t.focus()}}makeHeaderHandler(){const e=this.getCodeMirror(),t=e.getCursor("from").line;let a="#";e.getDoc().getLine(t).startsWith("#")||(a+=" "),e.getDoc().replaceRange(a,{line:t,ch:0},{line:t,ch:0}),e.focus()}showHandsonTableHandler(){this.handsontableModal.show(U.a.getMarkdownTable(this.getCodeMirror()))}showDrawioHandler(){this.drawioIFrame.show(z.a.getMarkdownDrawioMxfile(this.getCodeMirror()))}getNavbarItems(){return[n.a.createElement(g.a,{key:"nav-item-bold",bsSize:"small",title:"Bold",onClick:this.createReplaceSelectionHandler("**","**")},n.a.createElement(W,{icon:"Bold"})),n.a.createElement(g.a,{key:"nav-item-italic",bsSize:"small",title:"Italic",onClick:this.createReplaceSelectionHandler("*","*")},n.a.createElement(W,{icon:"Italic"})),n.a.createElement(g.a,{key:"nav-item-strikethrough",bsSize:"small",title:"Strikethrough",onClick:this.createReplaceSelectionHandler("~~","~~")},n.a.createElement(W,{icon:"Strikethrough"})),n.a.createElement(g.a,{key:"nav-item-header",bsSize:"small",title:"Heading",onClick:this.makeHeaderHandler},n.a.createElement(W,{icon:"Heading"})),n.a.createElement(g.a,{key:"nav-item-code",bsSize:"small",title:"Inline Code",onClick:this.createReplaceSelectionHandler("`","`")},n.a.createElement(W,{icon:"InlineCode"})),n.a.createElement(g.a,{key:"nav-item-quote",bsSize:"small",title:"Quote",onClick:this.createAddPrefixToEachLinesHandler("> ")},n.a.createElement(W,{icon:"Quote"})),n.a.createElement(g.a,{key:"nav-item-ul",bsSize:"small",title:"List",onClick:this.createAddPrefixToEachLinesHandler("- ")},n.a.createElement(W,{icon:"List"})),n.a.createElement(g.a,{key:"nav-item-ol",bsSize:"small",title:"Numbered List",onClick:this.createAddPrefixToEachLinesHandler("1. ")},n.a.createElement(W,{icon:"NumberedList"})),n.a.createElement(g.a,{key:"nav-item-checkbox",bsSize:"small",title:"Check List",onClick:this.createAddPrefixToEachLinesHandler("- [ ] ")},n.a.createElement(W,{icon:"CheckList"})),n.a.createElement(g.a,{key:"nav-item-link",bsSize:"small",title:"Link",onClick:this.createReplaceSelectionHandler("[","]()")},n.a.createElement(W,{icon:"Link"})),n.a.createElement(g.a,{key:"nav-item-image",bsSize:"small",title:"Image",onClick:this.createReplaceSelectionHandler("![","]()")},n.a.createElement(W,{icon:"Image"})),n.a.createElement(g.a,{key:"nav-item-table",bsSize:"small",title:"Table",onClick:this.showHandsonTableHandler},n.a.createElement(W,{icon:"Table"})),n.a.createElement(g.a,{key:"nav-item-drawio",bsSize:"small",title:"draw.io",onClick:this.showDrawioHandler},n.a.createElement(W,{icon:"Drawio"}))]}render(){const e=this.state.isGfmMode?"gfm":void 0,t=Array.from(this.state.additionalClassSet).join(" "),a=this.state.isGfmMode?"Input with Markdown..":"Input with Plane Text..";return n.a.createElement(n.a.Fragment,null,n.a.createElement(C.UnControlled,{ref:e=>{this.cm=e},className:t,placeholder:"search",editorDidMount:e=>{e.on("paste",this.pasteHandler),e.on("scrollCursorIntoView",this.scrollCursorIntoViewHandler)},value:this.state.value,options:{mode:e,theme:this.props.editorOptions.theme,styleActiveLine:this.props.editorOptions.styleActiveLine,lineNumbers:this.props.lineNumbers,tabSize:4,indentUnit:4,lineWrapping:!0,autoRefresh:{force:!0},autoCloseTags:!0,placeholder:a,matchBrackets:!0,matchTags:{bothTags:!0},foldGutter:this.props.lineNumbers,gutters:this.props.lineNumbers?["CodeMirror-linenumbers","CodeMirror-foldgutter"]:[],highlightSelectionMatches:{annotateScrollbar:!0},highlightFormatting:!0,extraKeys:{Enter:this.handleEnterKey,"Ctrl-Enter":this.handleCtrlEnterKey,"Cmd-Enter":this.handleCtrlEnterKey,Tab:"indentMore","Shift-Tab":"indentLess","Ctrl-Q":e=>{e.foldCode(e.getCursor())}}},onCursor:this.cursorHandler,onScroll:(e,t)=>{if(null!=this.props.onScroll){const a=e.lineAtHeight(t.top,"local");t.line=a,this.props.onScroll(t)}},onChange:this.changeHandler,onDragEnter:(e,t)=>{null!=this.props.onDragEnter&&this.props.onDragEnter(t)}}),this.renderLoadingKeymapOverlay(),this.renderCheatsheetOverlay(),n.a.createElement(q.a,{ref:e=>{this.handsontableModal=e},onSave:e=>U.a.replaceFocusedMarkdownTableWithEditor(this.getCodeMirror(),e)}),n.a.createElement($.a,{ref:e=>{this.drawioIFrame=e},onSave:e=>z.a.replaceFocusedDrawioWithEditor(this.getCodeMirror(),e)}))}}Y.propTypes=Object.assign({editorOptions:r.a.object.isRequired,emojiStrategy:r.a.object,lineNumbers:r.a.bool,onMarkdownHelpButtonClicked:r.a.func},u.propTypes),Y.defaultProps={lineNumbers:!0};var Q=a("./node_modules/react-bootstrap/es/FormControl.js");class Z extends u{constructor(e){super(e),this.logger=a("./src/lib/service/logger/index.js")("growi:PageEditor:TextAreaEditor"),this.state={value:this.props.value,isGfmMode:this.props.isGfmMode},this.init(),this.handleEnterKey=this.handleEnterKey.bind(this),this.keyPressHandler=this.keyPressHandler.bind(this),this.pasteHandler=this.pasteHandler.bind(this),this.dragEnterHandler=this.dragEnterHandler.bind(this)}init(){this.interceptorManager=new w.a,this.interceptorManager.addInterceptors([new B])}componentDidMount(){this.setCaretLine(0),this.textarea.addEventListener("keypress",this.keyPressHandler),this.textarea.addEventListener("paste",this.pasteHandler),this.textarea.addEventListener("dragenter",this.dragEnterHandler)}forceToFocus(){setTimeout(()=>{this.textarea.focus()},150)}setValue(e){this.setState({value:e}),this.textarea.value=e}setGfmMode(e){this.setState({isGfmMode:e})}setCaretLine(e){if(Number.isNaN(e))return;this.textarea.scrollTop=this.textarea.scrollHeight;const t=this.textarea.value.split("\n").slice(0,e+1).map(e=>e.length+1).reduce((e,t)=>e+t,0)-1;this.textarea.setSelectionRange(t,t)}setScrollTopByLine(e){}insertText(e){const t=this.textarea.selectionStart,a=this.textarea.selectionEnd;this.replaceValue(e,t,a)}getStrFromBol(){const e=this.textarea.selectionStart;return this.textarea.value.substring(this.getBolPos(),e)}getStrToEol(){const e=this.textarea.selectionStart;return this.textarea.value.substring(e,this.getEolPos())}getStrFromBolToSelectedUpperPos(){const e=this.textarea.selectionStart,t=this.textarea.selectionEnd,a=e<t?e:t;return this.textarea.value.substring(this.getBolPos(),a)}replaceBolToCurrentPos(e){const t=this.textarea.selectionStart,a=this.textarea.selectionEnd,s=t<a?a:t;this.replaceValue(e,this.getBolPos(),s)}replaceLine(e){this.replaceValue(e,this.getBolPos(),this.getEolPos())}getBolPos(){const e=this.textarea.selectionStart;return this.textarea.value.lastIndexOf("\n",e-1)+1}getEolPos(){const e=this.textarea.selectionStart,t=this.textarea.value.indexOf("\n",e);return t<0?this.textarea.value.length:t}replaceValue(e,t,a){const s=this.textarea.value,n=s.substring(0,t)+e+s.substring(a,s.length),i=t+e.length;this.textarea.value=n,this.textarea.setSelectionRange(i,i)}keyPressHandler(e){if("enter"===e.key.toLowerCase()){if(e.ctrlKey||e.altKey||e.metaKey)return;this.handleEnterKey(e)}}handleEnterKey(e){if(!this.state.isGfmMode)return;const t={handlers:[],editor:this};this.interceptorManager.process("preHandleEnter",t).then(()=>{e.preventDefault(),0===t.handlers.length&&L.newlineAndIndentContinueMarkdownList(this)})}pasteHandler(e){const t=e.clipboardData.types;t.includes("Files")?(e.preventDefault(),this.dispatchPasteFiles(e)):t.includes("text/plain")&&T.pasteText(this,e)}dragEnterHandler(e){this.dispatchDragEnter(e)}dispatchDragEnter(e){null!=this.props.onDragEnter&&this.props.onDragEnter(e)}render(){return n.a.createElement(n.a.Fragment,null,n.a.createElement(Q.a,{componentClass:"textarea",className:"textarea-editor",inputRef:e=>{this.textarea=e},defaultValue:this.state.value,onChange:e=>{null!=this.props.onChange&&this.props.onChange(e.target.value)}}))}}function X(){return(X=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e}).apply(this,arguments)}Z.propTypes=Object.assign({},u.propTypes),a.d(t,"a",(function(){return ee}));class ee extends u{constructor(e){super(e),this.state={isComponentDidMount:!1,dropzoneActive:!1,isUploading:!1,isCheatsheetModalShown:!1},this.getEditorSubstance=this.getEditorSubstance.bind(this),this.pasteFilesHandler=this.pasteFilesHandler.bind(this),this.dragEnterHandler=this.dragEnterHandler.bind(this),this.dragLeaveHandler=this.dragLeaveHandler.bind(this),this.dropHandler=this.dropHandler.bind(this),this.showMarkdownHelp=this.showMarkdownHelp.bind(this),this.getAcceptableType=this.getAcceptableType.bind(this),this.getDropzoneClassName=this.getDropzoneClassName.bind(this),this.renderDropzoneOverlay=this.renderDropzoneOverlay.bind(this)}componentDidMount(){this.setState({isComponentDidMount:!0})}getEditorSubstance(){return this.props.isMobile?this.taEditor:this.cmEditor}forceToFocus(){this.getEditorSubstance().forceToFocus()}setValue(e){this.getEditorSubstance().setValue(e)}setGfmMode(e){this.getEditorSubstance().setGfmMode(e)}setCaretLine(e){this.getEditorSubstance().setCaretLine(e)}setScrollTopByLine(e){this.getEditorSubstance().setScrollTopByLine(e)}insertText(e){this.getEditorSubstance().insertText(e)}terminateUploadingState(){this.setState({dropzoneActive:!1,isUploading:!1})}dispatchUpload(e){null!=this.props.onUpload&&this.props.onUpload(e)}getAcceptableType(){let e="null";return this.props.isUploadable&&(e=this.props.isUploadableFile?"":"image/*"),e}pasteFilesHandler(e){const t=e.clipboardData.items||e.clipboardData.files||[];if(!(t.length<1))for(let e=0;e<t.length;e++)try{const a=t[e].getAsFile();null!=a&&T.isAcceptableType(a,this.getAcceptableType())&&(this.dispatchUpload(a),this.setState({isUploading:!0}))}catch(e){this.logger.error(e)}}dragEnterHandler(e){e.dataTransfer.types.includes("Files")&&this.setState({dropzoneActive:!0})}dragLeaveHandler(){this.setState({dropzoneActive:!1})}dropHandler(e,t){if(1!==e.length)return void this.setState({dropzoneActive:!1});const a=e[0];this.dispatchUpload(a),this.setState({isUploading:!0})}showMarkdownHelp(){this.setState({isCheatsheetModalShown:!0})}getDropzoneClassName(e,t){let a="dropzone";return this.props.isUploadable?(a+=" dropzone-uploadable",this.props.isUploadableFile&&(a+=" dropzone-uploadablefile")):a+=" dropzone-unuploadable",this.state.isUploading&&(a+=" dropzone-uploading"),e&&(a+=" dropzone-accepted"),t&&(a+=" dropzone-rejected"),a}renderDropzoneOverlay(){return n.a.createElement("div",{className:"overlay overlay-dropzone-active"},this.state.isUploading&&n.a.createElement("span",{className:"overlay-content"},n.a.createElement("div",{className:"speeding-wheel d-inline-block"}),n.a.createElement("span",{className:"sr-only"},"Uploading...")),!this.state.isUploading&&n.a.createElement("span",{className:"overlay-content"}))}renderNavbar(){return n.a.createElement("div",{className:"m-0 navbar navbar-default navbar-editor",style:{minHeight:"unset"}},n.a.createElement("ul",{className:"pl-2 nav nav-navbar"},null!=this.getNavbarItems()&&this.getNavbarItems().map((e,t)=>n.a.createElement("li",{key:`navbarItem-${t}`},e))))}getNavbarItems(){return[].concat(this.getEditorSubstance().getNavbarItems())}renderCheatsheetModal(){const e=()=>{this.setState({isCheatsheetModalShown:!1})};return n.a.createElement(l.a,{className:"modal-gfm-cheatsheet",show:this.state.isCheatsheetModalShown,onHide:()=>{e()}},n.a.createElement(l.a.Header,{closeButton:!0},n.a.createElement(l.a.Title,null,n.a.createElement("i",{className:"icon-fw icon-question"}),"Markdown Help")),n.a.createElement(l.a.Body,{className:"pt-1"},n.a.createElement(m,null)))}render(){const e=this.props.isMobile;return n.a.createElement("div",{style:{height:"100%",display:"flex",flexDirection:"column"},className:"editor-container"},n.a.createElement(c.a,{ref:e=>{this.dropzone=e},accept:this.getAcceptableType(),noClick:!0,noKeyboard:!0,multiple:!1,onDragLeave:this.dragLeaveHandler,onDrop:this.dropHandler},({getRootProps:t,getInputProps:a,isDragAccept:s,isDragReject:i})=>n.a.createElement("div",X({className:this.getDropzoneClassName(s,i)},t()),this.state.dropzoneActive&&this.renderDropzoneOverlay(),this.state.isComponentDidMount&&this.renderNavbar(),!e&&n.a.createElement(o.c,{to:[d.a]},e=>n.a.createElement(Y,X({ref:e=>{this.cmEditor=e},editorOptions:e.state.editorOptions,onPasteFiles:this.pasteFilesHandler,onDragEnter:this.dragEnterHandler,onMarkdownHelpButtonClicked:this.showMarkdownHelp},this.props))),e&&n.a.createElement(Z,X({ref:e=>{this.taEditor=e},onPasteFiles:this.pasteFilesHandler,onDragEnter:this.dragEnterHandler},this.props)),n.a.createElement("input",a()))),this.props.isUploadable&&n.a.createElement("button",{type:"button",className:"btn btn-default btn-block btn-open-dropzone",onClick:()=>{this.dropzone.open()}},n.a.createElement("i",{className:"icon-paper-clip","aria-hidden":"true"})," Attach files",n.a.createElement("span",{className:"desc-long"},"by dragging & dropping,",n.a.createElement("span",{className:"btn-link"},"selecting them"),", or pasting from the clipboard.")),this.renderCheatsheetModal())}}ee.propTypes=Object.assign({noCdn:r.a.bool,isMobile:r.a.bool,isUploadable:r.a.bool,isUploadableFile:r.a.bool,emojiStrategy:r.a.object,onChange:r.a.func,onUpload:r.a.func},u.propTypes)},"./src/client/js/components/PageEditor/HandsontableModal.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-bootstrap/es/Modal.js"),l=a("./node_modules/react-bootstrap/es/Button.js"),c=a("./node_modules/react-bootstrap/es/ButtonGroup.js"),d=a("./node_modules/react-bootstrap/es/Collapse.js"),h=a("./node_modules/handsontable/dist/handsontable.js"),p=a.n(h),m=a("./node_modules/@handsontable/react/dist/react-handsontable.js"),u=a("./node_modules/throttle-debounce/index.esm.js"),g=a("./node_modules/react-bootstrap/es/FormGroup.js"),f=a("./node_modules/react-bootstrap/es/ControlLabel.js"),b=a("./node_modules/react-bootstrap/es/FormControl.js"),E=a("./src/client/js/models/MarkdownTable.js");class C extends n.a.Component{constructor(e){super(e),this.state={dataFormat:"csv",data:"",parserErrorMessage:null},this.importButtonHandler=this.importButtonHandler.bind(this)}importButtonHandler(){try{const e=this.convertFormDataToMarkdownTable();this.props.onImport(e),this.setState({parserErrorMessage:null})}catch(e){this.setState({parserErrorMessage:e.message})}}convertFormDataToMarkdownTable(){let e;switch(this.state.dataFormat){case"csv":e=E.a.fromDSV(this.state.data,",");break;case"tsv":e=E.a.fromDSV(this.state.data,"\t");break;case"html":e=E.a.fromHTMLTableTag(this.state.data)}return e.normalizeCells()}render(){return n.a.createElement("form",{action:"",className:"data-import-form pt-5"},n.a.createElement(g.a,null,n.a.createElement(f.a,null,"Select Data Format"),n.a.createElement(b.a,{componentClass:"select",placeholder:"select",value:this.state.dataFormat,onChange:e=>this.setState({dataFormat:e.target.value})},n.a.createElement("option",{value:"csv"},"CSV"),n.a.createElement("option",{value:"tsv"},"TSV"),n.a.createElement("option",{value:"html"},"HTML"))),n.a.createElement(g.a,null,n.a.createElement(f.a,null,"Import Data"),n.a.createElement(b.a,{componentClass:"textarea",placeholder:"Paste table data",style:{height:200},onChange:e=>this.setState({data:e.target.value})})),n.a.createElement(d.a,{in:null!=this.state.parserErrorMessage},n.a.createElement(g.a,null,n.a.createElement(f.a,null,"Parse Error"),n.a.createElement(b.a,{componentClass:"textarea",style:{height:100},value:this.state.parserErrorMessage||"",readOnly:!0}))),n.a.createElement("div",{className:"d-flex justify-content-end"},n.a.createElement(l.a,{bsStyle:"default",onClick:this.props.onCancel},"Cancel"),n.a.createElement(l.a,{bsStyle:"primary",onClick:this.importButtonHandler},"Import")))}}C.propTypes={onCancel:r.a.func,onImport:r.a.func},a.d(t,"a",(function(){return y}));const v=300,w={r:"htRight",c:"htCenter",l:"htLeft","":""};class y extends n.a.PureComponent{constructor(e){super(e),this.state={show:!1,isDataImportAreaExpanded:!1,isWindowExpanded:!1,markdownTableOnInit:y.getDefaultMarkdownTable(),markdownTable:y.getDefaultMarkdownTable(),handsontableHeight:v},this.init=this.init.bind(this),this.reset=this.reset.bind(this),this.cancel=this.cancel.bind(this),this.save=this.save.bind(this),this.afterLoadDataHandler=this.afterLoadDataHandler.bind(this),this.beforeColumnResizeHandler=this.beforeColumnResizeHandler.bind(this),this.afterColumnResizeHandler=this.afterColumnResizeHandler.bind(this),this.modifyColWidthHandler=this.modifyColWidthHandler.bind(this),this.beforeColumnMoveHandler=this.beforeColumnMoveHandler.bind(this),this.afterColumnMoveHandler=this.afterColumnMoveHandler.bind(this),this.synchronizeAlignment=this.synchronizeAlignment.bind(this),this.alignButtonHandler=this.alignButtonHandler.bind(this),this.toggleDataImportArea=this.toggleDataImportArea.bind(this),this.importData=this.importData.bind(this),this.expandWindow=this.expandWindow.bind(this),this.contractWindow=this.contractWindow.bind(this),this.expandHotTableHeightWithDebounce=Object(u.a)(100,this.expandHotTableHeight),this.manuallyResizedColumnIndicesSet=new Set,this.handsontableSettings=Object.assign(y.getDefaultHandsontableSetting(),{contextMenu:this.createCustomizedContextMenu()})}init(e){const t=e||y.getDefaultMarkdownTable();this.setState({markdownTableOnInit:t,markdownTable:t.clone()}),this.manuallyResizedColumnIndicesSet.clear()}createCustomizedContextMenu(){return{items:{row_above:{},row_below:{},col_left:{},col_right:{},separator1:p.a.plugins.ContextMenu.SEPARATOR,remove_row:{},remove_col:{},separator2:p.a.plugins.ContextMenu.SEPARATOR,custom_alignment:{name:"Align columns",key:"align_columns",submenu:{items:[{name:"Left",key:"align_columns:1",callback:(e,t)=>{this.align("l",t[0].start.col,t[0].end.col)}},{name:"Center",key:"align_columns:2",callback:(e,t)=>{this.align("c",t[0].start.col,t[0].end.col)}},{name:"Right",key:"align_columns:3",callback:(e,t)=>{this.align("r",t[0].start.col,t[0].end.col)}}]}}}}}show(e){this.init(e),this.setState({show:!0})}hide(){this.setState({show:!1,isDataImportAreaExpanded:!1,isWindowExpanded:!1})}reset(){this.setState({markdownTable:this.state.markdownTableOnInit.clone()})}cancel(){this.hide()}save(){const e=new E.a(this.hotTable.hotInstance.getData(),{align:[].concat(this.state.markdownTable.options.align)}).normalizeCells();null!=this.props.onSave&&this.props.onSave(e),this.hide()}afterLoadDataHandler(e){e&&this.manuallyResizedColumnIndicesSet.clear(),this.synchronizeAlignment()}beforeColumnResizeHandler(e){}afterColumnResizeHandler(e){this.manuallyResizedColumnIndicesSet.add(e),this.hotTable.hotInstance.render()}modifyColWidthHandler(e,t){return this.manuallyResizedColumnIndicesSet.has(t)?e:Math.max(80,Math.min(400,e))}beforeColumnMoveHandler(e,t){this.manuallyResizedColumnIndicesSet.clear()}afterColumnMoveHandler(e,t){const a=[].concat(this.state.markdownTable.options.align),s=a.splice(e[0],e.length);let n=0;t<=e[0]?n=t:e[e.length-1]<t&&(n=t-e.length),a.splice(...[n,0].concat(s)),this.setState(e=>{return{markdownTable:new E.a(e.markdownTable.table,{align:a})}},()=>{this.synchronizeAlignment()})}align(e,t,a){this.setState(s=>{const n=new E.a(s.markdownTable.table,{align:[].concat(s.markdownTable.options.align)});for(let s=t;s<=a;s++)n.options.align[s]=e;return{markdownTable:n}},()=>{this.synchronizeAlignment()})}synchronizeAlignment(){if(null==this.hotTable)return;const e=this.state.markdownTable.options.align,t=this.hotTable.hotInstance;for(let a=0;a<e.length;a++)for(let s=0;s<t.countRows();s++)t.setCellMeta(s,a,"className",w[e[a]]);t.render()}alignButtonHandler(e){const t=this.hotTable.hotInstance.getSelectedRange();if(null==t)return;let a,s;t[0].from.col<t[0].to.col?(a=t[0].from.col,s=t[0].to.col):(a=t[0].to.col,s=t[0].from.col),this.align(e,a,s)}toggleDataImportArea(){this.setState({isDataImportAreaExpanded:!this.state.isDataImportAreaExpanded})}importData(e){this.init(e),this.toggleDataImportArea()}expandWindow(){this.setState({isWindowExpanded:!0}),this.expandHotTableHeightWithDebounce()}contractWindow(){this.setState({isWindowExpanded:!1,handsontableHeight:v})}expandHotTableHeight(){if(this.state.isWindowExpanded&&null!=this.hotTableContainer){const e=this.hotTableContainer.getBoundingClientRect().height;this.setState({handsontableHeight:e})}}renderExpandOrContractButton(){const e=this.state.isWindowExpanded?"icon-size-actual":"icon-size-fullscreen";return n.a.createElement("button",{type:"button",className:"close mr-3",onClick:this.state.isWindowExpanded?this.contractWindow:this.expandWindow},n.a.createElement("i",{className:e,style:{fontSize:"0.8em"},"aria-hidden":"true"}))}render(){const e=["handsontable-modal"];this.state.isWindowExpanded&&e.push("handsontable-modal-expanded");const t=e.join(" ");return n.a.createElement(o.a,{show:this.state.show,onHide:this.cancel,bsSize:"large",dialogClassName:t,keyboard:!1},n.a.createElement(o.a.Header,{closeButton:!0},this.renderExpandOrContractButton(),n.a.createElement(o.a.Title,null,"Edit Table")),n.a.createElement(o.a.Body,{className:"p-0 d-flex flex-column"},n.a.createElement("div",{className:"px-4 py-3 modal-navbar"},n.a.createElement(l.a,{className:"m-r-20 data-import-button",onClick:this.toggleDataImportArea},"Data Import",n.a.createElement("i",{className:this.state.isDataImportAreaExpanded?"fa fa-angle-up":"fa fa-angle-down"})),n.a.createElement(c.a,null,n.a.createElement(l.a,{onClick:()=>{this.alignButtonHandler("l")}},n.a.createElement("i",{className:"ti-align-left"})),n.a.createElement(l.a,{onClick:()=>{this.alignButtonHandler("c")}},n.a.createElement("i",{className:"ti-align-center"})),n.a.createElement(l.a,{onClick:()=>{this.alignButtonHandler("r")}},n.a.createElement("i",{className:"ti-align-right"}))),n.a.createElement(d.a,{in:this.state.isDataImportAreaExpanded},n.a.createElement("div",null," ",n.a.createElement(C,{onCancel:this.toggleDataImportArea,onImport:this.importData})))),n.a.createElement("div",{ref:e=>{this.hotTableContainer=e},className:"m-4 hot-table-container"},n.a.createElement(m.HotTable,{ref:e=>{this.hotTable=e},data:this.state.markdownTable.table,settings:this.handsontableSettings,height:this.state.handsontableHeight,afterLoadData:this.afterLoadDataHandler,modifyColWidth:this.modifyColWidthHandler,beforeColumnMove:this.beforeColumnMoveHandler,beforeColumnResize:this.beforeColumnResizeHandler,afterColumnResize:this.afterColumnResizeHandler,afterColumnMove:this.afterColumnMoveHandler}))),n.a.createElement(o.a.Footer,null,n.a.createElement("div",{className:"d-flex justify-content-between"},n.a.createElement(l.a,{bsStyle:"danger",onClick:this.reset},"Reset"),n.a.createElement("div",{className:"d-flex"},n.a.createElement(l.a,{bsStyle:"default",onClick:this.cancel},"Cancel"),n.a.createElement(l.a,{bsStyle:"primary",onClick:this.save},"Done")))))}static getDefaultMarkdownTable(){return new E.a([["col1","col2","col3"],["","",""],["","",""]],{align:["","",""]})}static getDefaultHandsontableSetting(){return{rowHeaders:!0,colHeaders:!0,manualRowMove:!0,manualRowResize:!0,manualColumnMove:!0,manualColumnResize:!0,selectionMode:"multiple",outsideClickDeselects:!1}}}y.propTypes={onSave:r.a.func}},"./src/client/js/components/PageEditor/MarkdownDrawioUtil.js":function(e,t,a){"use strict";const s=new class{constructor(){this.lineBeginPartOfDrawioRE=/^:::(\s.*)drawio$/,this.lineEndPartOfDrawioRE=/^:::$/}getBod(e){const t=e.getCursor(),a=e.getDoc().firstLine();if(this.lineBeginPartOfDrawioRE.test(e.getDoc().getLine(t.line)))return{line:t.line,ch:0};let s=t.line-1,n=!1;for(;s>=a;s--){const t=e.getDoc().getLine(s);if(this.lineBeginPartOfDrawioRE.test(t)){n=!0;break}if(this.lineEndPartOfDrawioRE.test(t)){n=!1;break}}if(!n)return{line:t.line,ch:t.ch};return{line:Math.max(a,s),ch:0}}getEod(e){const t=e.getCursor(),a=e.getDoc().lastLine();if(this.lineEndPartOfDrawioRE.test(e.getDoc().getLine(t.line)))return{line:t.line,ch:e.getDoc().getLine(t.line).length};let s=t.line+1,n=!1;for(;s<=a;s++){const t=e.getDoc().getLine(s);if(this.lineEndPartOfDrawioRE.test(t)){n=!0;break}if(this.lineBeginPartOfDrawioRE.test(t)){n=!1;break}}if(!n)return{line:t.line,ch:t.ch};const i=Math.min(s,a);return{line:i,ch:e.getDoc().getLine(i).length}}isInDrawioBlock(e){const t=this.getBod(e),a=this.getEod(e);return JSON.stringify(t)!==JSON.stringify(a)}getMarkdownDrawioMxfile(e){const t=e.getCursor();if(this.isInDrawioBlock(e)){const t=this.getBod(e),a=this.getEod(e);return t.line++,a.line--,a.ch=e.getDoc().getLine(a.line).length,e.getDoc().getRange(t,a)}return e.getDoc().getLine(t.line)}replaceFocusedDrawioWithEditor(e,t){const a=e.getCursor(),s=["::: drawio",t.toString(),":::"].join("\n");let n,i;this.isInDrawioBlock(e)?(n=this.getBod(e),i=this.getEod(e)):(n={line:a.line,ch:a.ch},i={line:a.line,ch:a.ch}),e.getDoc().replaceRange(s,n,i)}replaceDrawioInMarkdown(e,t,a,s){const n=t.split(/\r\n|\r|\n/),i=n.slice(0,a),r=n.slice(s);let o="";return i.length>0&&(o+=`${i.join("\n")}\n`,o+="::: drawio\n"),o+=e,r.length>0&&(o+="\n:::",o+=`\n${r.join("\n")}`),o}};Object.freeze(s),t.a=s},"./src/client/js/components/PageEditor/MarkdownTableUtil.js":function(e,t,a){"use strict";var s=a("./src/client/js/models/MarkdownTable.js");const n=new class{constructor(){this.tableAlignmentLineRE=/^[-:|][-:|\s]*$/,this.tableAlignmentLineNegRE=/^[^-:]*$/,this.linePartOfTableRE=/^([^\r\n|]*)\|(([^\r\n|]*\|)+)$/,this.emptyLineOfTableRE=/^([^\r\n|]*)\|((\s*\|)+)$/,this.getEot=this.getEot.bind(this),this.getStrFromBot=this.getStrFromBot.bind(this),this.getStrToEot=this.getStrToEot.bind(this),this.isInTable=this.isInTable.bind(this),this.replaceFocusedMarkdownTableWithEditor=this.replaceFocusedMarkdownTableWithEditor.bind(this),this.replaceMarkdownTableWithReformed=this.replaceFocusedMarkdownTableWithEditor}getBot(e){const t=e.getCursor();if(!this.isInTable(e))return{line:t.line,ch:t.ch};const a=e.getDoc().firstLine();let s=t.line-1;for(;s>=a;s--){const t=e.getDoc().getLine(s);if(!this.linePartOfTableRE.test(t))break}return{line:Math.max(a,s+1),ch:0}}getEot(e){const t=e.getCursor();if(!this.isInTable(e))return{line:t.line,ch:t.ch};const a=e.getDoc().lastLine();let s=t.line+1;for(;s<=a;s++){const t=e.getDoc().getLine(s);if(!this.linePartOfTableRE.test(t))break}const n=Math.min(s-1,a);return{line:n,ch:e.getDoc().getLine(n).length}}getStrFromBot(e){const t=e.getCursor();return e.getDoc().getRange(this.getBot(e),t)}getStrToEot(e){const t=e.getCursor();return e.getDoc().getRange(t,this.getEot(e))}getMarkdownTable(e){if(!this.isInTable(e))return null;const t=e.getDoc().getRange(this.getBot(e),this.getEot(e));return s.a.fromMarkdownString(t)}isEndOfLine(e){const t=e.getCursor();return t.ch===e.getDoc().getLine(t.line).length}isInTable(e){const t=e.getCursor();return this.linePartOfTableRE.test(e.getDoc().getLine(t.line))}addRowToMarkdownTable(e){const t=e.table.length>0?e.table[0].length:1,a=[];new Array(t).forEach(()=>a.push("")),e.table.push(a)}mergeMarkdownTable(e){if(null==e||!(e instanceof Array))return;let t=[];const a=e[0].options;return e.forEach(e=>{t=t.concat(e.table)}),new s.a(t,a)}replaceFocusedMarkdownTableWithEditor(e,t){const a=e.getCursor();e.getDoc().replaceRange(t.toString(),this.getBot(e),this.getEot(e)),e.getDoc().setCursor(a.line+1,2)}replaceMarkdownTableInMarkdown(e,t,a,s){const n=t.split(/\r\n|\r|\n/),i=n.slice(0,a-1),r=n.slice(s);let o="";return i.length>0&&(o+=`${i.join("\n")}\n`),o+=e,r.length>0&&(o+=`\n${r.join("\n")}`),o}};Object.freeze(n),t.a=n},"./src/client/js/components/PageEditor/OptionsSelector.jsx":function(e,t,a){"use strict";a.d(t,"b",(function(){return g})),a.d(t,"c",(function(){return f}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./node_modules/react-bootstrap/es/FormGroup.js"),c=a("./node_modules/react-bootstrap/es/FormControl.js"),d=a("./node_modules/react-bootstrap/es/ControlLabel.js"),h=a("./node_modules/react-bootstrap/es/Dropdown.js"),p=a("./node_modules/react-bootstrap/es/MenuItem.js"),m=a("./src/client/js/components/UnstatedUtils.jsx"),u=a("./src/client/js/services/EditorContainer.js");const g={theme:"elegant",keymapMode:"default",styleActiveLine:!1},f={renderMathJaxInRealtime:!1};class b extends n.a.Component{constructor(e){super(e);const t=!!this.props.crowi.getConfig().env.MATHJAX;this.state={isCddMenuOpened:!1,isMathJaxEnabled:t},this.availableThemes=["eclipse","elegant","neo","mdn-like","material","dracula","monokai","twilight"],this.keymapModes={default:"Default",vim:"Vim",emacs:"Emacs",sublime:"Sublime Text"},this.onChangeTheme=this.onChangeTheme.bind(this),this.onChangeKeymapMode=this.onChangeKeymapMode.bind(this),this.onClickStyleActiveLine=this.onClickStyleActiveLine.bind(this),this.onClickRenderMathJaxInRealtime=this.onClickRenderMathJaxInRealtime.bind(this),this.onToggleConfigurationDropdown=this.onToggleConfigurationDropdown.bind(this)}componentDidMount(){this.init()}init(){const{editorContainer:e}=this.props;this.themeSelectorInputEl.value=e.state.editorOptions.theme,this.keymapModeSelectorInputEl.value=e.state.editorOptions.keymapMode}onChangeTheme(){const{editorContainer:e}=this.props,t=this.themeSelectorInputEl.value,a=Object.assign(e.state.editorOptions,{theme:t});e.setState({editorOptions:a}),e.saveOptsToLocalStorage()}onChangeKeymapMode(){const{editorContainer:e}=this.props,t=this.keymapModeSelectorInputEl.value,a=Object.assign(e.state.editorOptions,{keymapMode:t});e.setState({editorOptions:a}),e.saveOptsToLocalStorage()}onClickStyleActiveLine(e){const{editorContainer:t}=this.props;this._cddForceOpen=!0;const a=!t.state.editorOptions.styleActiveLine,s=Object.assign(t.state.editorOptions,{styleActiveLine:a});t.setState({editorOptions:s}),t.saveOptsToLocalStorage()}onClickRenderMathJaxInRealtime(e){const{editorContainer:t}=this.props;this._cddForceOpen=!0;const a=!t.state.previewOptions.renderMathJaxInRealtime,s=Object.assign(t.state.previewOptions,{renderMathJaxInRealtime:a});t.setState({previewOptions:s}),t.saveOptsToLocalStorage()}onToggleConfigurationDropdown(e){this._cddForceOpen?(this.setState({isCddMenuOpened:!0}),this._cddForceOpen=!1):this.setState({isCddMenuOpened:e})}renderThemeSelector(){const e=this.availableThemes.map(e=>n.a.createElement("option",{key:e,value:e},e));return n.a.createElement(l.a,{controlId:"formControlsSelect",className:"my-0"},n.a.createElement(d.a,null,"Theme:"),n.a.createElement(c.a,{componentClass:"select",placeholder:"select",bsClass:"form-control-dummy",className:"btn-group-sm selectpicker",onChange:this.onChangeTheme,inputRef:e=>this.themeSelectorInputEl=e},e))}renderKeymapModeSelector(){const e=[];for(const t in this.keymapModes){const a=this.keymapModes[t],s="default"===t?a:`<img src='/images/icons/${t}.png' width='16px' class='m-r-5'></img> ${a}`;e.push(n.a.createElement("option",{key:t,value:t,"data-content":s},a))}return n.a.createElement(l.a,{controlId:"formControlsSelect",className:"my-0"},n.a.createElement(d.a,null,"Keymap:"),n.a.createElement(c.a,{componentClass:"select",placeholder:"select",bsClass:"form-control-dummy",className:"btn-group-sm selectpicker",onChange:this.onChangeKeymapMode,inputRef:e=>this.keymapModeSelectorInputEl=e},e))}renderConfigurationDropdown(){return n.a.createElement(l.a,{controlId:"formControlsSelect",className:"my-0"},n.a.createElement(h.a,{dropup:!0,id:"configurationDropdown",className:"configuration-dropdown",open:this.state.isCddMenuOpened,onToggle:this.onToggleConfigurationDropdown},n.a.createElement(h.a.Toggle,{bsSize:"sm"},n.a.createElement("i",{className:"icon-settings"})),n.a.createElement(h.a.Menu,null,this.renderActiveLineMenuItem(),this.renderRealtimeMathJaxMenuItem())))}renderActiveLineMenuItem(){const{t:e,editorContainer:t}=this.props,a=["text-info"];t.state.editorOptions.styleActiveLine&&a.push("ti-check");const s=a.join(" ");return n.a.createElement(p.a,{onClick:this.onClickStyleActiveLine},n.a.createElement("span",{className:"icon-container"}),n.a.createElement("span",{className:"menuitem-label"},e("page_edit.Show active line")),n.a.createElement("span",{className:"icon-container"},n.a.createElement("i",{className:s})))}renderRealtimeMathJaxMenuItem(){if(!this.state.isMathJaxEnabled)return;const{editorContainer:e}=this.props,t=["text-info"];this.state.isMathJaxEnabled&&e.state.previewOptions.renderMathJaxInRealtime&&t.push("ti-check");const a=t.join(" ");return n.a.createElement(p.a,{onClick:this.onClickRenderMathJaxInRealtime},n.a.createElement("span",{className:"icon-container"},n.a.createElement("img",{src:"/images/icons/fx.svg",width:"14px",alt:"fx"})),n.a.createElement("span",{className:"menuitem-label"},"MathJax Rendering"),n.a.createElement("i",{className:a}))}render(){return n.a.createElement("div",{className:"d-flex flex-row"},n.a.createElement("span",{className:"m-l-5"},this.renderThemeSelector()),n.a.createElement("span",{className:"m-l-5"},this.renderKeymapModeSelector()),n.a.createElement("span",{className:"m-l-5"},this.renderConfigurationDropdown()))}}b.propTypes={t:r.a.func.isRequired,editorContainer:r.a.instanceOf(u.a).isRequired,crowi:r.a.object.isRequired},t.a=Object(o.c)()(e=>Object(m.a)(b,e,[u.a]))},"./src/client/js/components/PageEditorByHackmd.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/lib/service/logger/index.js"),l=a.n(o),c=a("./src/client/js/services/AppContainer.js"),d=a("./src/client/js/services/PageContainer.js"),h=a("./src/client/js/services/EditorContainer.js"),p=a("./src/client/js/components/UnstatedUtils.jsx"),m=a("./node_modules/penpal/lib/connectToChild.js"),u=a.n(m);const g=!1,f=l()("growi:HackmdEditor");class b extends n.a.PureComponent{constructor(e){super(e),this.hackmd=null,this.initHackmdWithPenpal=this.initHackmdWithPenpal.bind(this),this.notifyBodyChangesHandler=this.notifyBodyChangesHandler.bind(this),this.saveWithShortcutHandler=this.saveWithShortcutHandler.bind(this)}componentDidMount(){this.initHackmdWithPenpal()}async initHackmdWithPenpal(){const e=this,t=document.createElement("iframe");t.src=`${this.props.hackmdUri}/${this.props.pageIdOnHackmd}?both`,this.iframeContainer.appendChild(t);const a=u()({iframe:t,methods:{notifyBodyChanges(t){e.notifyBodyChangesHandler(t)},saveWithShortcut(t){e.saveWithShortcutHandler(t)}},timeout:15e3,debug:g});try{const e=await a.promise;this.hackmd=e,null!=this.props.initializationMarkdown&&e.setValueOnInit(this.props.initializationMarkdown)}catch(e){f.error(e),null!=this.props.onPenpalErrorOccured&&this.props.onPenpalErrorOccured(e)}}getValue(){return this.hackmd.getValue()}setValue(e){this.hackmd.setValue(e)}notifyBodyChangesHandler(e){null!=this.props.onChange&&e!==this.props.initializationMarkdown&&this.props.onChange(e)}saveWithShortcutHandler(e){null!=this.props.onSaveWithShortcut&&this.props.onSaveWithShortcut(e)}render(){return n.a.createElement("div",{id:"iframe-hackmd-container",ref:e=>{this.iframeContainer=e}})}}b.propTypes={hackmdUri:r.a.string.isRequired,pageIdOnHackmd:r.a.string.isRequired,initializationMarkdown:r.a.string,onChange:r.a.func,onSaveWithShortcut:r.a.func,onPenpalErrorOccured:r.a.func};const E=l()("growi:PageEditorByHackmd");class C extends n.a.Component{constructor(e){super(e),this.state={isInitialized:!1,isInitializing:!1,hasError:!1,errorMessage:"",errorReason:""},this.getHackmdUri=this.getHackmdUri.bind(this),this.startToEdit=this.startToEdit.bind(this),this.resumeToEdit=this.resumeToEdit.bind(this),this.onSaveWithShortcut=this.onSaveWithShortcut.bind(this),this.hackmdEditorChangeHandler=this.hackmdEditorChangeHandler.bind(this),this.penpalErrorOccuredHandler=this.penpalErrorOccuredHandler.bind(this)}componentWillMount(){this.props.appContainer.registerComponentInstance("PageEditorByHackmd",this)}getMarkdown(){return this.state.isInitialized?this.hackmdEditor.getValue():Promise.reject(new Error("HackmdEditor component has not initialized"))}reset(){this.setState({isInitialized:!1})}getHackmdUri(){return this.props.appContainer.getConfig().env.HACKMD_URI}get isResume(){const{pageContainer:e}=this.props,{pageIdOnHackmd:t,hasDraftOnHackmd:a,isHackmdDraftUpdatingInRealtime:s}=e.state;return null!=t&&a||s}async startToEdit(){const{pageContainer:e}=this.props;if(null==this.getHackmdUri())return;this.setState({isInitialized:!1,isInitializing:!0});const t={pageId:e.state.pageId};try{const a=await this.props.appContainer.apiPost("/hackmd.integrate",t);if(!a.ok)throw new Error(a.error);await e.setState({pageIdOnHackmd:a.pageIdOnHackmd,revisionIdHackmdSynced:a.revisionIdHackmdSynced})}catch(t){e.showErrorToastr(t),this.setState({hasError:!0,errorMessage:"GROWI server failed to connect to HackMD.",errorReason:t.toString()})}this.setState({isInitialized:!0,isInitializing:!1})}resumeToEdit(){this.setState({isInitialized:!0})}async discardChanges(){const{pageContainer:e}=this.props,{pageId:t}=e.state;try{const e=await this.props.appContainer.apiPost("/hackmd.discard",{pageId:t});if(!e.ok)throw new Error(e.error);this.props.pageContainer.setState({hasDraftOnHackmd:!1,pageIdOnHackmd:e.pageIdOnHackmd,revisionIdHackmdSynced:e.revisionIdHackmdSynced})}catch(t){E.error(t),e.showErrorToastr(t)}}async onSaveWithShortcut(e){const{pageContainer:t,editorContainer:a}=this.props,s=a.getCurrentOptionsToSave();try{a.disableUnsavedWarning();const{page:n,tags:i}=await t.save(e,s);E.debug("success to save"),t.showSuccessToastr(),a.setState({tags:i})}catch(e){E.error("failed to save",e),t.showErrorToastr(e)}}async hackmdEditorChangeHandler(e){const t=this.getHackmdUri(),{pageContainer:a,editorContainer:s}=this.props;if(null==t)return;if(a.state.markdown===e)return;s.enableUnsavedWarning();const n={pageId:a.state.pageId};try{await this.props.appContainer.apiPost("/hackmd.saveOnHackmd",n)}catch(e){E.error(e)}}penpalErrorOccuredHandler(e){const{pageContainer:t}=this.props;t.showErrorToastr(e),this.setState({hasError:!0,errorMessage:"GROWI client failed to connect to GROWI agent for HackMD.",errorReason:e.toString()})}renderPreInitContent(){const e=this.getHackmdUri(),{pageContainer:t}=this.props,{revisionId:a,revisionIdHackmdSynced:s,remoteRevisionId:i}=t.state;let r;if(null==e)r=n.a.createElement("div",null,n.a.createElement("p",{className:"text-center hackmd-status-label"},n.a.createElement("i",{className:"fa fa-file-text"})," HackMD is not set up."));else if(this.isResume){const e=s!==i;r=n.a.createElement("div",null,n.a.createElement("p",{className:"text-center hackmd-status-label"},n.a.createElement("i",{className:"fa fa-file-text"})," HackMD is READY!"),n.a.createElement("p",{className:"text-center"},n.a.createElement("strong",null,"HackMD has unsaved draft.")),e&&n.a.createElement("div",{className:"panel panel-warning"},n.a.createElement("div",{className:"panel-heading"},n.a.createElement("i",{className:"icon-fw icon-info"})," DRAFT MAY BE OUTDATED"),n.a.createElement("div",{className:"panel-body text-center"},"The current draft on HackMD is based on",n.a.createElement("a",{href:`?revision=${s}`},n.a.createElement("span",{className:"label label-default"},s.substr(-8))),".",n.a.createElement("div",{className:"text-center mt-3"},n.a.createElement("button",{className:"btn btn-link btn-view-outdated-draft p-0",type:"button",disabled:this.state.isInitializing,onClick:()=>this.resumeToEdit()},"View the outdated draft on HackMD")))),!e&&n.a.createElement("div",{className:"text-center hackmd-resume-button-container mb-3"},n.a.createElement("button",{className:"btn btn-success btn-lg waves-effect waves-light",type:"button",disabled:this.state.isInitializing,onClick:()=>this.resumeToEdit()},n.a.createElement("span",{className:"btn-label"},n.a.createElement("i",{className:"icon-control-end"})),n.a.createElement("span",{className:"btn-text"},"Resume to edit with HackMD"))),n.a.createElement("div",{className:"text-center hackmd-discard-button-container mb-3"},n.a.createElement("button",{className:"btn btn-default btn-lg waves-effect waves-light",type:"button",onClick:()=>this.discardChanges()},n.a.createElement("span",{className:"btn-label"},n.a.createElement("i",{className:"icon-control-start"})),n.a.createElement("span",{className:"btn-text"},"Discard changes of HackMD"))))}else{const e=a!==i;r=n.a.createElement("div",null,n.a.createElement("p",{className:"text-center hackmd-status-label"},n.a.createElement("i",{className:"fa fa-file-text"})," HackMD is READY!"),n.a.createElement("div",{className:"text-center hackmd-start-button-container mb-3"},n.a.createElement("button",{className:"btn btn-info btn-lg waves-effect waves-light",type:"button",disabled:e||this.state.isInitializing,onClick:()=>this.startToEdit()},n.a.createElement("span",{className:"btn-label"},n.a.createElement("i",{className:"icon-paper-plane"})),"Start to edit with HackMD")),n.a.createElement("p",{className:"text-center"},"Click to clone page content and start to edit."))}return n.a.createElement("div",{className:"hackmd-preinit d-flex justify-content-center align-items-center"},r)}render(){const e=this.getHackmdUri(),{pageContainer:t}=this.props,{markdown:a,pageIdOnHackmd:s}=t.state;let i;return i=this.state.isInitialized?n.a.createElement(b,{ref:e=>{this.hackmdEditor=e},hackmdUri:e,pageIdOnHackmd:s,initializationMarkdown:this.isResume?null:a,onChange:this.hackmdEditorChangeHandler,onSaveWithShortcut:e=>{this.onSaveWithShortcut(e)},onPenpalErrorOccured:this.penpalErrorOccuredHandler}):this.renderPreInitContent(),n.a.createElement("div",{className:"position-relative"},i,this.state.hasError&&n.a.createElement("div",{className:"hackmd-error position-absolute d-flex flex-column justify-content-center align-items-center"},n.a.createElement("div",{className:"white-box text-center"},n.a.createElement("h2",{className:"text-warning"},n.a.createElement("i",{className:"icon-fw icon-exclamation"})," HackMD Integration failed"),n.a.createElement("h4",null,this.state.errorMessage),n.a.createElement("p",{className:"well well-sm text-danger"},this.state.errorReason),n.a.createElement("p",null,"Check your configuration following ",n.a.createElement("a",{href:"https://docs.growi.org/guide/admin-cookbook/integrate-with-hackmd.html"},"the manual"),"."))))}}C.propTypes={appContainer:r.a.instanceOf(c.a).isRequired,pageContainer:r.a.instanceOf(d.a).isRequired,editorContainer:r.a.instanceOf(h.a).isRequired};t.a=e=>Object(p.a)(C,e,[c.a,d.a,h.a])},"./src/client/js/components/PageHistory.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/lib/service/logger/index.js"),l=a.n(o),c=a("./node_modules/react-i18next/dist/es/index.js"),d=a("./node_modules/date-fns/esm/format/index.js");class h extends n.a.Component{render(){const e=new Date(this.props.dateTime),t=Object(d.a)(e,this.props.format);return n.a.createElement("span",{className:this.props.className},t)}}h.propTypes={dateTime:r.a.string.isRequired,format:r.a.string,className:r.a.string},h.defaultProps={format:"yyyy/MM/dd HH:mm:ss",className:""};var p=a("./src/client/js/components/User/Username.jsx"),m=a("./src/client/js/components/User/UserPicture.jsx");class u extends n.a.Component{constructor(e){super(e),this._onDiffOpenClicked=this._onDiffOpenClicked.bind(this)}componentDidMount(){}_onDiffOpenClicked(){this.props.onDiffOpenClicked(this.props.revision)}renderSimplifiedNodiff(e){const{t:t}=this.props,a=e.author;let s="";return"object"==typeof a&&(s=n.a.createElement(m.a,{user:a,size:"sm"})),n.a.createElement("div",{className:"revision-history-main revision-history-main-nodiff my-1 d-flex align-items-center"},n.a.createElement("div",{className:"picture-container"},s),n.a.createElement("div",{className:"m-l-10"},n.a.createElement("div",{className:"revision-history-meta"},n.a.createElement("span",{className:"text-muted small"},n.a.createElement(h,{dateTime:e.createdAt})," (",t("No diff"),")"))))}renderFull(e){const{t:t}=this.props,a=e.author;let s="";"object"==typeof a&&(s=n.a.createElement(m.a,{user:a,size:"lg"}));const i=this.props.revisionDiffOpened?"caret caret-opened":"caret";return n.a.createElement("div",{className:"revision-history-main d-flex mt-3"},n.a.createElement("div",{className:"m-t-5"},s),n.a.createElement("div",{className:"m-l-10"},n.a.createElement("div",{className:"revision-history-author"},n.a.createElement("strong",null,n.a.createElement(p.a,{user:a}))),n.a.createElement("div",{className:"revision-history-meta"},n.a.createElement("p",null,n.a.createElement(h,{dateTime:e.createdAt})),n.a.createElement("p",null,n.a.createElement("span",{className:"d-inline-block",style:{minWidth:"90px"}},!this.props.hasDiff&&n.a.createElement("span",{className:"text-muted"},t("No diff")),this.props.hasDiff&&n.a.createElement("a",{className:"diff-view",onClick:this._onDiffOpenClicked},n.a.createElement("i",{className:i})," ",t("View diff"))),n.a.createElement("a",{href:`?revision=${e._id}`,className:"m-l-10"},n.a.createElement("i",{className:"icon-login"})," ",t("Go to this version"))))))}render(){const e=this.props.revision;return this.props.isCompactNodiffRevisions&&!this.props.hasDiff?this.renderSimplifiedNodiff(e):this.renderFull(e)}}u.propTypes={t:r.a.func.isRequired,revision:r.a.object,revisionDiffOpened:r.a.bool.isRequired,hasDiff:r.a.bool.isRequired,isCompactNodiffRevisions:r.a.bool.isRequired,onDiffOpenClicked:r.a.func.isRequired};var g=a("./node_modules/diff/dist/diff.js"),f=a("./node_modules/diff2html/lib-esm/diff2html.js");class b extends n.a.Component{render(){const e=this.props.currentRevision,t=this.props.previousRevision,a=this.props.revisionDiffOpened;let s="";if(e.body&&t.body&&a){let a=t.body;e._id==t._id&&(a="");const n=Object(g.createPatch)(e.path,a,e.body),i={drawFileList:!1,outputFormat:"side-by-side"};s=Object(f.a)(n,i)}const i={__html:s};return n.a.createElement("div",{className:"revision-history-diff",dangerouslySetInnerHTML:i})}}b.propTypes={currentRevision:r.a.object.isRequired,previousRevision:r.a.object.isRequired,revisionDiffOpened:r.a.bool.isRequired};class E extends n.a.Component{constructor(e){super(e),this.state={isCompactNodiffRevisions:!0},this.cbCompactizeChangeHandler=this.cbCompactizeChangeHandler.bind(this)}cbCompactizeChangeHandler(){this.setState({isCompactNodiffRevisions:!this.state.isCompactNodiffRevisions})}renderRow(e,t,a,s){const i=e._id,r=this.props.diffOpened[i]||!1,o=["revision-history-outer"];return s&&o.push("revision-history-outer-contiguous-nodiff"),n.a.createElement("div",{className:o.join(" "),key:`revision-history-${i}`},n.a.createElement(u,{t:this.props.t,revision:e,revisionDiffOpened:r,hasDiff:a,isCompactNodiffRevisions:this.state.isCompactNodiffRevisions,onDiffOpenClicked:this.props.onDiffOpenClicked,key:`revision-history-rev-${i}`}),a&&n.a.createElement(b,{revisionDiffOpened:r,currentRevision:e,previousRevision:t,key:`revision-deff-${i}`}))}render(){const{t:e}=this.props,t=this.props.revisions,a=this.props.revisions.length;let s;const i=this.props.revisions.map((e,n)=>{let i;i=n+1<a?t[n+1]:e;const r=!1!==e.hasDiffToPrev,o=!r&&!s;return s=r,this.renderRow(e,i,r,o)}),r=["revision-history-list"];return this.state.isCompactNodiffRevisions&&r.push("revision-history-list-compact"),n.a.createElement(n.a.Fragment,null,n.a.createElement("div",{className:"checkbox checkbox-info pull-right"},n.a.createElement("input",{id:"cbCompactize",type:"checkbox",value:!0,checked:this.state.isCompactNodiffRevisions,onChange:this.cbCompactizeChangeHandler}),n.a.createElement("label",{htmlFor:"cbCompactize"},e("Shrink versions that have no diffs"))),n.a.createElement("div",{className:"clearfix"}),n.a.createElement("div",{className:r.join(" ")},i))}}E.propTypes={t:r.a.func.isRequired,revisions:r.a.array,diffOpened:r.a.object,onDiffOpenClicked:r.a.func.isRequired};const C=l()("growi:PageHistory");class v extends n.a.Component{constructor(e){super(e),this.state={isLoaded:!1,isLoading:!1,errorMessage:null,revisions:[],diffOpened:{}},this.getPreviousRevision=this.getPreviousRevision.bind(this),this.onDiffOpenClicked=this.onDiffOpenClicked.bind(this)}async componentWillMount(){const e=this.props.pageId;if(!e)return;let t;try{this.setState({isLoading:!0}),t=await this.props.crowi.apiGet("/revisions.ids",{page_id:e})}catch(e){return C.error(e),void this.setState({errorMessage:e})}finally{this.setState({isLoading:!1})}const a=t.revisions,s={},n=a.length-1;t.revisions.forEach((e,t)=>{const i=this.props.crowi.findUserById(e.author);i&&(a[t].author=i),s[e._id]=0===t||t===n}),this.setState({isLoaded:!0,revisions:a,diffOpened:s}),a[0]&&this.fetchPageRevisionBody(a[0]),a[1]&&this.fetchPageRevisionBody(a[1]),0!==n&&1!==n&&a[n]&&this.fetchPageRevisionBody(a[n])}getPreviousRevision(e){let t=null;for(const a of this.state.revisions){if(t&&t._id==e._id){t=a;break}t=a}return t}onDiffOpenClicked(e){const t=this.state.diffOpened,a=e._id;t[a]=!t[a],this.setState({diffOpened:t}),this.fetchPageRevisionBody(e),this.fetchPageRevisionBody(this.getPreviousRevision(e))}fetchPageRevisionBody(e){e.body||this.props.crowi.apiGet("/revisions.get",{page_id:this.props.pageId,revision_id:e._id}).then(e=>{e.ok&&this.setState({revisions:this.state.revisions.map(t=>t._id==e.revision._id?e.revision:t)})}).catch(e=>{})}render(){return n.a.createElement(n.a.Fragment,null,this.state.isLoading&&n.a.createElement("div",{className:"my-5 text-center"},n.a.createElement("i",{className:"fa fa-lg fa-spinner fa-pulse mx-auto text-muted"})),this.state.errorMessage&&n.a.createElement("div",{className:"my-5"},n.a.createElement("div",{className:"text-danger"},this.state.errorMessage)),this.state.isLoaded&&n.a.createElement(E,{t:this.props.t,revisions:this.state.revisions,diffOpened:this.state.diffOpened,getPreviousRevision:this.getPreviousRevision,onDiffOpenClicked:this.onDiffOpenClicked}))}}v.propTypes={t:r.a.func.isRequired,pageId:r.a.string,crowi:r.a.object.isRequired};t.a=Object(c.c)()(v)},"./src/client/js/components/PagePathAutoComplete.jsx":function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return c}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/growi-commons/src/index.js"),l=a("./src/client/js/components/SearchTypeahead.jsx");class c extends n.a.Component{constructor(e){super(e),this.state={},this.crowi=this.props.crowi,this.onSubmit=this.onSubmit.bind(this),this.getKeywordOnInit=this.getKeywordOnInit.bind(this)}componentDidMount(){}componentWillUnmount(){}onSubmit(t){const a=this.rootDom.closest("form");e(a).submit()}getKeywordOnInit(e){return this.props.addTrailingSlash?o.pathUtils.addTrailingSlash(e):o.pathUtils.removeTrailingSlash(e)}render(){return n.a.createElement("div",{ref:e=>{this.rootDom=e}},n.a.createElement(l.a,{ref:this.searchTypeaheadDom,crowi:this.crowi,onSubmit:this.onSubmit,inputName:"new_path",emptyLabelExceptError:null,placeholder:"Input page path",keywordOnInit:this.getKeywordOnInit(this.props.initializedPath)}))}}c.propTypes={crowi:r.a.object.isRequired,initializedPath:r.a.string,addTrailingSlash:r.a.bool},c.defaultProps={initializedPath:"/"}}).call(this,a("jquery"))},"./src/client/js/components/PageStatusAlert.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./src/client/js/services/AppContainer.js"),c=a("./src/client/js/services/PageContainer.js"),d=a("./src/client/js/components/UnstatedUtils.jsx");class h extends n.a.Component{constructor(e){super(e),this.state={},this.renderSomeoneEditingAlert=this.renderSomeoneEditingAlert.bind(this),this.renderDraftExistsAlert=this.renderDraftExistsAlert.bind(this),this.renderUpdatedAlert=this.renderUpdatedAlert.bind(this)}componentWillMount(){this.props.appContainer.registerComponentInstance("PageStatusAlert",this)}refreshPage(){window.location.reload()}renderSomeoneEditingAlert(){return n.a.createElement("div",{className:"alert-hackmd-someone-editing myadmin-alert alert-success myadmin-alert-bottom alertbottom2"},n.a.createElement("i",{className:"icon-fw icon-people"}),"Someone editing this page on HackMD ",n.a.createElement("i",{className:"fa fa-angle-double-right"}),"",n.a.createElement("a",{href:"#hackmd"},"Open HackMD Editor"))}renderDraftExistsAlert(e){return n.a.createElement("div",{className:"alert-hackmd-draft-exists myadmin-alert alert-success myadmin-alert-bottom alertbottom2"},n.a.createElement("i",{className:"icon-fw icon-pencil"}),"This page has a draft on HackMD ",n.a.createElement("i",{className:"fa fa-angle-double-right"}),"",n.a.createElement("a",{href:"#hackmd"},"Open HackMD Editor"))}renderUpdatedAlert(){const{t:e}=this.props,t=e("edited this page"),a=e("Load latest");return n.a.createElement("div",{className:"alert-revision-outdated myadmin-alert alert-warning myadmin-alert-bottom alertbottom2"},n.a.createElement("i",{className:"icon-fw icon-bulb"}),this.props.pageContainer.state.lastUpdateUsername," ",t,"",n.a.createElement("i",{className:"fa fa-angle-double-right"}),"",n.a.createElement("a",{href:"#",onClick:this.refreshPage},a))}render(){let e=n.a.createElement(n.a.Fragment,null);const{revisionId:t,revisionIdHackmdSynced:a,remoteRevisionId:s,hasDraftOnHackmd:i,isHackmdDraftUpdatingInRealtime:r}=this.props.pageContainer.state;return a!==s&&t!==s?e=this.renderUpdatedAlert():r?e=this.renderSomeoneEditingAlert():i&&(e=this.renderDraftExistsAlert()),e}}h.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(l.a).isRequired,pageContainer:r.a.instanceOf(c.a).isRequired},t.a=Object(o.c)()(e=>Object(d.a)(h,e,[l.a,c.a]))},"./src/client/js/components/PageTimeline.jsx":function(e,t,a){"use strict";(function(e){var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./node_modules/entities/lib/index.js"),c=a("./src/client/js/services/AppContainer.js"),d=a("./src/client/js/components/UnstatedUtils.jsx"),h=a("./src/client/js/components/Page/RevisionLoader.jsx");class p extends n.a.Component{constructor(e){super(e);const{appContainer:t}=this.props;this.state={isEnabled:t.getConfig().isEnabledTimeline,isInitialized:!1,pages:this.props.pages}}componentWillMount(){if(!this.state.isEnabled)return;const{appContainer:e}=this.props;this.growiRenderer=e.getRenderer("timeline"),this.initBsTab()}initBsTab(){e('a[data-toggle="tab"][href="#view-timeline"]').on("shown.bs.tab",()=>{if(this.state.isInitialized)return;const e=document.getElementById("page-timeline-data");if(null==e||0===e.text.length)return;const t=this.extractDataFromDom();this.setState({isInitialized:!0,pages:t})})}extractDataFromDom(){const e=document.getElementById("page-timeline-data");if(null==e||0===e.text.length)return null;let t=JSON.parse(e.text);return t=t.map(e=>(e.path=decodeURIComponent(l.decodeHTML(e.path)),e))}render(){if(!this.state.isEnabled)return n.a.createElement(n.a.Fragment,null);const{pages:e}=this.state;return null==e?n.a.createElement(n.a.Fragment,null):e.map(e=>n.a.createElement("div",{className:"timeline-body",key:`key-${e.id}`},n.a.createElement("div",{className:"panel panel-timeline"},n.a.createElement("div",{className:"panel-heading"},n.a.createElement("a",{href:e.path},e.path)),n.a.createElement("div",{className:"panel-body"},n.a.createElement(h.a,{lazy:!0,growiRenderer:this.growiRenderer,pageId:e.id,revisionId:e.revision})))))}}p.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(c.a).isRequired,pages:r.a.arrayOf(r.a.object)};t.a=Object(o.c)()(e=>Object(d.a)(p,e,[c.a]))}).call(this,a("jquery"))},"./src/client/js/components/RecentCreated/RecentCreated.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/client/js/components/UnstatedUtils.jsx"),l=a("./src/client/js/services/AppContainer.js"),c=a("./src/client/js/services/PageContainer.js"),d=a("./src/client/js/components/PaginationWrapper.jsx"),h=a("./src/client/js/components/PageList/Page.jsx");class p extends n.a.Component{constructor(e){super(e),this.state={pages:[],activePage:1,totalPages:0,pagingLimit:1/0},this.handlePage=this.handlePage.bind(this)}componentWillMount(){this.getRecentCreatedList(1)}async handlePage(e){await this.getRecentCreatedList(e)}getRecentCreatedList(e){const{appContainer:t,pageContainer:a}=this.props,{pageId:s}=a.state,n=t.currentUserId,i=t.getConfig().recentCreatedLimit,r=(e-1)*i;this.props.appContainer.apiGet("/pages.recentCreated",{page_id:s,user:n,limit:i,offset:r}).then(t=>{const a=t.totalCount,s=t.pages,n=e;this.setState({pages:s,activePage:n,totalPages:a,pagingLimit:i})})}generatePageList(e){return e.map(e=>n.a.createElement(h.a,{page:e,key:`recent-created:list-view:${e._id}`}))}render(){const e=this.generatePageList(this.state.pages);return n.a.createElement("div",{className:"page-list-container-create"},n.a.createElement("ul",{className:"page-list-ul page-list-ul-flat"},e),n.a.createElement(d.a,{activePage:this.state.activePage,changePage:this.handlePage,totalItemsCount:this.state.totalPages,pagingLimit:this.state.pagingLimit}))}}p.propTypes={appContainer:r.a.instanceOf(l.a).isRequired,pageContainer:r.a.instanceOf(c.a).isRequired},t.a=e=>Object(o.a)(p,e,[l.a,c.a])},"./src/client/js/components/SavePageControls.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./node_modules/react-bootstrap/es/ButtonToolbar.js"),c=a("./node_modules/react-bootstrap/es/SplitButton.js"),d=a("./node_modules/react-bootstrap/es/MenuItem.js"),h=a("./src/lib/service/logger/index.js"),p=a.n(h),m=a("./src/client/js/services/PageContainer.js"),u=a("./src/client/js/services/AppContainer.js"),g=a("./src/client/js/services/EditorContainer.js"),f=a("./src/client/js/components/UnstatedUtils.jsx"),b=a("./src/client/js/components/SlackNotification.jsx"),E=a("./src/client/js/components/SavePageControls/GrantSelector.jsx");const C=p()("growi:SavePageControls");class v extends n.a.Component{constructor(e){super(e);const t=this.props.appContainer.getConfig();this.hasSlackConfig=t.hasSlackConfig,this.isAclEnabled=t.isAclEnabled,this.slackEnabledFlagChangedHandler=this.slackEnabledFlagChangedHandler.bind(this),this.slackChannelsChangedHandler=this.slackChannelsChangedHandler.bind(this),this.updateGrantHandler=this.updateGrantHandler.bind(this),this.save=this.save.bind(this),this.saveAndOverwriteScopesOfDescendants=this.saveAndOverwriteScopesOfDescendants.bind(this)}slackEnabledFlagChangedHandler(e){this.props.editorContainer.setState({isSlackEnabled:e})}slackChannelsChangedHandler(e){this.props.editorContainer.setState({slackChannels:e})}updateGrantHandler(e){this.props.editorContainer.setState(e)}async save(){const{pageContainer:e,editorContainer:t}=this.props;t.disableUnsavedWarning();try{await e.saveAndReload(t.getCurrentOptionsToSave())}catch(t){C.error("failed to save",t),e.showErrorToastr(t)}}saveAndOverwriteScopesOfDescendants(){const{pageContainer:e,editorContainer:t}=this.props;t.disableUnsavedWarning();const a=Object.assign(t.getCurrentOptionsToSave(),{overwriteScopesOfDescendants:!0});e.saveAndReload(a)}render(){const{t:e,pageContainer:t,editorContainer:a}=this.props,s="/"===t.state.path,i=null==t.state.pageId?e("Create"):e("Update"),r=e("page_edit.overwrite_scopes",{operation:i});return n.a.createElement("div",{className:"d-flex align-items-center form-inline"},this.hasSlackConfig&&n.a.createElement("div",{className:"mr-2"},n.a.createElement(b.a,{isSlackEnabled:a.state.isSlackEnabled,slackChannels:a.state.slackChannels,onEnabledFlagChange:this.slackEnabledFlagChangedHandler,onChannelChange:this.slackChannelsChangedHandler})),this.isAclEnabled&&n.a.createElement("div",{className:"mr-2"},n.a.createElement(E.a,{disabled:s,grant:a.state.grant,grantGroupId:a.state.grantGroupId,grantGroupName:a.state.grantGroupName,onUpdateGrant:this.updateGrantHandler})),n.a.createElement(l.a,null,n.a.createElement(c.a,{id:"spl-btn-submit",bsStyle:"primary",className:"btn-submit",dropup:!0,pullRight:!0,onClick:this.save,title:i},n.a.createElement(d.a,{eventKey:"1",onClick:this.saveAndOverwriteScopesOfDescendants},r))))}}v.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(u.a).isRequired,pageContainer:r.a.instanceOf(m.a).isRequired,editorContainer:r.a.instanceOf(g.a).isRequired},t.a=Object(o.c)()(e=>Object(f.a)(v,e,[u.a,m.a,g.a]))},"./src/client/js/components/SavePageControls/GrantSelector.jsx":function(e,t,a){"use strict";(function(e){var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./node_modules/react-bootstrap/es/FormGroup.js"),c=a("./node_modules/react-bootstrap/es/FormControl.js"),d=a("./node_modules/react-bootstrap/es/ListGroup.js"),h=a("./node_modules/react-bootstrap/es/ListGroupItem.js"),p=a("./node_modules/react-bootstrap/es/Modal.js"),m=a("./src/client/js/services/AppContainer.js"),u=a("./src/client/js/components/UnstatedUtils.jsx");const g="specifiedGroup";class f extends n.a.Component{constructor(e){super(e),this.availableGrants=[{grant:1,iconClass:"icon-people",styleClass:"",label:"Public"},{grant:2,iconClass:"icon-link",styleClass:"text-info",label:"Anyone with the link"},{grant:4,iconClass:"icon-lock",styleClass:"text-danger",label:"Just me"},{grant:5,iconClass:"icon-options",styleClass:"",label:"Only inside the group"},{grant:5,iconClass:"icon-options",styleClass:"",label:"Reselect the group"}],this.state={userRelatedGroups:[],isSelectGroupModalShown:!1,grant:this.props.grant,grantGroup:null},null!=this.props.grantGroupId&&(this.state.grantGroup={_id:this.props.grantGroupId,name:this.props.grantGroupName}),this.xss=window.xss,this.showSelectGroupModal=this.showSelectGroupModal.bind(this),this.hideSelectGroupModal=this.hideSelectGroupModal.bind(this),this.getGroupName=this.getGroupName.bind(this),this.changeGrantHandler=this.changeGrantHandler.bind(this),this.groupListItemClickHandler=this.groupListItemClickHandler.bind(this)}componentDidUpdate(t,a){null!=this.state.grantGroup&&(this.grantSelectorInputEl.value=g),e(".grant-selector .selectpicker").selectpicker("refresh"),e(".grant-selector .group-name").text(this.getGroupName())}showSelectGroupModal(){this.retrieveUserGroupRelations(),this.setState({isSelectGroupModalShown:!0})}hideSelectGroupModal(){this.setState({isSelectGroupModalShown:!1})}getGroupName(){const e=this.state.grantGroup;return e?this.xss.process(e.name):""}retrieveUserGroupRelations(){this.props.appContainer.apiGet("/me/user-group-relations").then(e=>e.userGroupRelations).then(e=>{const t=e.map(e=>e.relatedGroup);this.setState({userRelatedGroups:t})})}changeGrantHandler(){const e=+this.grantSelectorInputEl.value;if(5===e)return this.showSelectGroupModal(),void(this.grantSelectorInputEl.value=this.state.grant);this.setState({grant:e,grantGroup:null}),null!=this.props.onUpdateGrant&&this.props.onUpdateGrant({grant:e,grantGroupId:null,grantGroupName:null})}groupListItemClickHandler(e){this.setState({grant:5,grantGroup:e}),null!=this.props.onUpdateGrant&&this.props.onUpdateGrant({grant:5,grantGroupId:e._id,grantGroupName:e.name}),this.hideSelectGroupModal()}renderGrantSelector(){const{t:e}=this.props;let t=0,a=this.state.grant;const s=this.availableGrants.map(a=>{const s=`<i class="icon icon-fw ${a.iconClass} ${a.styleClass}"></i> <span class="${a.styleClass}">${e(a.label)}</span>`;return n.a.createElement("option",{key:t++,value:a.grant,"data-content":s},e(a.label))}),i=this.state.grantGroup;null!=i?(a=g,s.splice(3,1)):s.splice(4,1),s.push(n.a.createElement("option",{key:"specifiedGroupKey",value:g,style:{display:i?"inherit":"none"},"data-content":`<i class="icon icon-fw icon-organization text-success"></i> <span class="group-name text-success">${this.getGroupName()}</span>`},this.getGroupName()));return n.a.createElement(l.a,{className:"grant-selector m-b-0"},n.a.createElement(c.a,{disabled:this.props.disabled,componentClass:"select",placeholder:"select",defaultValue:a,bsClass:"form-control-dummy",className:"btn-group-sm selectpicker",onChange:this.changeGrantHandler,inputRef:e=>{this.grantSelectorInputEl=e}},s))}renderSelectGroupModal(){const e=0===this.state.userRelatedGroups.length?n.a.createElement("div",null,n.a.createElement("h4",null,"There is no group to which you belong."),this.props.appContainer.isAdmin&&n.a.createElement("p",null,n.a.createElement("a",{href:"/admin/user-groups"},n.a.createElement("i",{className:"icon icon-fw icon-login"})," Manage Groups"))):n.a.createElement(d.a,null,(()=>this.state.userRelatedGroups.map(e=>n.a.createElement(h.a,{key:e._id,header:e.name,onClick:()=>{this.groupListItemClickHandler(e)}},"(TBD) List group members")))());return n.a.createElement(p.a,{className:"select-grant-group",container:this,show:this.state.isSelectGroupModalShown,onHide:this.hideSelectGroupModal},n.a.createElement(p.a.Header,{closeButton:!0},n.a.createElement(p.a.Title,null,"Select a Group")),n.a.createElement(p.a.Body,null,e))}render(){return n.a.createElement(n.a.Fragment,null,this.renderGrantSelector(),!this.props.disabled&&this.renderSelectGroupModal())}}f.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(m.a).isRequired,disabled:r.a.bool,grant:r.a.number.isRequired,grantGroupId:r.a.string,grantGroupName:r.a.string,onUpdateGrant:r.a.func},t.a=Object(o.c)()(e=>Object(u.a)(f,e,[m.a]))}).call(this,a("jquery"))},"./src/client/js/components/SearchPage.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./src/client/js/components/UnstatedUtils.jsx"),c=a("./src/client/js/services/AppContainer.js"),d=a("./src/client/js/util/apiNotification.js"),h=a("./node_modules/react-bootstrap/es/FormGroup.js"),p=a("./node_modules/react-bootstrap/es/Button.js"),m=a("./node_modules/react-bootstrap/es/InputGroup.js"),u=a("./src/client/js/components/SearchForm.jsx");class g extends n.a.Component{constructor(e){super(e),this.state={keyword:this.props.keyword,searchedKeyword:this.props.keyword},this.search=this.search.bind(this),this.onInputChange=this.onInputChange.bind(this)}search(){const e=this.state.keyword;this.props.onSearchFormChanged({keyword:e}),this.setState({searchedKeyword:e})}onInputChange(e){this.setState({keyword:e})}render(){return n.a.createElement(h.a,null,n.a.createElement(m.a,null,n.a.createElement(u.a,{t:this.props.t,onSubmit:this.search,keyword:this.state.searchedKeyword,onInputChange:this.onInputChange}),n.a.createElement(m.a.Button,{className:""},n.a.createElement(p.a,{onClick:this.search},n.a.createElement("i",{className:"icon-magnifier"})))))}}g.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(c.a).isRequired,keyword:r.a.string,onSearchFormChanged:r.a.func.isRequired},g.defaultProps={};var f=e=>Object(l.a)(g,e,[c.a]),b=a("./src/client/js/components/SearchPage/SearchResult.jsx");class E extends n.a.Component{constructor(e){super(e),this.state={searchingKeyword:decodeURI(this.props.query.q)||"",searchedKeyword:"",searchedPages:[],searchResultMeta:{}},this.search=this.search.bind(this),this.changeURL=this.changeURL.bind(this)}componentDidMount(){const e=this.state.searchingKeyword;""!==e&&this.search({keyword:e})}static getQueryByLocation(e){const t=e.search||"",a={};return t.replace(/^\?/,"").split("&").forEach(e=>{const t=e.split("=");a[t[0]]=decodeURIComponent(t[1]).replace(/\+/g," ")}),a}changeURL(e,t){let a=window.location.hash||"";(t||""!==this.state.searchedKeyword)&&(a=""),window.history&&window.history.pushState&&window.history.pushState("",`Search - ${e}`,`/_search?q=${e}${a}`)}search(e){const t=e.keyword;if(""===t)return this.setState({searchingKeyword:"",searchedPages:[],searchResultMeta:{}}),!0;this.setState({searchingKeyword:t}),this.props.appContainer.apiGet("/search",{q:t}).then(e=>{this.changeURL(t),this.setState({searchedKeyword:t,searchedPages:e.data,searchResultMeta:e.meta})}).catch(e=>{Object(d.a)(e)})}render(){return n.a.createElement("div",null,n.a.createElement("div",{className:"search-page-input"},n.a.createElement(f,{t:this.props.t,onSearchFormChanged:this.search,keyword:this.state.searchingKeyword})),n.a.createElement(b.a,{pages:this.state.searchedPages,searchingKeyword:this.state.searchingKeyword,searchResultMeta:this.state.searchResultMeta}))}}E.propTypes={t:r.a.func.isRequired,appContainer:r.a.instanceOf(c.a).isRequired,query:r.a.object},E.defaultProps={query:E.getQueryByLocation(window.location||{})};t.a=Object(o.c)()(e=>Object(l.a)(E,e,[c.a]))},"./src/client/js/components/SearchPage/DeletePageListModal.jsx":function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-bootstrap/es/Button.js"),l=a("./node_modules/react-bootstrap/es/Modal.js"),c=a("./node_modules/react-bootstrap/es/Checkbox.js");class d extends n.a.Component{static get OMIT_BODY_THRES(){return 400}componentWillMount(){}render(){if(null==this.props.pages||0===this.props.pages.length)return n.a.createElement("div",null);const e=this.props.pages.map(e=>n.a.createElement("li",{key:e._id},e.path));return n.a.createElement(l.a,{show:this.props.isShown,onHide:this.props.cancel,className:"page-list-delete-modal"},n.a.createElement(l.a.Header,{closeButton:!0},n.a.createElement(l.a.Title,null,"Deleting pages:")),n.a.createElement(l.a.Body,null,n.a.createElement("ul",null,e)),n.a.createElement(l.a.Footer,null,n.a.createElement("div",{className:"d-flex justify-content-between"},n.a.createElement("span",{className:"text-danger"},this.props.errorMessage),n.a.createElement("span",{className:"d-flex align-items-center"},n.a.createElement(c.a,{className:"text-danger",onClick:this.props.toggleDeleteCompletely,inline:!0},"Delete completely"),n.a.createElement("span",{className:"m-l-10"},n.a.createElement(o.a,{onClick:this.props.confirmedToDelete},n.a.createElement("i",{className:"icon-trash"}),"Delete"))))))}}d.propTypes={isShown:r.a.bool.isRequired,pages:r.a.array,errorMessage:r.a.string,cancel:r.a.func.isRequired,confirmedToDelete:r.a.func.isRequired,toggleDeleteCompletely:r.a.func.isRequired}},"./src/client/js/components/SearchPage/SearchResult.jsx":function(e,t,a){"use strict";(function(e){var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/toastr/toastr.js"),l=a("./src/client/js/components/PageList/Page.jsx"),c=a("./src/client/js/components/SearchPage/SearchResultList.jsx"),d=a("./src/client/js/components/SearchPage/DeletePageListModal.jsx"),h=a("./src/client/js/services/AppContainer.js"),p=a("./src/client/js/components/UnstatedUtils.jsx");class m extends n.a.Component{constructor(e){super(e),this.state={deletionMode:!1,selectedPages:new Set,isDeleteCompletely:void 0,isDeleteConfirmModalShown:!1,errorMessageForDeleting:void 0},this.toggleDeleteCompletely=this.toggleDeleteCompletely.bind(this),this.deleteSelectedPages=this.deleteSelectedPages.bind(this),this.closeDeleteConfirmModal=this.closeDeleteConfirmModal.bind(this)}isNotSearchedYet(){return!this.props.searchResultMeta.took}isNotFound(){return""!==this.props.searchingKeyword&&0===this.props.pages.length}isError(){return null!==this.props.searchError}toggleCheckbox(e){this.state.selectedPages.has(e)?this.state.selectedPages.delete(e):this.state.selectedPages.add(e),this.setState({isDeleteConfirmModalShown:!1}),this.setState({selectedPages:this.state.selectedPages})}isAllSelected(){return this.state.selectedPages.size===this.props.pages.length}handleAllSelect(){this.isAllSelected()?this.state.selectedPages.clear():(this.state.selectedPages.clear(),this.props.pages.map(e=>{this.state.selectedPages.add(e)})),this.setState({selectedPages:this.state.selectedPages})}handleDeletionModeChange(){this.state.selectedPages.clear(),this.setState({deletionMode:!this.state.deletionMode})}toggleDeleteCompletely(){this.setState({isDeleteCompletely:!this.state.isDeleteCompletely||void 0})}deleteSelectedPages(){const e=this.state.isDeleteCompletely;Promise.all(Array.from(this.state.selectedPages).map(t=>new Promise((a,s)=>{const n=t._id,i=t.revision._id;this.props.appContainer.apiPost("/pages.remove",{page_id:n,revision_id:i,completely:e}).then(e=>e.ok?(this.state.selectedPages.delete(t),a()):s()).catch(e=>(console.log(e.message),this.setState({errorMessageForDeleting:e.message}),s()))}))).then(()=>{window.location.reload()}).catch(e=>{o.error(e,"Error occured",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"3000"})})}showDeleteConfirmModal(){this.setState({isDeleteConfirmModalShown:!0})}closeDeleteConfirmModal(){this.setState({isDeleteConfirmModalShown:!1,errorMessageForDeleting:void 0})}render(){if(this.isError())return n.a.createElement("div",{className:"content-main"},n.a.createElement("i",{className:"searcing fa fa-warning"})," Error on searching.");if(this.isNotSearchedYet())return n.a.createElement("div",null);if(this.isNotFound()){let e="";return null!=this.props.tree&&(e=` under "${this.props.tree}"`),n.a.createElement("div",{className:"content-main"},n.a.createElement("i",{className:"icon-fw icon-info"}),' No page found with "',this.props.searchingKeyword,'"',e)}let t="",a="";this.state.deletionMode?(t=n.a.createElement("div",{className:"btn-group"},n.a.createElement("button",{type:"button",className:"btn btn-rounded btn-default btn-xs",onClick:()=>this.handleDeletionModeChange()},n.a.createElement("i",{className:"icon-ban"})," Cancel"),n.a.createElement("button",{type:"button",className:"btn btn-rounded btn-danger btn-xs",onClick:()=>this.showDeleteConfirmModal(),disabled:0===this.state.selectedPages.size},n.a.createElement("i",{className:"icon-trash"})," Delete")),a=n.a.createElement("div",null,n.a.createElement("label",null,n.a.createElement("input",{type:"checkbox",onClick:()=>this.handleAllSelect(),checked:this.isAllSelected()}),"Check All"))):t=n.a.createElement("div",{className:"btn-group"},n.a.createElement("button",{type:"button",className:"btn btn-default btn-rounded btn-xs",onClick:()=>this.handleDeletionModeChange()},n.a.createElement("i",{className:"ti-check-box"})," DeletionMode"));const s=this.props.pages.map(e=>{const t=`#${e._id}`;return n.a.createElement(l.a,{page:e,linkTo:t,key:e._id},this.state.deletionMode&&n.a.createElement("input",{type:"checkbox",className:"search-result-list-delete-checkbox",value:t,checked:this.state.selectedPages.has(e),onClick:()=>this.toggleCheckbox(e)}),n.a.createElement("div",{className:"page-list-option"},n.a.createElement("a",{href:e.path},n.a.createElement("i",{className:"icon-login"}))))});return setTimeout(()=>{e("#search-result-list > nav").affix({offset:{top:50}})},1200),n.a.createElement("div",{className:"content-main"},n.a.createElement("div",{className:"search-result row",id:"search-result"},n.a.createElement("div",{className:"col-md-4 hidden-xs hidden-sm page-list search-result-list",id:"search-result-list"},n.a.createElement("nav",{"data-spy":"affix","data-offset-top":"50"},n.a.createElement("div",{className:"pull-right"},t,a),n.a.createElement("div",{className:"search-result-meta"},n.a.createElement("i",{className:"icon-magnifier"})," Found ",this.props.searchResultMeta.total,' pages with "',this.props.searchingKeyword,'"'),n.a.createElement("div",{className:"clearfix"}),n.a.createElement("div",{className:"page-list"},n.a.createElement("ul",{className:"page-list-ul page-list-ul-flat nav"},s)))),n.a.createElement("div",{className:"col-md-8 search-result-content",id:"search-result-content"},n.a.createElement(c.a,{pages:this.props.pages,searchingKeyword:this.props.searchingKeyword}))),n.a.createElement(d.a,{isShown:this.state.isDeleteConfirmModalShown,pages:Array.from(this.state.selectedPages),errorMessage:this.state.errorMessageForDeleting,cancel:this.closeDeleteConfirmModal,confirmedToDelete:this.deleteSelectedPages,toggleDeleteCompletely:this.toggleDeleteCompletely}))}}m.propTypes={appContainer:r.a.instanceOf(h.a).isRequired,pages:r.a.array.isRequired,searchingKeyword:r.a.string.isRequired,searchResultMeta:r.a.object.isRequired,searchError:r.a.object,tree:r.a.string},m.defaultProps={searchError:null},t.a=e=>Object(p.a)(m,e,[h.a])}).call(this,a("jquery"))},"./src/client/js/components/SearchPage/SearchResultList.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./src/client/js/components/Page/RevisionLoader.jsx"),l=a("./src/client/js/services/AppContainer.js"),c=a("./src/client/js/components/UnstatedUtils.jsx");class d extends n.a.Component{constructor(e){super(e),this.growiRenderer=this.props.appContainer.getRenderer("searchresult")}render(){const e=this.props.pages.map(e=>{const t=null!=e.tags&&e.tags.length>0;return n.a.createElement("div",{id:e._id,key:e._id,className:"search-result-page mb-5"},n.a.createElement("h2",null,n.a.createElement("a",{href:e.path},e.path),t&&n.a.createElement("div",{className:"mt-1 small"},n.a.createElement("i",{className:"tag-icon icon-tag"})," ",e.tags.join(", "))),n.a.createElement(o.a,{growiRenderer:this.growiRenderer,pageId:e._id,pagePath:e.path,revisionId:e.revision,highlightKeywords:this.props.searchingKeyword}))});return n.a.createElement("div",null,e)}}d.propTypes={appContainer:r.a.instanceOf(l.a).isRequired,pages:r.a.array.isRequired,searchingKeyword:r.a.string.isRequired},d.defaultProps={},t.a=e=>Object(c.a)(d,e,[l.a])},"./src/client/js/components/SlackNotification.jsx":function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i);class o extends n.a.Component{constructor(e){super(e),this.updateCheckboxHandler=this.updateCheckboxHandler.bind(this),this.updateSlackChannelsHandler=this.updateSlackChannelsHandler.bind(this)}updateCheckboxHandler(e){const t=e.target.checked;null!=this.props.onEnabledFlagChange&&this.props.onEnabledFlagChange(t)}updateSlackChannelsHandler(e){const t=e.target.value;null!=this.props.onChannelChange&&this.props.onChannelChange(t)}render(){return n.a.createElement("div",{className:"input-group input-group-sm input-group-slack extended-setting"},n.a.createElement("label",{className:"input-group-addon"},n.a.createElement("img",{id:"slack-mark-white",alt:"slack-mark",src:"/images/icons/slack/mark-monochrome_white.svg",width:"18",height:"18"}),n.a.createElement("img",{id:"slack-mark-black",alt:"slack-mark",src:"/images/icons/slack/mark-monochrome_black.svg",width:"18",height:"18"}),n.a.createElement("input",{type:"checkbox",value:"1",checked:this.props.isSlackEnabled,onChange:this.updateCheckboxHandler})),n.a.createElement("input",{className:"form-control",type:"text",value:this.props.slackChannels,placeholder:"slack channel name","data-toggle":"popover",title:"Slack","data-content":"","data-trigger":"focus","data-placement":"top",onChange:this.updateSlackChannelsHandler}))}}o.propTypes={isSlackEnabled:r.a.bool.isRequired,slackChannels:r.a.string.isRequired,onEnabledFlagChange:r.a.func,onChannelChange:r.a.func}},"./src/client/js/components/TableOfContents.jsx":function(e,t,a){"use strict";(function(e){var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./node_modules/throttle-debounce/index.esm.js"),c=a("./src/client/js/services/AppContainer.js"),d=a("./src/client/js/services/PageContainer.js"),h=a("./src/client/js/components/UnstatedUtils.jsx");const p=190,m=105;class u extends n.a.Component{constructor(e){super(e),this.resetScrollbarDebounced=Object(l.a)(100,this.resetScrollbar)}componentDidUpdate(){const{layoutType:t}=this.props.appContainer.config;if("crowi"===t)return;let a=p;"kibela"===t&&(a=m),this.resetScrollbar(a),window.addEventListener("resize",e=>{this.resetScrollbarDebounced(a)}),e("#revision-toc").on("affixed.bs.affix",()=>{this.resetScrollbar(this.getCurrentRevisionTocTop())}),e("#revision-toc").on("affixed-top.bs.affix",()=>{this.resetScrollbar(a)})}getCurrentRevisionTocTop(){return document.querySelector(".revision-toc").getBoundingClientRect().top}resetScrollbar(t){const a=document.querySelector(".revision-toc .markdownIt-TOC");if(null==a)return;const s=window.innerHeight-t-20;s<a.getBoundingClientRect().height+15?e("#revision-toc-content").slimScroll({railVisible:!0,position:"right",height:s}):e("#revision-toc-content").slimScroll({destroy:!0})}render(){const{tocHtml:e}=this.props.pageContainer.state;return n.a.createElement("div",{id:"revision-toc-content",className:"revision-toc-content",dangerouslySetInnerHTML:{__html:e}})}}u.propTypes={appContainer:r.a.instanceOf(c.a).isRequired,pageContainer:r.a.instanceOf(d.a).isRequired},t.a=Object(o.c)()(e=>Object(h.a)(u,e,[c.a,d.a]))}).call(this,a("jquery"))},"./src/client/js/components/TagsList.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-i18next/dist/es/index.js"),l=a("./src/client/js/components/PaginationWrapper.jsx");class c extends n.a.Component{constructor(e){super(e),this.state={tagData:[],activePage:1,totalTags:0,pagingLimit:10},this.handlePage=this.handlePage.bind(this),this.getTagList=this.getTagList.bind(this)}async componentWillMount(){await this.getTagList(1)}async handlePage(e){await this.getTagList(e)}async getTagList(e){const t=this.state.pagingLimit,a=(e-1)*t,s=await this.props.crowi.apiGet("/tags.list",{limit:t,offset:a}),n=s.totalCount,i=s.data,r=e;this.setState({tagData:i,activePage:r,totalTags:n})}generateTagList(e){return e.map(e=>n.a.createElement("a",{key:e.name,href:`/_search?q=tag:${e.name}`,className:"list-group-item"},n.a.createElement("i",{className:"icon-tag mr-2"}),e.name,n.a.createElement("span",{className:"ml-4 list-tag-count label label-default text-muted"},e.count)))}render(){const{t:e}=this.props,t=this.state.tagData.length?null:n.a.createElement("h3",null,e("You have no tag, You can set tags on pages"));return n.a.createElement("div",{className:"text-center"},n.a.createElement("div",{className:"tag-list"},n.a.createElement("ul",{className:"list-group text-left"},this.generateTagList(this.state.tagData)),t),n.a.createElement("div",{className:"tag-list-pagination"},n.a.createElement(l.a,{activePage:this.state.activePage,changePage:this.handlePage,totalItemsCount:this.state.totalTags,pagingLimit:this.state.pagingLimit})))}}c.propTypes={crowi:r.a.object.isRequired,t:r.a.func.isRequired},c.defaultProps={},t.a=Object(o.c)()(c)},"./src/client/js/components/User/UserPictureList.jsx":function(e,t,a){"use strict";var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i),o=a("./node_modules/react-bootstrap/es/OverlayTrigger.js"),l=a("./node_modules/react-bootstrap/es/Tooltip.js"),c=a("./src/client/js/components/UnstatedUtils.jsx"),d=a("./src/client/js/services/AppContainer.js"),h=a("./src/client/js/components/User/UserPicture.jsx");class p extends n.a.Component{constructor(e){super(e);const t=this.props.userIds,a=this.props.users.concat(this.props.appContainer.findUserByIds(t));this.state={users:a}}render(){const e=this.state.users.map(e=>{const t=n.a.createElement(l.a,{id:`tooltip-${e._id}`},"@",e.username,n.a.createElement("br",null),e.name);return n.a.createElement(o.a,{key:e._id,overlay:t,placement:"bottom"},n.a.createElement("span",{key:`span-${e._id}`},n.a.createElement(h.a,{user:e,size:"xs",ref:`userPicture-${e._id}`})))});return n.a.createElement("span",null,e)}}p.propTypes={appContainer:r.a.instanceOf(d.a).isRequired,userIds:r.a.arrayOf(r.a.string),users:r.a.arrayOf(r.a.object)},p.defaultProps={userIds:[],users:[]},t.a=e=>Object(c.a)(p,e,[d.a])},"./src/client/js/components/User/Username.jsx":function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var s=a("./node_modules/react/index.js"),n=a.n(s),i=a("./node_modules/prop-types/index.js"),r=a.n(i);class o extends n.a.Component{renderForNull(){return n.a.createElement("span",null,"anyone")}render(){const{user:e}=this.props;if(null==e)return this.renderForNull();const t=e.name||"(no name)",a=e.username,s=`/user/${e.username}`;return n.a.createElement("a",{href:s},t," (@",a,")")}}o.propTypes={user:r.a.oneOfType([r.a.object,r.a.string])}},"./src/client/js/models/MarkdownTable.js":function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var s=a("./node_modules/markdown-table/index.js"),n=a.n(s),i=a("./node_modules/string-width/index.js"),r=a.n(i),o=a("./node_modules/csv-to-markdown-table/lib/CsvToMarkdown.js"),l=a.n(o);const c=/^[-:|][-:|\s]*$/,d=/^[^-:]*$/,h=/^\|[^\r\n]*|[^\r\n]*\|$|([^|\r\n]+\|[^|\r\n]*)+/,p=new window.DOMParser,m={stringLength:r.a};class u{constructor(e,t){this.table=e||[],this.options=Object.assign(t||{},m),this.toString=this.toString.bind(this)}toString(){return n()(this.table,this.options)}clone(){const e=[];for(let t=0;t<this.table.length;t++)e.push([].concat(this.table[t]));return new u(e,this.options)}normalizeCells(){for(let e=0;e<this.table.length;e++)for(let t=0;t<this.table[e].length;t++)null!=this.table[e][t]?this.table[e][t]=this.table[e][t].trim().replace(/\r?\n/g," "):this.table[e][t]="";return this}static fromHTMLTableTag(e){const t=p.parseFromString(e,"application/xml");if(t.querySelector("parsererror"))throw new Error(t.documentElement.innerHTML);const a=t.querySelector("table").querySelectorAll("tr"),s=[];let n=0;for(let e=0;e<a.length;e++){const t=[],i=a[e].querySelectorAll("th,td");for(let e=0;e<i.length;e++)t.push(i[e].innerHTML);s.push(t),n<t.length&&(n=t.length)}const i=[];for(let e=0;e<n;e++)i.push("");return new u(s,{align:i})}static fromDSV(e,t){return u.fromMarkdownString(l()(e,t,!0))}static fromMarkdownString(e){const t=e.split(/(\r\n|\r|\n)/),a=[];let s=[];for(let e=0;e<t.length;e++){const n=t[e];if(c.test(n)&&!d.test(n)){const e=[{align:"c",regex:/^:-+:$/},{align:"l",regex:/^:-+$/},{align:"r",regex:/^-+:$/}];let t="";s=(t=(t=n.replace(/^\||\|$/g,"")).replace(/\s*/g,"")).split(/\|/).map(t=>{const a=e.find(e=>t.match(e.regex));return null!=a?a.align:""})}else if(h.test(n)){let e="";const t=(e=(e=n.replace(/\s*\|\s*/g,"|")).replace(/^\||\|$/g,"")).split(/\|/);a.push(t)}}return new u(a,{align:s})}}},"./src/client/js/services/CommentContainer.js":function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var s=a("./node_modules/unstated/lib/unstated.es.js"),n=a("./src/lib/service/logger/index.js");const i=a.n(n)()("growi:services:CommentContainer");class r extends s.a{constructor(e){super(),this.appContainer=e,this.appContainer.registerContainer(this);const t=document.querySelector("#content-main");null!=t?(this.state={comments:[],isSlackEnabled:!1,slackChannels:t.getAttribute("data-slack-channels")||""},this.retrieveComments=this.retrieveComments.bind(this)):i.debug("#content-main element is not exists")}static getClassName(){return"CommentContainer"}getPageContainer(){return this.appContainer.getContainer("PageContainer")}findAndSplice(e){const t=this.state.comments,a=t.indexOf(e);a<0||(t.splice(a,1),this.setState({comments:t}))}retrieveComments(){const{pageId:e}=this.getPageContainer().state;return this.appContainer.apiGet("/comments.get",{page_id:e}).then(e=>{e.ok&&this.setState({comments:e.comments})})}postComment(e,t,a,s,n){const{pageId:i,revisionId:r}=this.getPageContainer().state;return this.appContainer.apiPost("/comments.add",{commentForm:{comment:e,page_id:i,revision_id:r,is_markdown:t,replyTo:a},slackNotificationForm:{isSlackEnabled:s,slackChannels:n}}).then(e=>{if(e.ok)return this.retrieveComments()})}putComment(e,t,a,s){const{pageId:n,revisionId:i}=this.getPageContainer().state;return this.appContainer.apiPost("/comments.update",{commentForm:{comment:e,page_id:n,revision_id:i,is_markdown:t,comment_id:a,author:s}}).then(e=>{if(e.ok)return this.retrieveComments()})}deleteComment(e){return this.appContainer.apiPost("/comments.remove",{comment_id:e._id}).then(t=>{t.ok&&this.findAndSplice(e)})}uploadAttachment(e){const{pageId:t,pagePath:a}=this.getPageContainer().state,s=new FormData;return s.append("file",e),s.append("path",a),s.append("page_id",t),this.appContainer.apiPost("/attachments.add",s)}}},"./src/client/js/services/EditorContainer.js":function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var s=a("./node_modules/unstated/lib/unstated.es.js"),n=a("./src/lib/service/logger/index.js");const i=a.n(n)()("growi:services:EditorContainer");class r extends s.a{constructor(e,t,a){super(),this.appContainer=e,this.appContainer.registerContainer(this);const s=document.querySelector("#content-main");null!=s?(this.state={tags:[],isSlackEnabled:!1,slackChannels:s.getAttribute("data-slack-channels")||"",grant:1,grantGroupId:null,grantGroupName:null,editorOptions:{},previewOptions:{}},this.isSetBeforeunloadEventHandler=!1,this.initStateGrant(),this.initDrafts(),this.initEditorOptions("editorOptions","editorOptions",t),this.initEditorOptions("previewOptions","previewOptions",a)):i.debug("#content-main element is not exists")}static getClassName(){return"EditorContainer"}initStateGrant(){const e=document.getElementById("save-page-controls");if(e){this.state.grant=+e.dataset.grant;const t=e.dataset.grantGroup;null!=t&&t.length>0&&(this.state.grantGroupId=t,this.state.grantGroupName=e.dataset.grantGroupName)}}initDrafts(){this.drafts={};const e=window.localStorage.drafts;if(null!=e)try{this.drafts=JSON.parse(e)}catch(e){window.localStorage.removeItem("drafts")}if(null==this.state.pageId){const e=this.findDraft(this.state.path);null!=e&&(this.state.markdown=e)}}initEditorOptions(e,t,a){const s=window.localStorage[t];let n={};if(null!=s)try{n=JSON.parse(s)}catch(e){this.localStorage.removeItem(t)}this.state[e]=Object.assign(a,n)}saveOptsToLocalStorage(){window.localStorage.setItem("editorOptions",JSON.stringify(this.state.editorOptions)),window.localStorage.setItem("previewOptions",JSON.stringify(this.state.previewOptions))}setCaretLine(e){const t=this.appContainer.getComponentInstance("PageEditor");null!=t&&t.setCaretLine(e)}focusToEditor(){const e=this.appContainer.getComponentInstance("PageEditor");null!=e&&e.focusToEditor()}getCurrentOptionsToSave(){const e={isSlackEnabled:this.state.isSlackEnabled,slackChannels:this.state.slackChannels,grant:this.state.grant,pageTags:this.state.tags};return null!=this.state.grantGroupId&&(e.grantUserGroupId=this.state.grantGroupId),e}showUnsavedWarning(e){return e.returnValue="",""}disableUnsavedWarning(){window.removeEventListener("beforeunload",this.showUnsavedWarning),this.isSetBeforeunloadEventHandler=!1}enableUnsavedWarning(){this.isSetBeforeunloadEventHandler||(window.addEventListener("beforeunload",this.showUnsavedWarning),this.isSetBeforeunloadEventHandler=!0)}clearDraft(e){delete this.drafts[e],window.localStorage.setItem("drafts",JSON.stringify(this.drafts))}clearAllDrafts(){window.localStorage.removeItem("drafts")}saveDraft(e,t){this.drafts[e]=t,window.localStorage.setItem("drafts",JSON.stringify(this.drafts))}findDraft(e){return null!=this.drafts&&this.drafts[e]?this.drafts[e]:null}}},"./src/client/js/services/PageContainer.js":function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return c}));var s=a("./node_modules/unstated/lib/unstated.es.js"),n=a("./src/lib/service/logger/index.js"),i=a.n(n),r=a("./node_modules/entities/lib/index.js"),o=a("./node_modules/toastr/toastr.js");const l=i()("growi:services:PageContainer");class c extends s.a{constructor(e){super(),this.appContainer=e,this.appContainer.registerContainer(this),this.state={};const t=document.querySelector("#content-main");if(null==t)return void l.debug("#content-main element is not exists");const a=t.getAttribute("data-page-revision-id");this.state={markdown:null,pageId:t.getAttribute("data-page-id"),revisionId:a,revisionCreatedAt:+t.getAttribute("data-page-revision-created"),path:t.getAttribute("data-path"),tocHtml:"",isLiked:!1,seenUserIds:[],likerUserIds:[],tags:[],templateTagData:t.getAttribute("data-template-tags")||null,remoteRevisionId:a,revisionIdHackmdSynced:t.getAttribute("data-page-revision-id-hackmd-synced")||null,lastUpdateUsername:void 0,pageIdOnHackmd:t.getAttribute("data-page-id-on-hackmd")||null,hasDraftOnHackmd:!!t.getAttribute("data-page-has-draft-on-hackmd"),isHackmdDraftUpdatingInRealtime:!1},this.initStateMarkdown(),this.initStateOthers(),this.setTocHtml=this.setTocHtml.bind(this),this.save=this.save.bind(this),this.addWebSocketEventHandlers=this.addWebSocketEventHandlers.bind(this),this.addWebSocketEventHandlers()}static getClassName(){return"PageContainer"}initStateMarkdown(){let e="";const t=document.getElementById("raw-text-original");t&&(e=t.innerHTML);const a=r.decodeHTML(e);this.state.markdown=a}initStateOthers(){const e=document.getElementById("like-button");null!=e&&(this.state.isLiked="true"===e.dataset.liked);const t=document.getElementById("seen-user-list");if(null!=t){const e=t.dataset.userIds;this.state.seenUserIds=e.split(",")}const a=document.getElementById("liker-list");if(null!=a){const e=a.dataset.userIds;this.state.likerUserIds=e.split(",")}}setLatestRemotePageData(e,t){this.setState({remoteRevisionId:e.revision._id,revisionIdHackmdSynced:e.revisionHackmdSynced,lastUpdateUsername:t.name})}setTocHtml(e){this.state.tocHtml!==e&&this.setState({tocHtml:e})}updateStateAfterSave(t,a){const{editorMode:s}=this.appContainer.state,n={pageId:t._id,revisionId:t.revision._id,revisionCreatedAt:new Date(t.revision.createdAt).getTime()/1e3,remoteRevisionId:t.revision._id,revisionIdHackmdSynced:t.revisionHackmdSynced,hasDraftOnHackmd:t.hasDraftOnHackmd,markdown:t.revision.body};null!=a&&(n.tags=a),this.setState(n);const i=this.appContainer.getComponentInstance("PageEditor");null!=i&&"builtin"!==s&&i.updateEditorValue(n.markdown);const r=this.appContainer.getComponentInstance("PageEditorByHackmd");null!=r&&"hackmd"!==s&&r.reset(),e('input[name="revision_id"]').val(n.revisionId)}async save(e,t={}){const{editorMode:a}=this.appContainer.state,{pageId:s,path:n}=this.state;let{revisionId:i}=this.state;const r=Object.assign({},t);let o;return"hackmd"===a&&(r.isSyncRevisionToHackmd=!0,i=this.state.revisionIdHackmdSynced),o=null==s?await this.createPage(n,e,r):await this.updatePage(s,i,e,r),this.updateStateAfterSave(o.page,o.tags),o}async saveAndReload(e){if(null==e){throw new Error("'saveAndReload' requires the 'optionsToSave' param")}const{editorMode:t}=this.appContainer.state;if(null==t)return void l.warn("'saveAndReload' requires the 'errorMode' param");const{pageId:a,path:s}=this.state;let{revisionId:n}=this.state;const i=Object.assign({},e);let r,o;if("hackmd"===t){const e=this.appContainer.getComponentInstance("PageEditorByHackmd");r=await e.getMarkdown(),i.isSyncRevisionToHackmd=!0,n=this.state.revisionIdHackmdSynced}else{r=this.appContainer.getComponentInstance("PageEditor").getMarkdown()}return o=null==a?await this.createPage(s,r,i):await this.updatePage(a,n,r,i),this.appContainer.getContainer("EditorContainer").clearDraft(s),window.location.href=s,o}async createPage(e,t,a){const s=this.appContainer.getContainer("WebsocketContainer"),n=Object.assign(a,{socketClientId:s.getSocketClientId(),path:e,body:t}),i=await this.appContainer.apiPost("/pages.create",n);if(!i.ok)throw new Error(i.error);return{page:i.page,tags:i.tags}}async updatePage(e,t,a,s){const n=this.appContainer.getContainer("WebsocketContainer"),i=Object.assign(s,{socketClientId:n.getSocketClientId(),page_id:e,revision_id:t,body:a}),r=await this.appContainer.apiPost("/pages.update",i);if(!r.ok)throw new Error(r.error);return{page:r.page,tags:r.tags}}showSuccessToastr(){o.success(void 0,"Saved successfully",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"1200",extendedTimeOut:"150"})}showErrorToastr(e){o.error(e.message,"Error occured",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"3000"})}addWebSocketEventHandlers(){const e=this,t=this.appContainer.getContainer("WebsocketContainer"),a=t.getWebSocket();a.on("page:create",a=>{null!=a.socketClientId&&a.socketClientId===t.getSocketClientId()||(l.debug({obj:a},"websocket on 'page:create'"),a.page.path===e.state.path&&this.setLatestRemotePageData(a.page,a.user))}),a.on("page:update",a=>{if((null==a.socketClientId||a.socketClientId!==t.getSocketClientId())&&(l.debug({obj:a},"websocket on 'page:update'"),a.page.path===e.state.path)){e.setLatestRemotePageData(a.page,a.user);const t=a.page;e.setState({remoteRevisionId:t.revision._id,revisionIdHackmdSynced:t.revisionHackmdSynced,hasDraftOnHackmd:t.hasDraftOnHackmd})}}),a.on("page:delete",a=>{null!=a.socketClientId&&a.socketClientId===t.getSocketClientId()||(l.debug({obj:a},"websocket on 'page:delete'"),a.page.path===e.state.path&&e.setLatestRemotePageData(a.page,a.user))}),a.on("page:editingWithHackmd",a=>{null!=a.socketClientId&&a.socketClientId===t.getSocketClientId()||(l.debug({obj:a},"websocket on 'page:editingWithHackmd'"),a.page.path===e.state.path&&e.setState({isHackmdDraftUpdatingInRealtime:!0}))})}}}).call(this,a("jquery"))},"./src/client/js/services/TagContainer.js":function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var s=a("./node_modules/unstated/lib/unstated.es.js"),n=a("./src/lib/service/logger/index.js");const i=a.n(n)()("growi:services:TagContainer");class r extends s.a{constructor(e){super(),this.appContainer=e,this.appContainer.registerContainer(this),this.init()}static getClassName(){return"TagContainer"}async init(){const e=this.appContainer.getContainer("PageContainer"),t=this.appContainer.getContainer("EditorContainer");if(0===Object.keys(e.state).length)return void i.debug("There is no need to initialize TagContainer because this is not a Page");const{pageId:a,templateTagData:s}=e.state;let n=[];if(null!=a){n=(await this.appContainer.apiGet("/pages.getPageTag",{pageId:a})).tags}else null!=s&&(n=s.split(",").filter(e=>""!==e));i.debug("tags data has been initialized"),e.setState({tags:n}),t.setState({tags:n})}}},0:function(e,t){},1:function(e,t){},jquery:function(e,t){e.exports=jQuery}});